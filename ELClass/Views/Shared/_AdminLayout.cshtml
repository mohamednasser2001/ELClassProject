@using Microsoft.AspNetCore.Identity
@using Models
@using DataAccess.Repositories.IRepositories
@inject UserManager<ApplicationUser> UserManager
@inject IUnitOfWork _unitOfWork
@{
    var user      = await UserManager.GetUserAsync(User);
    var userImage = user?.Img;
    var displayName = user?.NameEN ?? user?.UserName;
    var isArabic  = System.Globalization.CultureInfo.CurrentCulture.TwoLetterISOLanguageName == "ar";
    var dir       = isArabic ? "rtl" : "ltr";
    var unreadCount = await _unitOfWork.ContactUsRepository.CountAsync(e => e.IsReaded == false);
}

<!doctype html>
<html lang="@(isArabic ? "ar" : "en")" dir="@dir" style="--el-role-color:#2563EB;--el-role-light:#EFF6FF;">
<head>
    <title>@(isArabic ? "لوحة تحكم ELClass" : "ELClass Dashboard")</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
    <link rel="icon" href="~/Images/Logos/logos-03.png" type="image/x-icon" />

    <!-- Cairo — Arabic + Latin font -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />

    <!-- Icon libraries -->
    <link rel="stylesheet" href="~/assets/fonts/phosphor/duotone/style.css" />
    <link rel="stylesheet" href="~/assets/fonts/tabler-icons.min.css" />
    <link rel="stylesheet" href="~/assets/fonts/feather.css" />
    <link rel="stylesheet" href="~/assets/fonts/material.css" />
    <link rel="stylesheet" href="~/lib/fontawesome/css/all.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Design system -->
    <link rel="stylesheet" href="~/css/color-tokens.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/bootstrap-overrides.css" asp-append-version="true" />

    <!-- Berry dashboard template -->
    <link rel="stylesheet" href="~/assets/css/style.css" id="main-style-link" />
    <link rel="stylesheet" href="~/assets/css/style-preset.css" />
    <link rel="stylesheet" href="~/assets/css/berry-color-overrides.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/assets/css/preset-color-overrides.css" asp-append-version="true" />

    <!-- ELClass layout override (must come after Berry) -->
    <link rel="stylesheet" href="~/css/elclass-layout.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/admin-components.css" asp-append-version="true" />

    <!-- Third-party UI -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>

<body>
    <!-- Page loader -->
    <div class="loader-bg">
        <div class="loader-track">
            <div class="loader-fill"></div>
        </div>
    </div>

    <!-- ─── Sidebar ─────────────────────────────────────── -->
    <nav class="pc-sidebar">
        <div class="navbar-wrapper">

            <!-- Logo -->
            <div class="m-header">
                <a href="/Admin/Home/Index" class="b-brand">
                    <img src="/images/logos/logos-02.png" alt="ELClass" width="140" class="logo" />
                </a>
            </div>

            <!-- Navigation -->
            <div class="navbar-content">
                <ul class="pc-navbar">

                    <li class="pc-item pc-caption">
                        <label>@(isArabic ? "الرئيسية" : "Main")</label>
                    </li>

                    <li class="pc-item">
                        <a href="/Admin/Home/Index" class="pc-link">
                            <span class="pc-micon"><i class="fa-jelly fa-regular fa-chart-bar"></i></span>
                            <span class="pc-mtext">@(isArabic ? "لوحة التحكم" : "Dashboard")</span>
                        </a>
                    </li>

                    <li class="pc-item pc-caption">
                        <label>@(isArabic ? "إدارة المحتوى" : "Management")</label>
                    </li>

                    <li class="pc-item">
                        <a href="/admin/Course/index" class="pc-link">
                            <span class="pc-micon"><i class="ti ti-book"></i></span>
                            <span class="pc-mtext">@(isArabic ? "الكورسات" : "Courses")</span>
                        </a>
                    </li>

                    <li class="pc-item">
                        <a href="/admin/instructor/index" class="pc-link">
                            <span class="pc-micon"><i class="fa-regular fa-user"></i></span>
                            <span class="pc-mtext">@(isArabic ? "المحاضرون" : "Instructors")</span>
                        </a>
                    </li>

                    <li class="pc-item">
                        <a href="/admin/Student/index" class="pc-link">
                            <span class="pc-micon"><i class="ti ti-users"></i></span>
                            <span class="pc-mtext">@(isArabic ? "الطلاب" : "Students")</span>
                        </a>
                    </li>

                    <li class="pc-item pc-hasmenu">
                        <a href="#!" class="pc-link">
                            <span class="pc-micon"><i class="ti ti-calendar-event"></i></span>
                            <span class="pc-mtext">@(isArabic ? "المواعيد" : "Appointments")</span>
                            <span class="pc-arrow"><i class="ti ti-chevron-right"></i></span>
                        </a>
                        <ul class="pc-submenu">
                            <li class="pc-item custom-menu-fix">
                                <a class="pc-link" href="/Admin/appointment/index">@(isArabic ? "كل المواعيد" : "All Appointments")</a>
                            </li>
                            <li class="pc-item custom-menu-fix">
                                <a class="pc-link" href="/Admin/appointment/AddNewAppointment">@(isArabic ? "إضافة موعد" : "Add Appointment")</a>
                            </li>
                        </ul>
                    </li>

                    @if (User.IsInRole("SuperAdmin"))
                    {
                        <li class="pc-item pc-caption">
                            <label>@(isArabic ? "الإدارة العليا" : "Super Admin")</label>
                        </li>
                        <li class="pc-item">
                            <a href="/admin/user/index" class="pc-link">
                                <span class="pc-micon"><i class="ti ti-shield-check"></i></span>
                                <span class="pc-mtext">@(isArabic ? "المستخدمون" : "Users")</span>
                            </a>
                        </li>
                    }

                    <li class="pc-item pc-caption">
                        <label>@(isArabic ? "التواصل" : "Communication")</label>
                    </li>

                    <li class="pc-item">
                        <a href="/Admin/ContactUs" class="pc-link">
                            <span class="pc-micon">
                                <i class="ti ti-mail"></i>
                                @if (unreadCount > 0)
                                {
                                    <span class="badge bg-danger ms-1 px-1" style="font-size:9px;border-radius:999px;">@unreadCount</span>
                                }
                            </span>
                            <span class="pc-mtext">@(isArabic ? "الرسائل" : "Messages")</span>
                        </a>
                    </li>

                </ul>
            </div>
        </div>
    </nav>

    <!-- ─── Header ──────────────────────────────────────── -->
    <header class="pc-header">
        <div class="header-wrapper">

            <!-- Mobile toggles -->
            <div class="me-auto pc-mob-drp">
                <ul class="list-unstyled">
                    <li class="pc-h-item header-mobile-collapse">
                        <a href="#" class="pc-head-link ms-0" id="sidebar-hide">
                            <i class="ti ti-menu-2"></i>
                        </a>
                    </li>
                    <li class="pc-h-item pc-sidebar-popup">
                        <a href="#" class="pc-head-link ms-0" id="mobile-collapse">
                            <i class="ti ti-menu-2"></i>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Right side actions -->
            <div class="ms-auto">
                <ul class="list-unstyled d-flex align-items-center gap-2 mb-0">

                    <!-- Language switch -->
                    <li class="pc-h-item">
                        <a href="/Home/SetLanguage?culture=@(isArabic ? "en-US" : "ar-EG")&returnUrl=@Context.Request.Path"
                           class="pc-head-link"
                           title="@(isArabic ? "Switch to English" : "التغيير للعربية")"
                           style="font-size:13px; font-weight:700; width:auto; padding:0 12px; border-radius:8px; border:1.5px solid var(--el-border); color:var(--el-text-muted);">
                            @(isArabic ? "EN" : "عربي")
                        </a>
                    </li>

                    <!-- Notifications -->
                    <li class="dropdown pc-h-item">
                        <a class="pc-head-link dropdown-toggle arrow-none position-relative"
                           data-bs-toggle="dropdown" href="#" role="button"
                           aria-expanded="false">
                            <i class="ti ti-bell"></i>
                            @if (unreadCount > 0)
                            {
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                      style="font-size:9px;padding:3px 5px;border:2px solid #fff;">
                                    @unreadCount
                                </span>
                            }
                        </a>

                        <div class="dropdown-menu dropdown-menu-end pc-h-dropdown p-0"
                             style="min-width:320px; border-radius:14px; overflow:hidden;">
                            <!-- Header -->
                            <div class="d-flex align-items-center justify-content-between p-3"
                                 style="background: linear-gradient(135deg, #2563EB, #1E3A8A); color:#fff;">
                                <h6 class="mb-0 fw-bold" style="font-size:14px;">
                                    @(isArabic ? "الإشعارات" : "Notifications")
                                </h6>
                                <span class="badge"
                                      style="background:rgba(255,255,255,0.2); color:#fff; font-size:11px; border-radius:20px; padding:4px 10px;">
                                    @unreadCount.ToString("00")
                                </span>
                            </div>

                            <!-- List -->
                            <div id="notification-list" style="max-height:260px; overflow-y:auto; background:#fff;">
                                @if (unreadCount == 0)
                                {
                                    <div id="no-notifications-msg" class="p-4 text-center">
                                        <i class="ti ti-bell-off d-block mb-2" style="font-size:28px; color:#CBD5E1;"></i>
                                        <p class="text-muted small mb-0">
                                            @(isArabic ? "لا توجد رسائل جديدة" : "No new messages")
                                        </p>
                                    </div>
                                }
                            </div>

                            <!-- Footer -->
                            <div class="p-2" style="border-top:1px solid #F1F5F9; background:#F8FAFC;">
                                <a href="/Admin/ContactUs"
                                   class="btn w-100 fw-bold"
                                   style="background:linear-gradient(135deg, #2563EB, #1D4ED8); color:#fff; border-radius:10px; font-size:13px; padding:8px;">
                                    @(isArabic ? "عرض كل الرسائل" : "View All Messages")
                                </a>
                            </div>
                        </div>
                    </li>

                    <!-- User profile -->
                    <li class="dropdown pc-h-item header-user-profile">
                        <a class="pc-head-link dropdown-toggle arrow-none me-0 d-flex align-items-center gap-2"
                           data-bs-toggle="dropdown" href="#" role="button" style="width:auto; padding:4px 8px;">
                            <img src="@(!string.IsNullOrEmpty(userImage) ? Url.Content("~/images/users/" + userImage) : $"https://ui-avatars.com/api/?name={Uri.EscapeDataString(displayName ?? "A")}&background=2563EB&color=ffffff&size=128")"
                                 alt="avatar"
                                 class="user-avtar"
                                 style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%; min-width:40px" />
                        </a>

                        <div class="dropdown-menu dropdown-menu-end pc-h-dropdown" style="min-width:220px;">
                            <div class="px-3 py-3" style="background:var(--el-body); border-radius:10px; margin-bottom:6px;">
                                <p class="fw-bold mb-0" style="font-size:14px; color:var(--el-text);">@displayName</p>
                                <p class="mb-0" style="font-size:12px; color:var(--el-text-muted);">
                                    @(isArabic ? "لوحة تحكم الأدمن" : "Admin Dashboard")
                                </p>
                            </div>
                            <a asp-area="Identity" asp-controller="MyProfile" asp-action="MyProfile" class="dropdown-item">
                                <i class="ti ti-settings"></i>
                                <span>@(isArabic ? "إعدادات الحساب" : "Account Settings")</span>
                            </a>
                            <div style="border-top:1px solid var(--el-border); margin:6px 0;"></div>
                            <a asp-action="Logout" asp-controller="Account" asp-area="Identity" class="dropdown-item" style="color:var(--el-danger)!important;">
                                <i class="ti ti-logout" style="color:var(--el-danger);"></i>
                                <span>@(isArabic ? "تسجيل الخروج" : "Logout")</span>
                            </a>
                        </div>
                    </li>

                </ul>
            </div>
        </div>
    </header>

    <!-- ─── Main Content ─────────────────────────────────── -->
    <div class="pc-container">
        <div class="pc-content">
            @RenderBody()
        </div>
    </div>

    <!-- ─── Scripts ─────────────────────────────────────── -->
    <script src="~/assets/js/plugins/popper.min.js"></script>
    <script src="~/assets/js/plugins/simplebar.min.js"></script>
    <script src="~/assets/js/plugins/bootstrap.min.js"></script>
    <script src="~/assets/js/script.js"></script>
    <script src="~/assets/js/theme.js"></script>
    <script src="~/assets/js/plugins/feather.min.js"></script>
    <script src="~/assets/js/plugins/apexcharts.min.js"></script>
    <script src="/lib/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>

    <!-- Berry init -->
    <script>
        layout_change('light');
        font_change('Roboto');
        change_box_container('false');
        layout_caption_change('true');
        layout_rtl_change('@(isArabic ? "true" : "false")');
        preset_change('preset-1');
    </script>

    <!-- Toast notifications -->
    <script>
        function showElToast(message, icon) {
            Swal.mixin({
                toast: true,
                position: '@(isArabic ? "top-start" : "top-end")',
                showConfirmButton: false,
                timer: 4000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            }).fire({ icon, title: message });
        }

        $(document).ready(function () {
            var s = '@TempData["Success"]', e = '@TempData["Error"]';
            if (s && s !== '') showElToast(s, 'success');
            if (e && e !== '') showElToast(e, 'error');
        });
    </script>

    <!-- SignalR notifications -->
    <script>
        var _signalRConn = new signalR.HubConnectionBuilder()
            .withUrl("/realTimeHub")
            .build();

        _signalRConn.on("ReceiveMessage", function (title, message) {
            var badgeOuter = document.getElementById("notification-badge-outer");
            var badgeInner = document.getElementById("notification-badge");
            var currentCount = parseInt((badgeOuter || {}).innerText) || 0;
            var newCount = currentCount + 1;

            if (badgeOuter) { badgeOuter.innerText = newCount; badgeOuter.classList.remove("d-none"); }
            if (badgeInner) { badgeInner.innerText = newCount < 10 ? "0" + newCount : newCount; }

            var noMsg = document.getElementById("no-notifications-msg");
            if (noMsg) noMsg.style.display = 'none';

            var list = document.getElementById("notification-list");
            if (list) {
                list.insertAdjacentHTML('afterbegin', `
                    <a href="/Admin/ContactUs" class="dropdown-item border-bottom py-3">
                        <div class="d-flex align-items-center gap-2">
                            <div style="width:34px;height:34px;border-radius:10px;background:var(--el-primary-light);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                                <i class="ti ti-mail" style="color:var(--el-primary);font-size:16px;"></i>
                            </div>
                            <div>
                                <p class="mb-0 fw-bold" style="font-size:13px;">${title}</p>
                                <small class="text-muted">@(isArabic ? "الآن" : "Just now")</small>
                            </div>
                        </div>
                    </a>`);
            }

            try { new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3').play(); } catch(e) {}
            showElToast(title, 'info');
        });

        _signalRConn.start().catch(err => console.error(err));
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
