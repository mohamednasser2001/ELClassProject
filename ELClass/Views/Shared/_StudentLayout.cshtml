@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Models
@using DataAccess.Repositories.IRepositories

@inject UserManager<ApplicationUser> UserManager
@inject IUnitOfWork UnitOfWork
@inject UserManager<ApplicationUser> UserManager

@{
    var user = await UserManager.GetUserAsync(User);

    var fullName =
        user?.NameEN
        ?? user?.NameAR
        ?? "Student";

    var initials = new string(
        fullName
            .Split(' ', StringSplitOptions.RemoveEmptyEntries)
            .Take(2)
            .Select(x => char.ToUpper(x[0]))
            .ToArray()
    );

    var profileImage = !string.IsNullOrWhiteSpace(user?.Img)
        ? Url.Content("~/Images/Users/" + user.Img)
        : null;
}

@{
    Layout = null;
    var title = ViewData["Title"] ?? "Student";

    // =========================
    // Language (Session-based)
    // =========================
    var currentLang = Context.Session.GetString("Language") ?? "en";
    var isArabic = currentLang == "ar";
    var htmlLang = isArabic ? "ar" : "en";

    // ===== Flag icon paths (change if needed) =====
    var flagSA = Url.Content("~/images/flags/sa.png");
    var flagGB = Url.Content("~/images/flags/gb.png");

    // =========================
    // Notifications (Server-side)
    // =========================
    var userId = UserManager.GetUserId(User);
    var now = DateTime.Now;

    DateTime? GetStartDateTime(Appointment appt)
    {
        if (appt.Type == ScheduleType.OneTime)
        {
            if (!appt.SpecificDate.HasValue) return null;
            return appt.SpecificDate.Value.Date + appt.StartTime;
        }

        var daysAhead = ((int)appt.Day - (int)now.DayOfWeek + 7) % 7;
        var candidate = now.Date.AddDays(daysAhead) + appt.StartTime;

        if (daysAhead == 0 && candidate <= now)
            candidate = candidate.AddDays(7);

        return candidate;
    }

    var notifyCount = 0;
    var notifyItems = new List<(DateTime start, string course, string instructor, int studentAppointmentId)>();

    if (!string.IsNullOrWhiteSpace(userId))
    {
        var sas = await UnitOfWork.StudentAppointmentRepository.GetAsync(
            sa => sa.StudentId == userId && sa.Appointment != null && !sa.IsAttended,
            q => q.Include(sa => sa.Appointment)
                  .ThenInclude(a => a.Course)
                  .Include(sa => sa.Appointment)
                  .ThenInclude(a => a.Instructor)
                  .ThenInclude(i => i.ApplicationUser)
        );

        var computed = sas
            .Select(sa =>
            {
                var appt = sa.Appointment!;
                var start = GetStartDateTime(appt);
                DateTime? end = null;

                if (start.HasValue)
                    end = start.Value.AddHours(appt.DurationInHours);

                var courseTitle =
                    appt.Course != null
                        ? (!string.IsNullOrWhiteSpace(appt.Course.TitleEn) ? appt.Course.TitleEn : appt.Course.TitleAr)
                        : (isArabic ? "محاضرة" : "Lecture");

                var instructorName =
                    appt.Instructor != null
                        ? (!string.IsNullOrWhiteSpace(appt.Instructor.NameEn) ? appt.Instructor.NameEn : appt.Instructor.NameAr)
                        : (isArabic ? "المُدرس" : "Instructor");

                return new { saId = sa.Id, start, end, courseTitle, instructorName };
            })
            .Where(x => x.start.HasValue && x.end.HasValue)
            .Where(x => x.end!.Value > now)
            .Where(x => x.start!.Value >= now && x.start!.Value <= now.AddMinutes(30))
            .OrderBy(x => x.start)
            .ToList();
    
        notifyCount = computed.Count;

        notifyItems = computed
            .Take(3)
            .Select(x => (x.start!.Value, x.courseTitle, x.instructorName, x.saId))
            .ToList();
    }
}

<!DOCTYPE html>
<html html lang="@htmlLang" dir="@(isArabic ? "rtl" : "ltr")">
<head>
    <meta charset="utf-8" />
    <title>@title - ELClass</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />

    <!-- Core Overrides -->
    <link href="~/css/bootstrap-overrides.css" rel="stylesheet" />
    <link href="~/css/color-tokens.css" rel="stylesheet" />

    <!-- Student Dashboard CSS -->
    <link rel="stylesheet" href="~/css/DashboardStudent.css" asp-append-version="true" />

    @RenderSection("Styles", required: false)

    <style>
        /* 3 columns layout */
        .student-nav-wrap {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        /* Brand on LEFT even with RTL */
        .student-brand-left {
            margin-left: auto;
        }

        /* Center menu */
        .student-center {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        /* Actions on RIGHT */
        .student-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Flag button as image */
        .lang-flag-btn {
            width: 40px;
            height: 34px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,.14);
            background: rgba(255,255,255,.06);
            transition: .15s ease;
            padding: 0;
            overflow: hidden;
        }

            .lang-flag-btn:hover {
                background: rgba(255,255,255,.12);
                transform: translateY(-1px);
            }

        .lang-flag-img {
            width: 26px;
            height: 18px;
            object-fit: cover;
            border-radius: 4px;
            display: block;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-3 px-lg-4 student-navbar">
        <div class="container-fluid student-nav-wrap">

            <a class="navbar-brand fw-bold d-flex align-items-center gap-2 student-brand order-1"
               asp-area="StudentArea" asp-controller="Home" asp-action="Index">
                <img src="~/Images/Logos/logos-02.png" alt="ELClass" height="30" />
            </a>

            <button class="navbar-toggler student-toggler order-2" type="button"
                    data-bs-toggle="collapse" data-bs-target="#studentNav"
                    aria-controls="studentNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse student-center order-last order-lg-2 justify-content-center" id="studentNav">
                <ul class="navbar-nav gap-lg-4">
                    <li class="nav-item">
                        <a class="nav-link text-center" asp-area="StudentArea" asp-controller="Home" asp-action="Index">
                            <i class="fa-solid fa-house me-1"></i> @(isArabic ? "الرئيسية" : "Home")
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" asp-area="StudentArea" asp-controller="Course" asp-action="Index">
                            <i class="fa-solid fa-book me-1"></i> @(isArabic ? "الكورسات" : "Courses")
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" asp-area="StudentArea" asp-controller="Lectures" asp-action="Schedule">
                            <i class="fa-solid fa-video me-1"></i> @(isArabic ? "المحاضرات" : "Lectures")
                        </a>
                    </li>
                </ul>
            </div>

            <div class="student-actions d-flex align-items-center gap-2 gap-md-3 order-3">

                @await Component.InvokeAsync("StudentNotifications", new { isArabic = isArabic })

                <div class="dropdown position-relative">
                    <div class="user-capsule shadow-sm" data-bs-toggle="dropdown" data-bs-display="static" role="button" aria-expanded="false">
                        <i class="fa-solid fa-gear capsule-gear"></i>
                        <div class="capsule-avatar">
                            @if (!string.IsNullOrEmpty(profileImage))
                            {<img src="@profileImage" alt="Profile" /> }
                            else
                            { <span>@initials</span>}
                        </div>
                    </div>

                    <ul class="dropdown-menu dropdown-menu-end shadow student-account-menu border-0">
                        <li class="px-3 py-2 text-end">
                            <div class="fw-bold">@User.Identity?.Name @(isArabic ? "،مرحباً" : ", Welcome")</div>
                            <div class="text-muted small">@(isArabic ? "لوحة تحكم الطالب" : "Student Dashboard")</div>
                        </li>

                        <li><hr class="dropdown-divider"></li>

                        <li>
                            <a class="dropdown-item text-end d-flex align-items-center justify-content-end gap-2"
                               asp-area="Identity" asp-controller="MyProfile" asp-action="MyProfile">
                                <span>@(isArabic ? "إعدادات الحساب" : "Account Settings")</span> <i class="fa-solid fa-gear"></i>
                            </a>
                        </li>

                        <!-- ✅ Language Switch -->
                        <li>
                            <form asp-area="StudentArea" asp-controller="Home" asp-action="ChangeLanguage" method="post" class="m-0">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="lang" value="@(isArabic ? "en" : "ar")" />

                                <button type="submit"
                                        class="dropdown-item text-end d-flex align-items-center justify-content-end gap-2 student-lang-item border-0 bg-transparent w-100">
                                    <span>@(isArabic ? "English" : "العربية")</span>
                                    <i class="fa-solid fa-language"></i>
                                </button>
                            </form>
                        </li>

                        <li><hr class="dropdown-divider"></li>

                        <li>
                            <form asp-area="Identity" asp-controller="Account" asp-action="Logout" method="post" class="m-0">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="dropdown-item text-end d-flex align-items-center justify-content-end gap-2 text-danger border-0 bg-transparent w-100">
                                    <span>@(isArabic ? "تسجيل الخروج" : "Logout")</span> <i class="fa-solid fa-right-from-bracket"></i>
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>

            </div>
        </div>
    </nav>




    <main>
        @RenderBody()
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    @RenderSection("Scripts", required: false)

</body>
</html>
