@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Models
@using DataAccess.Repositories.IRepositories

@inject UserManager<ApplicationUser> UserManager
@inject IUnitOfWork UnitOfWork
@inject UserManager<ApplicationUser> UserManager

@{
    var user = await UserManager.GetUserAsync(User);

    var fullName =
        user?.NameEN
        ?? user?.NameAR
        ?? "Student";

    var initials = new string(
        fullName
            .Split(' ', StringSplitOptions.RemoveEmptyEntries)
            .Take(2)
            .Select(x => char.ToUpper(x[0]))
            .ToArray()
    );

    var profileImage = !string.IsNullOrWhiteSpace(user?.Img)
        ? Url.Content("~/Images/Users/" + user.Img)
        : null;
}



@{
    Layout = null;
    var title = ViewData["Title"] ?? "Student";

    // =========================
    // Notifications (Server-side)
    // - Count lectures starting soon (next 30 min)
    // - Show top 3 items
    // =========================
    var userId = UserManager.GetUserId(User);
    var now = DateTime.Now;

    DateTime? GetStartDateTime(Appointment appt)
    {
        // OneTime: SpecificDate + StartTime
        if (appt.Type == ScheduleType.OneTime)
        {
            if (!appt.SpecificDate.HasValue) return null;
            return appt.SpecificDate.Value.Date + appt.StartTime;
        }

        // Recurring: next occurrence of Day + StartTime
        var daysAhead = ((int)appt.Day - (int)now.DayOfWeek + 7) % 7;
        var candidate = now.Date.AddDays(daysAhead) + appt.StartTime;

        if (daysAhead == 0 && candidate <= now)
            candidate = candidate.AddDays(7);

        return candidate;
    }

    // default
    var notifyCount = 0;
    var notifyItems = new List<(DateTime start, string course, string instructor, int studentAppointmentId)>();

    if (!string.IsNullOrWhiteSpace(userId))
    {
        var sas = await UnitOfWork.StudentAppointmentRepository.GetAsync(
            sa => sa.StudentId == userId && sa.Appointment != null && !sa.IsAttended,
            q => q.Include(sa => sa.Appointment)
                  .ThenInclude(a => a.Course)
                  .Include(sa => sa.Appointment)
                  .ThenInclude(a => a.Instructor)
                  .ThenInclude(i => i.ApplicationUser)
        );

        var computed = sas
            .Select(sa =>
            {
                var appt = sa.Appointment!;
                var start = GetStartDateTime(appt);
                DateTime? end = null;

                if (start.HasValue)
                    end = start.Value.AddHours(appt.DurationInHours);

                var courseTitle =
                    appt.Course != null
                        ? (!string.IsNullOrWhiteSpace(appt.Course.TitleEn) ? appt.Course.TitleEn : appt.Course.TitleAr)
                        : "Lecture";

                var instructorName =
                    appt.Instructor != null
                        ? (!string.IsNullOrWhiteSpace(appt.Instructor.NameEn) ? appt.Instructor.NameEn : appt.Instructor.NameAr)
                        : "Instructor";

                return new { saId = sa.Id, start, end, courseTitle, instructorName };
            })
            .Where(x => x.start.HasValue && x.end.HasValue)
            // upcoming (not ended)
            .Where(x => x.end!.Value > now)
            // starting soon: in the next 30 minutes
            .Where(x => x.start!.Value >= now && x.start!.Value <= now.AddMinutes(30))
            .OrderBy(x => x.start)
            .ToList();

        notifyCount = computed.Count;

        notifyItems = computed
            .Take(3)
            .Select(x => (x.start!.Value, x.courseTitle, x.instructorName, x.saId))
            .ToList();
    }
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>@title - ELClass</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />

    <!-- Core Overrides -->
    <link href="~/css/bootstrap-overrides.css" rel="stylesheet" />
    <link href="~/css/color-tokens.css" rel="stylesheet" />

    <!-- Student Dashboard CSS -->
    <link rel="stylesheet" href="~/css/DashboardStudent.css" asp-append-version="true" />

    @RenderSection("Styles", required: false)
</head>
<body>

    <!-- ===============================
         TOP NAVBAR
    ================================ -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4 student-navbar">
        <div class="container-fluid">

            <!-- Brand (LEFT) -->
            <a class="navbar-brand fw-bold d-flex align-items-center gap-2 student-brand"
               asp-area="StudentArea" asp-controller="Home" asp-action="Index">
                <img src="~/Images/Logos/logos-01.png" alt="ELClass" height="30" />
                <span>ELClass</span>
            </a>

            <!-- Toggle -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#studentNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Menu -->
            <div class="collapse navbar-collapse" id="studentNav">

                <!-- CENTER -->
                <div class="student-nav-center">
                    <ul class="navbar-nav gap-lg-4">
                        <li class="nav-item">
                            <a class="nav-link"
                               asp-area="StudentArea" asp-controller="Home" asp-action="Index">
                                <i class="fa-solid fa-house me-1"></i> Home
                            </a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link"
                               asp-area="StudentArea" asp-controller="Course" asp-action="Index">
                                <i class="fa-solid fa-book me-1"></i> Courses
                            </a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link"
                               asp-area="StudentArea" asp-controller="Lectures" asp-action="Schedule">
                                <i class="fa-solid fa-video me-1"></i> Lectures
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- RIGHT -->
                <ul class="navbar-nav ms-lg-auto align-items-center gap-3 student-nav-right">

                    <!-- Notifications -->
                    <li class="nav-item dropdown position-relative">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fa-regular fa-bell"></i>

                            @if (notifyCount > 0)
                            {
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                    @notifyCount
                                </span>
                            }
                        </a>

                        <ul class="dropdown-menu dropdown-menu-end shadow-sm student-notify-menu">
                            <li class="dropdown-header">Upcoming soon</li>

                            @if (notifyItems.Any())
                            {
                                foreach (var n in notifyItems)
                                {
                                    <li>
                                        <a class="dropdown-item small"
                                           asp-area="StudentArea"
                                           asp-controller="Lectures"
                                           asp-action="Schedule">
                                            <div class="fw-bold">@n.course</div>
                                            <div class="text-muted">
                                                @n.instructor • @n.start.ToString("ddd, dd MMM • hh:mm tt")
                                            </div>
                                        </a>
                                    </li>
                                }
                            }
                            else
                            {
                                <li>
                                    <span class="dropdown-item-text text-muted small">
                                        No lectures starting soon.
                                    </span>
                                </li>
                            }

                            <li><hr class="dropdown-divider" /></li>

                            <li>
                                <a class="dropdown-item"
                                   asp-area="StudentArea" asp-controller="Lectures" asp-action="Schedule">
                                    <i class="fa-solid fa-calendar-check me-2"></i> View schedule
                                </a>
                            </li>
                        </ul>
                    </li>

                    <!-- Account -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center gap-2"
                           href="#"
                           role="button"
                           data-bs-toggle="dropdown">

                            <span class="student-avatar">
                                @if (!string.IsNullOrEmpty(profileImage))
                                {
                                    <img src="@profileImage"
                                         alt="Profile"
                                         class="student-avatar-img"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />

                                    <span class="student-avatar-text" style="display:none;">
                                        @initials
                                    </span>
                                }
                                else
                                {
                                    <span class="student-avatar-text">
                                        @initials
                                    </span>
                                }
                            </span>



                            <span class="d-none d-lg-inline">Account</span>
                        </a>

                        <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                            <li>
                                <a class="dropdown-item"
                                   asp-area="Identity" asp-controller="MyProfile" asp-action="MyProfile">
                                    <i class="fa-regular fa-user me-2"></i> My Profile
                                </a>
                            </li>



                            <li><hr class="dropdown-divider" /></li>

                            <li>
                                <form asp-area="Identity" asp-controller="Account" asp-action="Logout" method="post" class="m-0">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="fa-solid fa-right-from-bracket me-2"></i> Logout
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </li>

                </ul>
            </div>
        </div>
    </nav>

    <!-- ===============================
         PAGE CONTENT
    ================================ -->
    <main>
        @RenderBody()
    </main>

    <!-- ===============================
         SCRIPTS
    ================================ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    @RenderSection("Scripts", required: false)
</body>
</html>
