@using Models
@model Models.ViewModels.Instructor.InstructorIndexDashboardVM
@inject Microsoft.AspNetCore.Identity.UserManager<ApplicationUser> _userManager
@{
    ViewData["Title"] = "Instructor Dashboard";
    Layout = "_InstrcutorLayout";

    var currentLang = System.Threading.Thread.CurrentThread.CurrentCulture.Name.StartsWith("ar") ? "ar" : "en";
    var isAr = currentLang == "ar";
}

<!-- â”€â”€â”€ Welcome Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="el-welcome-card mb-4" style="direction:@(isAr ? "rtl" : "ltr")">
    <div style="position:relative;z-index:1">
        <h2 class="wc-title">
            @(isAr ? "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±" : "Welcome to Your Instructor Dashboard")
        </h2>
        <p class="wc-desc">
            @(isAr
                ? "ØªØ§Ø¨Ø¹ Ø·Ù„Ø§Ø¨Ùƒ ÙˆÙƒÙˆØ±Ø³Ø§ØªÙƒ Ø¨ÙƒÙ„ Ø³Ù‡ÙˆÙ„Ø©. Ø¯Ø±Ù‘Ø³ØŒ Ù†Ø¸Ù‘Ù…ØŒ ÙˆØ§Ø¨Ù†Ù Ù…Ø¬ØªÙ…Ø¹Ø§Ù‹ ØªØ¹Ù„ÙŠÙ…ÙŠØ§Ù‹ Ù…ØªÙ…ÙŠØ²Ø§Ù‹."
                : "Track your students and courses with ease. Teach, organize, and build an outstanding learning community.")
        </p>
    </div>
    <i class="fa-regular fa-user wc-icon"></i>
</div>

<!-- â”€â”€â”€ Stat Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="row g-4 mb-4" style="direction:@(isAr ? "rtl" : "ltr")">

    <div class="col-xl-3 col-md-6">
        <div class="el-stat-card el-stat-violet">
            <div class="stat-icon"><i class="ti ti-users"></i></div>
            <div class="stat-number">@Model.TotalStudents.ToString("N0")</div>
            <div class="stat-label">@(isAr ? "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø·Ù„Ø§Ø¨ÙŠ" : "My Students")</div>
            <div class="stat-trend up">
                <i class="ti ti-trending-up"></i>
                @(isAr ? "Ø¨ÙŠØ§Ù†Ø§Øª Ø­ÙŠØ©" : "Real-time data")
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="el-stat-card el-stat-blue">
            <div class="stat-icon"><i class="ti ti-book"></i></div>
            <div class="stat-number">@Model.ActiveLessons.ToString("N0")</div>
            <div class="stat-label">@(isAr ? "Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù†Ø´Ø·Ø©" : "Active Lessons")</div>
            <div class="stat-trend neutral">
                <i class="ti ti-circle-check"></i>
                @(isAr ? "Ø¹Ø¨Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª" : "Across all courses")
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="el-stat-card el-stat-green">
            <div class="stat-icon"><i class="ti ti-books"></i></div>
            <div class="stat-number">@Model.TotalCourses.ToString("N0")</div>
            <div class="stat-label">@(isAr ? "ÙƒÙˆØ±Ø³Ø§ØªÙŠ" : "My Courses")</div>
            <div class="stat-trend neutral">
                <i class="ti ti-school"></i>
                @(isAr ? "Ù…ÙØ³Ù†Ø¯Ø© Ø¥Ù„ÙŠÙƒ" : "Assigned to you")
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="el-stat-card el-stat-amber">
            <div class="stat-icon"><i class="fa-regular fa-user"></i></div>
            <div class="stat-number">@Model.TotalInstructors.ToString("N0")</div>
            <div class="stat-label">@(isAr ? "Ù…Ø¯Ø±Ø³Ùˆ Ø§Ù„Ù…Ù†ØµØ©" : "Platform Instructors")</div>
            <div class="stat-trend neutral">
                <i class="ti ti-users"></i>
                @(isAr ? "Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ" : "Teaching community")
            </div>
        </div>
    </div>

</div>

<!-- â”€â”€â”€ Quick Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="card mb-4" style="direction:@(isAr ? "rtl" : "ltr")">
    <div class="card-body">
        <div class="el-card-header">
            <div class="ch-icon" style="background:var(--el-instructor-light);color:var(--el-instructor)">
                <i class="ti ti-bolt"></i>
            </div>
            <span class="ch-title">@(isAr ? "Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©" : "Quick Actions")</span>
        </div>
        <div class="row g-3">
            <div class="col-xl-3 col-md-6">
                <a href="/Instructor/Student" class="el-quick-action">
                    <div class="qa-icon qa-violet"><i class="ti ti-users"></i></div>
                    <div class="qa-label">@(isAr ? "Ø·Ù„Ø§Ø¨ÙŠ" : "My Students")</div>
                    <div class="qa-sublabel">@(isAr ? "Ø¹Ø±Ø¶ ÙˆØªØ¹Ø¯ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨" : "View and edit student profiles")</div>
                </a>
            </div>
            <div class="col-xl-3 col-md-6">
                <a href="/Instructor/Course" class="el-quick-action">
                    <div class="qa-icon qa-blue"><i class="ti ti-book"></i></div>
                    <div class="qa-label">@(isAr ? "Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª" : "Courses")</div>
                    <div class="qa-sublabel">@(isAr ? "Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ø­ØªÙˆÙ‰" : "Create and organize content")</div>
                </a>
            </div>
            <div class="col-xl-3 col-md-6">
                <a href="/Instructor/appointment/create" class="el-quick-action">
                    <div class="qa-icon qa-green"><i class="ti ti-calendar-plus"></i></div>
                    <div class="qa-label">@(isAr ? "Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯" : "Add Appointment")</div>
                    <div class="qa-sublabel">@(isAr ? "Ø¬Ø¯ÙˆÙ„Ø© Ù…Ø­Ø§Ø¶Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©" : "Schedule a new lecture")</div>
                </a>
            </div>
            <div class="col-xl-3 col-md-6">
                <a href="/Instructor/appointment/index" class="el-quick-action">
                    <div class="qa-icon qa-amber"><i class="ti ti-calendar-event"></i></div>
                    <div class="qa-label">@(isAr ? "ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯" : "All Appointments")</div>
                    <div class="qa-sublabel">@(isAr ? "Ø¥Ø¯Ø§Ø±Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª" : "Manage lecture schedule")</div>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- â”€â”€â”€ Activity + Courses Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="row g-4 mb-4" style="direction:@(isAr ? "rtl" : "ltr")">

    <div class="col-xl-8">
        <div class="card h-100">
            <div class="card-body">
                <div class="el-card-header">
                    <div class="ch-icon" style="background:var(--el-instructor-light);color:var(--el-instructor)">
                        <i class="ti ti-activity"></i>
                    </div>
                    <span class="ch-title">@(isAr ? "Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¦Ùƒ" : "Your Performance Overview")</span>
                </div>

                <div class="mb-3">
                    <small style="color:var(--el-text-muted)">@(isAr ? "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ù„ØªØ­Ù‚ÙŠÙ†" : "Total enrolled students")</small>
                    <h4 class="mb-0 mt-1" style="color:var(--el-instructor);font-weight:800">
                        @Model.TotalStudents @(isAr ? "Ø·Ø§Ù„Ø¨" : "Students")
                    </h4>
                </div>

                <div style="background:var(--el-instructor-light);border-inline-start:3px solid var(--el-instructor);padding:14px 16px;border-radius:var(--el-radius-sm);margin-bottom:16px;">
                    <div class="d-flex align-items-center gap-3">
                        <i class="ti ti-chart-line" style="font-size:24px;color:var(--el-instructor)"></i>
                        <div>
                            <div style="font-weight:700;color:var(--el-instructor);font-size:14px">@(isAr ? "Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø­ÙŠØ©" : "Live Statistics")</div>
                            <p class="mb-0" style="font-size:13px;color:var(--el-text-muted)">
                                @(isAr
                                    ? $"Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¹ÙƒØ³ Ù…Ø¯Ù‰ Ø§Ù†ØªØ´Ø§Ø±Ùƒ Ø¹Ù„Ù‰ Ù…Ù†ØµØ© ELClass Ø¹Ø¨Ø± {Model.TotalCourses} ÙƒÙˆØ±Ø³."
                                    : $"This data represents your current reach on the ELClass platform across {Model.TotalCourses} courses.")
                            </p>
                        </div>
                    </div>
                </div>

                <div style="background:var(--el-body);border-radius:var(--el-radius);min-height:140px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;">
                    <i class="ti ti-chart-bar" style="font-size:2.5rem;opacity:0.2;color:var(--el-instructor)"></i>
                    <p style="color:var(--el-text-muted);font-size:13px;margin:0">
                        @(isAr ? "Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ù†Ø´Ø§Ø· Ù‡Ù†Ø§" : "Activity chart visualization will appear here")
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="el-card-header">
                    <div class="ch-icon" style="background:var(--el-success-light);color:var(--el-success)">
                        <i class="ti ti-trending-up"></i>
                    </div>
                    <span class="ch-title">@(isAr ? "Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª" : "Your Courses Status")</span>
                </div>

                @if (Model.TopPerformingCourses != null && Model.TopPerformingCourses.Any())
                {
                    <div style="display:flex;flex-direction:column;gap:10px;">
                    @foreach (var course in Model.TopPerformingCourses)
                    {
                        <div style="border:1px solid var(--el-border);border-radius:var(--el-radius-sm);padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;">
                            <div style="min-width:0">
                                <div style="font-weight:700;font-size:14px;color:var(--el-text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
                                    <i class="ti ti-book me-1" style="color:var(--el-instructor)"></i>@course.CourseName
                                </div>
                                <div style="font-size:12px;color:var(--el-text-muted);margin-top:2px">
                                    @course.EnrolledStudents @(isAr ? "Ø·Ø§Ù„Ø¨ Ù…Ù„ØªØ­Ù‚" : "enrolled students")
                                </div>
                            </div>
                            <span style="background:var(--el-success-light);color:var(--el-success-dark);font-size:11px;font-weight:700;padding:3px 10px;border-radius:999px;white-space:nowrap">
                                @(isAr ? "Ù†Ø´Ø·" : "Active")
                            </span>
                        </div>
                    }
                    </div>
                }
                else
                {
                    <div style="text-align:center;color:var(--el-text-muted);padding:24px 0;font-size:13px">
                        <i class="ti ti-books" style="font-size:2rem;opacity:0.3;display:block;margin-bottom:8px"></i>
                        @(isAr ? "Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆØ±Ø³Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†." : "No courses found yet.")
                    </div>
                }

                <div class="text-center mt-3">
                    <a href="/Instructor/Course" style="color:var(--el-instructor);font-weight:700;text-decoration:none;font-size:13px">
                        @(isAr ? "Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ ÙƒÙˆØ±Ø³Ø§ØªÙŠ" : "View all your courses")
                        <i class="ti ti-arrow-@(isAr ? "left" : "right") ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- â”€â”€â”€ Tip Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div style="background:linear-gradient(to @(isAr ? "left" : "right"),var(--el-instructor-light),var(--el-card));border-inline-start:4px solid var(--el-instructor);border-radius:var(--el-radius);padding:20px 22px;display:flex;align-items:center;gap:16px;direction:@(isAr ? "rtl" : "ltr")">
    <div style="width:46px;height:46px;border-radius:12px;background:var(--el-instructor);display:flex;align-items:center;justify-content:center;flex-shrink:0">
        <i class="ti ti-bulb" style="color:#fff;font-size:20px"></i>
    </div>
    <div>
        <div style="font-weight:700;color:#5B21B6;margin-bottom:4px;font-size:14px">@(isAr ? "Ù†ØµÙŠØ­Ø© Ù„Ù„Ù…Ø­Ø§Ø¶Ø±" : "Instructor Tip")</div>
        <p style="margin:0;color:var(--el-text-muted);font-size:13px">
            @(isAr
                ? "Ù‚Ø¯Ù… Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¯ÙˆØ±ÙŠØ© Ù„Ø·Ù„Ø§Ø¨Ùƒ. Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª ØªØ¸Ù‡Ø± Ø£Ù† Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ ØªØ­Ø³Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ¹Ù„Ù… Ø¨Ù†Ø³Ø¨Ø© ØªØµÙ„ Ø¥Ù„Ù‰ 40%!"
                : "Provide regular feedback to your students. Studies show that timely feedback improves learning outcomes by up to 40%!")
        </p>
    </div>
</div>


@* â”€â”€â”€ Instructor Chat Widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@

<button id="chatFab" class="chat-fab" type="button" aria-label="Open chat">
    <span class="chat-fab-icon" aria-hidden="true">
        <i class="fa-regular fa-comment-dots"></i>
    </span>
    <span id="chatFabBadge" class="chat-fab-badge hidden">0</span>
</button>

<div id="chatWidget" class="chat-widget" aria-hidden="true" role="dialog" aria-label="Chat widget">
    @Html.AntiForgeryToken()
    <div class="chat-header">
        <div class="header-left">
            <button id="chatBackBtn" class="chat-btn-icon hidden" type="button" aria-label="Back">â†</button>
            <div class="header-titles">
                <div class="title" id="chatHeaderTitle">Chats</div>
                <div class="subtitle hidden" id="chatHeaderSubTitle"></div>
            </div>
        </div>
        <div class="actions">
            <button class="chat-btn-icon" id="chatCloseBtn" type="button" aria-label="Close">âœ•</button>
        </div>
    </div>

    <div class="chat-screen" id="screenList">
        <div class="chat-search">
            <input id="chatSearch" type="text" placeholder="Search students..." autocomplete="off" />
        </div>
        <div class="chat-items" id="chatItems" role="list"></div>
    </div>

    <div class="chat-screen hidden" id="screenThread">
        <div class="messages" id="messagesBox" role="log" aria-live="polite"></div>
        <div class="composer">
            <div id="attachChip" class="attach-chip hidden">
                <span id="attachName"></span>
                <button type="button" id="attachClearBtn" class="attach-clear" aria-label="Remove file">Ã—</button>
            </div>
            <input id="chatInput" type="text" placeholder="Type a message..." autocomplete="off" />
            <input type="file" id="chatFile" hidden />
            <button type="button" id="attachBtn" class="chat-attach-btn" title="Attach file">
                <i class="fa-solid fa-paperclip"></i>
            </button>
            <button id="sendBtn" type="button" aria-label="Send">â¤</button>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

    <script>
    // =========================
    // URLs (Instructor area)
    // =========================
    const API = {
        conversations: '@Url.Action("GetInstructorConversations","Home", new { area="Instructor" })',
        history: '@Url.Action("GetChatHistory","Home", new { area="Instructor" })',
        save: '@Url.Action("SaveMessage","Home", new { area="Instructor" })',
        saveWithFile: '@Url.Action("SendMessageWithFile","Home", new { area="Instructor" })',
        download: '@Url.Action("DownloadAttachment","Home", new { area="Instructor" })',
        markRead: '@Url.Action("MarkAsRead","Home", new { area="Instructor" })'
    };

    // =========================
    // Elements
    // =========================
    const chatFab = document.getElementById('chatFab');
    const chatFabBadge = document.getElementById('chatFabBadge');
    const chatWidget = document.getElementById('chatWidget');
    const chatCloseBtn = document.getElementById('chatCloseBtn');
    const chatBackBtn = document.getElementById('chatBackBtn');
    const chatHeaderTitle = document.getElementById('chatHeaderTitle');

    const chatHeaderSubTitle = document.getElementById('chatHeaderSubTitle');

    const screenList = document.getElementById('screenList');
    const screenThread = document.getElementById('screenThread');

    const chatSearch = document.getElementById('chatSearch');
    const chatItemsBox = document.getElementById('chatItems');

    const messagesBox = document.getElementById('messagesBox');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');

    // âœ… Attachment elements
    const attachBtn = document.getElementById("attachBtn");
    const chatFile = document.getElementById("chatFile");
    const attachChip = document.getElementById("attachChip");
    const attachName = document.getElementById("attachName");
    const attachClearBtn = document.getElementById("attachClearBtn");

    // =========================
    // âœ… Anti-forgery
    // =========================
    function getAntiForgeryToken() {
        const el = chatWidget?.querySelector('input[name="__RequestVerificationToken"]')
            || document.querySelector('input[name="__RequestVerificationToken"]');
        return el?.value || '';
    }

    function addCsrfHeader(headersObj) {
        const token = getAntiForgeryToken();
        if (token) headersObj['RequestVerificationToken'] = token;
        return headersObj;
    }

    // =========================
    // State
    // =========================
    const state = {
        isOpen: false,
        currentStudentId: null,
        currentStudentName: '',
        conversationId: null,
        hasMore: false,
        oldestMessageId: null,
        conversationsCache: [],
        isLoadingOlder: false,
        take: 20
    };

    // =========================
    // Helpers
    // =========================
    function escapeHtml(str) {
        return (str ?? '')
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", "&#039;");
    }

    function toTime(sentAt) {
        if (!sentAt) return '';
        const d = new Date(sentAt);
        if (Number.isNaN(d.getTime())) return '';
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function initials(name) {
        const s = (name ?? '').trim();
        if (!s) return 'ST';
        const parts = s.split(/\s+/).filter(Boolean);
        const first = parts[0]?.[0] ?? 'S';
        const second = (parts.length > 1 ? parts[1]?.[0] : parts[0]?.[1]) ?? 'T';
        return (first + second).toUpperCase();
    }

    function findItem(studentId) {
        return document.querySelector(`.chat-item[data-student-id="${CSS.escape(studentId)}"]`);
    }

    function setActive(studentId) {
        document.querySelectorAll('.chat-item').forEach(x => {
            x.classList.toggle('active', x.dataset.studentId === studentId);
        });
    }

    function isImageContentType(ct) {
        return typeof ct === 'string' && ct.toLowerCase().startsWith('image/');
    }

    function buildDownloadUrl(messageId) {
        return `${API.download}?messageId=${encodeURIComponent(messageId)}`;
    }

    // =========================
    // âœ… Image Preview Modal
    // =========================
    function ensureImageModal() {
        if (document.getElementById('imgPreviewModal')) return;

        const modal = document.createElement('div');
        modal.id = 'imgPreviewModal';
        modal.className = 'img-preview-modal hidden';
        modal.innerHTML = `
            <div class="img-preview-backdrop"></div>
            <div class="img-preview-content" role="dialog" aria-modal="true">
                <button type="button" class="img-preview-close" aria-label="Close">âœ•</button>
                <img class="img-preview-img" alt="Preview" />
            </div>
        `;
        document.body.appendChild(modal);

        const close = () => modal.classList.add('hidden');
        modal.querySelector('.img-preview-backdrop')?.addEventListener('click', close);
        modal.querySelector('.img-preview-close')?.addEventListener('click', close);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) close();
        });
    }

    function openImagePreview(src) {
        if (!src) return;
        ensureImageModal();
        const modal = document.getElementById('imgPreviewModal');
        const img = modal.querySelector('.img-preview-img');
        img.src = src;
        modal.classList.remove('hidden');
    }

    // =========================
    // âœ… Attachment helpers UI
    // =========================
    function getSelectedFile() {
        return (chatFile && chatFile.files && chatFile.files.length > 0) ? chatFile.files[0] : null;
    }

    function showAttachChip(fileName) {
        if (!attachChip || !attachName) return;
        attachName.textContent = fileName || '';
        attachChip.classList.remove('hidden');
    }

    function clearAttachmentUI() {
        if (chatFile) chatFile.value = "";
        if (attachName) attachName.textContent = "";
        if (attachChip) attachChip.classList.add('hidden');
    }

    function readAttachmentFromMessage(m) {
        const a = m.attachment ?? m.Attachment ?? null;

        const storedName = m.attachmentStoredName ?? m.AttachmentStoredName ?? a?.storedName ?? a?.StoredName ?? null;
        const originalName = m.attachmentOriginalName ?? m.AttachmentOriginalName ?? a?.name ?? a?.Name ?? null;
        const contentType = m.attachmentContentType ?? m.AttachmentContentType ?? a?.type ?? a?.Type ?? null;
        const size = m.attachmentSize ?? m.AttachmentSize ?? a?.size ?? a?.Size ?? null;

        const attachmentUrl = m.attachmentUrl ?? m.AttachmentUrl ?? null;
        const previewUrl = m.previewUrl ?? null;

        return { storedName, originalName, contentType, size, attachmentUrl, previewUrl };
    }

    if (attachBtn && chatFile) {
        attachBtn.addEventListener("click", () => chatFile.click());
        chatFile.addEventListener("change", () => {
            const f = getSelectedFile();
            if (f) showAttachChip(f.name);
            else clearAttachmentUI();
        });
    }

    attachClearBtn?.addEventListener("click", clearAttachmentUI);

    // =========================
    // âœ… Presence cache
    // =========================
    const presenceMap = new Map();

    function setHeaderStatus(isOnline) {
        if (!chatHeaderSubTitle) return;

        chatHeaderSubTitle.classList.remove('hidden');
        chatHeaderSubTitle.classList.toggle('online', !!isOnline);
        chatHeaderSubTitle.classList.toggle('offline', !isOnline);
        chatHeaderSubTitle.textContent = isOnline ? 'â— Online' : 'â— Offline';
    }

    function clearHeaderStatus() {
        if (!chatHeaderSubTitle) return;
        chatHeaderSubTitle.textContent = '';
        chatHeaderSubTitle.classList.add('hidden');
        chatHeaderSubTitle.classList.remove('online', 'offline');
    }

    // =========================
    // FAB Badge + Pulse
    // =========================
    function setFabUnread(count) {
        const n = Math.max(0, parseInt(count || 0));
        if (!chatFabBadge) return;

        if (n === 0) {
            chatFabBadge.classList.add('hidden');
            chatFab.classList.remove('pulse');
            chatFabBadge.textContent = '0';
        } else {
            chatFabBadge.classList.remove('hidden');
            chatFabBadge.textContent = (n > 99) ? '99+' : String(n);
            chatFab.classList.add('pulse');
        }
    }

    function calcTotalUnread() {
        return (state.conversationsCache || []).reduce((sum, c) => sum + (parseInt(c.unread || 0)), 0);
    }

    function syncFabUnreadFromList() {
        setFabUnread(calcTotalUnread());
    }

    // =========================
    // Open / Close
    // =========================
    function showWidget() {
        state.isOpen = true;
        chatWidget.classList.add('open');
        chatWidget.setAttribute('aria-hidden', 'false');
        chatFab.style.display = 'none';

        showListScreen();
        loadConversations();
    }

    function hideWidget() {
        state.isOpen = false;
        chatWidget.classList.remove('open');
        chatWidget.setAttribute('aria-hidden', 'true');
        chatFab.style.display = 'block';

        state.currentStudentId = null;
        state.currentStudentName = '';
        state.conversationId = null;
        state.oldestMessageId = null;
        state.hasMore = false;
        state.isLoadingOlder = false;

        messagesBox.innerHTML = '';
        chatInput.value = '';
        chatSearch.value = '';
        clearAttachmentUI();

        clearHeaderStatus();
    }

    function showListScreen() {
        screenThread.classList.add('hidden');
        screenList.classList.remove('hidden');
        chatBackBtn.classList.add('hidden');
        chatHeaderTitle.textContent = 'Chats';

        state.currentStudentId = null;
        state.currentStudentName = '';
        state.conversationId = null;
        state.oldestMessageId = null;
        state.hasMore = false;
        state.isLoadingOlder = false;

        messagesBox.innerHTML = '';
        clearAttachmentUI();
        clearHeaderStatus();
    }

    function showThreadScreen(name) {
        screenList.classList.add('hidden');
        screenThread.classList.remove('hidden');
        chatBackBtn.classList.remove('hidden');
        chatHeaderTitle.textContent = name || 'Chat';
    }

    // =========================
    // Badges
    // =========================
    function removeBadge(studentId) {
        const item = findItem(studentId);
        if (!item) return;
        const badge = item.querySelector('.badge');
        if (badge) badge.remove();
    }

    function incrementBadge(studentId) {
        const item = findItem(studentId);
        if (!item) return;

        let badge = item.querySelector('.badge');
        if (!badge) {
            badge = document.createElement('div');
            badge.className = 'badge';
            badge.textContent = '1';
            item.appendChild(badge);
        } else {
            badge.textContent = (parseInt(badge.textContent || '0') + 1).toString();
        }
    }

    function bumpUnreadInCache(studentId, delta) {
        const c = (state.conversationsCache || []).find(x => (x.studentId === studentId));
        if (c) c.unread = Math.max(0, parseInt(c.unread || 0) + (delta || 0));
    }

    // =========================
    // Conversations list
    // =========================
    async function syncPresenceForList() {
        if (connection.state !== signalR.HubConnectionState.Connected) return;

        const dots = document.querySelectorAll('.presence-dot[data-presence-id]');
        const ids = Array.from(dots).map(d => String(d.dataset.presenceId));
        const uniqueIds = [...new Set(ids)];

        await Promise.all(uniqueIds.map(async (id) => {
            try {
                const isOnline = await connection.invoke("IsUserOnline", id);
                presenceMap.set(String(id), !!isOnline);

                const dot = document.querySelector(`.presence-dot[data-presence-id="${CSS.escape(String(id))}"]`);
                if (dot) {
                    dot.classList.toggle("online", !!isOnline);
                    dot.classList.toggle("offline", !isOnline);
                }
            } catch (e) {
                console.error("syncPresenceForList IsUserOnline error:", id, e);
            }
        }));
    }

    async function loadConversations() {
        try {
            const res = await fetch(API.conversations);
            if (!res.ok) {
                const txt = await res.text();
                console.log("GetInstructorConversations failed:", res.status, txt);
                chatItemsBox.innerHTML = `<div class="empty">Failed to load chats (${res.status})</div>`;
                return;
            }

            const ct = res.headers.get("content-type") || "";
            if (!ct.includes("application/json")) {
                const txt = await res.text();
                console.log("Not JSON response:", ct, txt);
                chatItemsBox.innerHTML = `<div class="empty">Failed to load chats (not json)</div>`;
                return;
            }

            const data = await res.json();
            state.conversationsCache = Array.isArray(data) ? data : [];
            renderConversations(state.conversationsCache);

            syncFabUnreadFromList();
            if (state.currentStudentId) setActive(state.currentStudentId);

            await syncPresenceForList();
        } catch (e) {
            console.error(e);
            chatItemsBox.innerHTML = `<div class="empty">Failed to load chats</div>`;
        }
    }

    function renderConversations(list) {
        chatItemsBox.innerHTML = '';

        if (!list || list.length === 0) {
            chatItemsBox.innerHTML = `<div class="empty">No chats yet</div>`;
            return;
        }

        for (const c of list) {
            const studentIdStr = String(c.studentId ?? '');
            const name = c.studentName ?? c.name ?? 'Student';
            const preview = c.lastMessage ?? '';
            const unread = parseInt(c.unread ?? 0);

            const avatarHtml = c.photoUrl
                ? `<img class="avatar-img" src="${escapeHtml(c.photoUrl)}" alt="${escapeHtml(name)}" />`
                : `<div class="avatar-text">${escapeHtml(initials(name))}</div>`;

            const unreadHtml = unread > 0 ? `<div class="badge">${unread}</div>` : '';

            const isOnline = presenceMap.get(studentIdStr) === true;
            const dotClass = isOnline ? 'online' : 'offline';

            chatItemsBox.insertAdjacentHTML('beforeend', `
                <div class="chat-item"
                     data-student-id="${escapeHtml(studentIdStr)}"
                     data-student-name="${escapeHtml(name)}">
                    <div class="avatar">
                        ${avatarHtml}
                        <span class="presence-dot ${dotClass}" data-presence-id="${escapeHtml(studentIdStr)}"></span>
                    </div>
                    <div class="meta">
                        <div class="name">${escapeHtml(name)}</div>
                        <div class="preview">${escapeHtml(preview)}</div>
                    </div>
                    ${unreadHtml}
                </div>
            `);
        }
    }

    chatItemsBox.addEventListener('click', (e) => {
        const item = e.target.closest('.chat-item');
        if (!item) return;
        openChat(item.dataset.studentId, item.dataset.studentName);
    });

    chatSearch.addEventListener('input', () => {
        const q = (chatSearch.value ?? '').trim().toLowerCase();
        const filtered = !q
            ? state.conversationsCache
            : state.conversationsCache.filter(x => ((x.studentName ?? x.name ?? '').toLowerCase().includes(q)));
        renderConversations(filtered);
        if (state.currentStudentId) setActive(state.currentStudentId);
    });

    // =========================
    // Thread (history + paging)
    // =========================
    async function openChat(studentId, studentName) {
        state.currentStudentId = studentId;
        state.currentStudentName = studentName;

        setActive(studentId);
        showThreadScreen(studentName);

        clearAttachmentUI();

        await loadHistoryFirst();

        await markAsRead(studentId);
        removeBadge(studentId);

        await loadConversations();

        try {
            const id = String(state.currentStudentId);
            const cached = presenceMap.get(id);
            if (cached !== undefined) {
                setHeaderStatus(cached);
            } else {
                const isOnline = await connection.invoke("IsUserOnline", state.currentStudentId);
                presenceMap.set(id, !!isOnline);
                setHeaderStatus(!!isOnline);
            }
        } catch (e) {
            console.error("IsUserOnline invoke error:", e);
        }
    }

    async function loadHistoryFirst() {
        messagesBox.innerHTML = '';
        state.hasMore = true;
        state.oldestMessageId = null;
        state.isLoadingOlder = false;

        await loadOlderMessages();
        messagesBox.scrollTop = messagesBox.scrollHeight;

        scheduleMarkAsReadHub();
    }

    async function loadOlderMessages() {
        if (!state.currentStudentId) return;
        if (!state.hasMore || state.isLoadingOlder) return;

        state.isLoadingOlder = true;

        const prevScrollHeight = messagesBox.scrollHeight;
        const prevScrollTop = messagesBox.scrollTop;

        const url =
            `${API.history}?studentId=${encodeURIComponent(state.currentStudentId)}`
            + `&take=${state.take}`
            + (state.oldestMessageId ? `&beforeId=${state.oldestMessageId}` : ``);

        try {
            const res = await fetch(url);
            const data = await res.json();

            const list = data.messages ?? [];
            state.conversationId = data.conversationId ?? null;
            state.hasMore = data.hasMore === true;

            if (!list.length) return;

            const frag = document.createDocumentFragment();
            for (const m of list) frag.appendChild(messageNode(m));
            messagesBox.prepend(frag);

            state.oldestMessageId = list[0]?.id ?? list[0]?.Id ?? state.oldestMessageId;

            const newScrollHeight = messagesBox.scrollHeight;
            messagesBox.scrollTop = (newScrollHeight - prevScrollHeight) + prevScrollTop;

        } catch (e) {
            console.error(e);
        } finally {
            state.isLoadingOlder = false;
        }
    }

    messagesBox.addEventListener('scroll', () => {
        if (messagesBox.scrollTop <= 10) loadOlderMessages();

        if (messagesBox.scrollTop + messagesBox.clientHeight >= messagesBox.scrollHeight - 6) {
            scheduleMarkAsReadHub();
        }
    });

    // =========================
    // MarkAsRead via SignalR (debounced)
    // =========================
    let readDebounceTimer = null;

    function scheduleMarkAsReadHub() {
        clearTimeout(readDebounceTimer);

        readDebounceTimer = setTimeout(() => {
            if (!state.isOpen) return;
            if (!state.conversationId) return;
            if (!state.currentStudentId) return;

            connection.invoke("MarkAsRead", state.conversationId, state.currentStudentId)
                .catch(err => console.error("MarkAsRead invoke error:", err));
        }, 200);
    }

    // =========================
    // Read ticks UI
    // =========================
    function ticksHtml(isMine, isRead) {
        if (!isMine) return '';
        const cls = isRead ? 'ticks read' : 'ticks';
        return `<span class="${cls}" title="${isRead ? 'Read' : 'Sent'}">âœ“âœ“</span>`;
    }

    // =========================
    // Render message
    // =========================
    function messageNode(m) {
        const id = (m.id ?? m.Id ?? '');
        const senderId = (m.senderId ?? m.SenderId ?? '');
        const receiverId = (m.receiverId ?? m.ReceiverId ?? '');
        const content = (m.content ?? m.Content ?? '') || '';
        const sentAt = (m.sentAt ?? m.SentAt);
        const isRead = (m.isRead ?? m.IsRead) === true;

        const meId = String(currentUserId || '').trim();
        const isMine = meId && String(senderId || '').trim() === meId;

        const att = readAttachmentFromMessage(m);

        let attachmentHtml = '';
        if (att.attachmentUrl) {
            if (isImageContentType(att.contentType)) {
                attachmentHtml = `
                    <div class="att">
                        <img class="att-img js-preview-img"
                             src="${escapeHtml(att.attachmentUrl)}"
                             data-full-src="${escapeHtml(att.attachmentUrl)}"
                             alt="${escapeHtml(att.originalName || 'image')}" />
                    </div>`;
            } else {
                attachmentHtml = `
                    <div class="att">
                        <a class="att-file" href="${escapeHtml(att.attachmentUrl)}" target="_blank" rel="noopener">
                            ğŸ“ ${escapeHtml(att.originalName || 'file')}
                        </a>
                    </div>`;
            }
        } else if (att.previewUrl && isImageContentType(att.contentType)) {
            attachmentHtml = `
                <div class="att">
                    <img class="att-img js-preview-img"
                         src="${escapeHtml(att.previewUrl)}"
                         data-full-src="${escapeHtml(att.previewUrl)}"
                         alt="${escapeHtml(att.originalName || 'image')}" />
                </div>`;
        } else if (att.storedName || att.originalName) {
            const href = id ? buildDownloadUrl(id) : '#';
            if (isImageContentType(att.contentType)) {
                attachmentHtml = `
                    <div class="att">
                        <img class="att-img js-preview-img"
                             src="${escapeHtml(href)}"
                             data-full-src="${escapeHtml(href)}"
                             alt="${escapeHtml(att.originalName || 'image')}" />
                    </div>`;
            } else {
                attachmentHtml = `
                    <div class="att">
                        <a class="att-file" href="${escapeHtml(href)}" target="_blank" rel="noopener">
                            ğŸ“ ${escapeHtml(att.originalName || 'file')}
                        </a>
                    </div>`;
            }
        }

        const textHtml = content ? `<div class="att-text">${escapeHtml(content)}</div>` : '';

        const wrapper = document.createElement('div');
        wrapper.className = `msg-row ${isMine ? 'mine' : ''}`;
        wrapper.dataset.messageId = String(id || '');

        wrapper.innerHTML = `
            <div class="bubble">
                ${textHtml}
                ${attachmentHtml}
                <span class="time">
                    ${escapeHtml(toTime(sentAt))}
                    ${ticksHtml(isMine, isRead)}
                </span>
            </div>
        `;
        return wrapper;
    }

    function renderMessage(m, { prepend = false } = {}) {
        const id = (m.id ?? m.Id ?? null);
        if (id) {
            const exists = messagesBox.querySelector(`.msg-row[data-message-id="${CSS.escape(String(id))}"]`);
            if (exists) return exists;
        }

        const node = messageNode(m);
        if (prepend) messagesBox.prepend(node);
        else messagesBox.appendChild(node);
        return node;
    }

    messagesBox.addEventListener('click', (e) => {
        const img = e.target.closest('img.js-preview-img');
        if (!img) return;
        const src = img.getAttribute('data-full-src') || img.src;
        openImagePreview(src);
    });

    function markMessagesReadUI(messageIds) {
        if (!Array.isArray(messageIds) || messageIds.length === 0) return;

        messageIds.forEach(id => {
            const row = messagesBox.querySelector(
                `.msg-row[data-message-id="${CSS.escape(String(id))}"]`
            );
            const tick = row?.querySelector('.ticks');
            if (tick) {
                tick.classList.add("read");
                tick.title = "Read";
            }
        });
    }

    // =========================
    // Mark read (HTTP)
    // =========================
    async function markAsRead(studentId) {
        try {
            await fetch(API.markRead, {
                method: 'POST',
                headers: addCsrfHeader({ 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' }),
                body: new URLSearchParams({ studentId })
            });
        } catch (e) {
            console.error(e);
        }
    }

    // =========================
    // Optimistic patch
    // =========================
    function patchOptimisticToReal(optimisticRowEl, payload) {
        if (!optimisticRowEl || !payload) return;

        const realId = payload.id ?? payload.Id;
        if (!realId) return;

        optimisticRowEl.dataset.messageId = String(realId);

        const attUrl = payload.attachmentUrl ?? payload.AttachmentUrl ?? null;
        const ct = payload.attachmentContentType ?? payload.AttachmentContentType ?? '';

        if (!attUrl) return;

        const img = optimisticRowEl.querySelector('img.att-img');
        const a = optimisticRowEl.querySelector('a.att-file');

        if (isImageContentType(ct)) {
            if (img) {
                img.src = attUrl;
                img.setAttribute('data-full-src', attUrl);
            }
        } else {
            if (a) a.href = attUrl;
        }
    }

    // =========================
    // Send message
    // =========================
    async function sendMessage() {
        const text = (chatInput.value || '').trim();
        const file = getSelectedFile();

        if (!state.currentStudentId) return;
        if (!text && !file) return;

        const nowIso = new Date().toISOString();
        const tempId = `tmp-${Date.now()}`;

        const optimistic = {
            id: tempId,
            receiverId: state.currentStudentId,
            content: text,
            sentAt: nowIso,
            isRead: false
        };

        let previewUrl = null;

        if (file) {
            optimistic.attachmentOriginalName = file.name;
            optimistic.attachmentContentType = file.type || 'application/octet-stream';
            if (isImageContentType(optimistic.attachmentContentType)) {
                previewUrl = URL.createObjectURL(file);
                optimistic.previewUrl = previewUrl;
            }
        }

        const optimisticNode = renderMessage(optimistic);
        messagesBox.scrollTop = messagesBox.scrollHeight;

        chatInput.value = '';
        clearAttachmentUI();

        const item = findItem(state.currentStudentId);
        if (item) {
            const prev = item.querySelector('.preview');
            if (prev) prev.textContent = text || (file ? `ğŸ“ ${file.name}` : '');
        }

        try {
            if (file) {
                const fd = new FormData();
                fd.append("ReceiverId", state.currentStudentId);
                fd.append("Content", text);
                fd.append("File", file);

                const res = await fetch(API.saveWithFile, {
                    method: 'POST',
                    headers: addCsrfHeader({}),
                    body: fd
                });

                if (!res.ok) {
                    const err = await res.text();
                    console.log("SendMessageWithFile failed:", res.status, err);
                    return;
                }

                const payload = await res.json();
                patchOptimisticToReal(optimisticNode, payload);
                if (previewUrl) URL.revokeObjectURL(previewUrl);
                return;
            }

            const res = await fetch(API.save, {
                method: 'POST',
                headers: addCsrfHeader({ 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' }),
                body: new URLSearchParams({ receiverId: state.currentStudentId, content: text })
            });

            const ct = res.headers.get("content-type") || "";
            if (!ct.includes("application/json")) {
                const txt = await res.text();
                console.log("SaveMessage not json:", res.status, txt);
                return;
            }

            const data = await res.json();
            if (!data || data.success !== true) {
                console.log('Save failed:', data);
                return;
            }

            const realId =
                data.id ?? data.Id ?? data.messageId ?? data.savedMessageId ??
                data.data?.id ?? data.data?.Id ?? data.message?.id ?? data.message?.Id;

            if (realId && optimisticNode) {
                optimisticNode.dataset.messageId = String(realId);
            }

            await sendRealtimeToStudent(state.currentStudentId, text);

        } catch (e) {
            console.error("sendMessage error:", e);
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    chatFab.addEventListener('click', showWidget);
    chatCloseBtn.addEventListener('click', hideWidget);
    chatBackBtn.addEventListener('click', showListScreen);

    // =========================
    // SignalR
    // =========================
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub")
        .withAutomaticReconnect()
        .build();

    connection.start()
        .then(() => console.log("SignalR Connected (Instructor)!"))
        .catch(err => console.error(err.toString()));

    connection.on("UpdateConversationList", function () {
        if (state.isOpen) loadConversations();
    });

    connection.on("MessagesRead", function (payload) {
        if (Array.isArray(payload)) {
            markMessagesReadUI(payload);
            return;
        }
        const ids = payload?.messageIds;
        if (Array.isArray(ids) && ids.length > 0) markMessagesReadUI(ids);
    });

    connection.on("ReceiveMessage", async function (arg1, arg2, arg3) {
        if (arg1 && typeof arg1 === 'object') {
            const p = arg1;

            const senderId = String(p.senderId ?? p.SenderId ?? '');
            const receiverId = String(p.receiverId ?? p.ReceiverId ?? '');
            const messageId = (p.id ?? p.Id ?? null);

            const sameOpenChat =
                state.isOpen
                && state.currentStudentId
                && (
                    senderId === String(state.currentStudentId)
                    || receiverId === String(state.currentStudentId)
                );

            if (sameOpenChat) {
                if (messageId) {
                    const exists = messagesBox.querySelector(`.msg-row[data-message-id="${CSS.escape(String(messageId))}"]`);
                    if (exists) return;
                }

                renderMessage(p);
                messagesBox.scrollTop = messagesBox.scrollHeight;

                scheduleMarkAsReadHub();

                await markAsRead(senderId);
                removeBadge(senderId);

                bumpUnreadInCache(senderId, -999999);
                syncFabUnreadFromList();

                await loadConversations();
                return;
            }

            const otherId = senderId;
            const item = findItem(otherId);
            if (item) {
                const prev = item.querySelector('.preview');
                const previewText = (p.content ?? p.Content ?? '').trim()
                    || ((p.attachmentOriginalName ?? p.AttachmentOriginalName) ? `ğŸ“ ${(p.attachmentOriginalName ?? p.AttachmentOriginalName)}` : '');

                if (prev) prev.textContent = previewText;

                incrementBadge(otherId);
                bumpUnreadInCache(otherId, +1);
                syncFabUnreadFromList();
            } else {
                await loadConversations();
            }
            return;
        }

        const senderId = arg1;
        const message = arg2;
        const timestamp = arg3;

        const sameOpenChat = state.isOpen && state.currentStudentId && senderId === state.currentStudentId;

        if (sameOpenChat) {
            renderMessage({ senderId, receiverId: 'me', content: message, sentAt: timestamp });
            messagesBox.scrollTop = messagesBox.scrollHeight;

            scheduleMarkAsReadHub();

            await markAsRead(senderId);
            removeBadge(senderId);

            bumpUnreadInCache(senderId, -999999);
            syncFabUnreadFromList();

            await loadConversations();
            return;
        }

        const item = findItem(senderId);
        if (item) {
            const prev = item.querySelector('.preview');
            if (prev) prev.textContent = message;

            incrementBadge(senderId);
            bumpUnreadInCache(senderId, +1);
            syncFabUnreadFromList();
        } else {
            await loadConversations();
        }
    });

    connection.on("PresenceChanged", function (userId, isOnline) {
        const id = String(userId);
        presenceMap.set(id, !!isOnline);

        if (state.isOpen && state.currentStudentId && String(state.currentStudentId) === id) {
            setHeaderStatus(!!isOnline);
        }

        const dot = document.querySelector(`.presence-dot[data-presence-id="${CSS.escape(id)}"]`);
        if (dot) {
            dot.classList.toggle("online", !!isOnline);
            dot.classList.toggle("offline", !isOnline);
        }
    });

    async function sendRealtimeToStudent(studentId, message) {
        try {
            await connection.invoke("SendMessage", studentId, message);
        } catch (e) {
            console.error(e.toString());
        }
    }
    </script>
}

@section Styles {
    <link rel="stylesheet" href="~/css/ChatMessage.css" asp-append-version="true" />
}
