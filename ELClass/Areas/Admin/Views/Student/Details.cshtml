@using Models.ViewModels.Student
@model StudentDetailsVM

@{
    var currentLang = System.Threading.Thread.CurrentThread.CurrentCulture.Name.StartsWith("ar") ? "ar" : "en";
    var direction = currentLang == "ar" ? "rtl" : "ltr";
}

<div class="container-fluid py-4" style="direction:@direction">

    <input type="hidden" id="studentId" value="@Model.Student.Id" />

    <div class="d-flex justify-content-between align-items-center mb-4 header-section">
        <div>
            <h2 class="fw-bold mb-1 fs-3">
                <i class="fas fa-chalkboard-teacher text-orange me-2"></i>
                @(currentLang == "ar" ? "إدارة الطالب" : "Student Management")
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <a href="/Admin/Student" class="text-muted text-decoration-none">
                            @(currentLang == "ar" ? "الطلاب" : "Students")
                        </a>
                    </li>
                    <li class="breadcrumb-item active text-orange" aria-current="page">
                        @(currentLang == "ar" ? Model.Student.NameAr : Model.Student.NameEn)
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="page-header">
        <h2>
            <i class="fas fa-user-graduate icon-primary me-2"></i>
            @(currentLang == "ar" ? Model.Student.NameAr : Model.Student.NameEn)
        </h2>
    </div>

    <div class="row mb-4">
        <div class="col-6 col-md-6 col-xl-3 mb-3">
            <a href="#crs">
                <div class="stat-card text-center">
                    <i class="fas fa-book fa-2x mb-2"></i>
                    <h3 class="text-white">@Model.StudentCourses.Count()</h3>
                    <p>@(currentLang == "ar" ? "الكورسات" : "Courses")</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-6 col-xl-3 mb-3">
            <a href="#ins">
                <div class="stat-card text-center">
                    <i class="fas fa-chalkboard-teacher fa-2x mb-2"></i>
                    <h3 class="text-white">@Model.InstructorStudents.Count()</h3>
                    <p>@(currentLang == "ar" ? "المدربين" : "Instructors")</p>
                </div>
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-12 col-xl-4">
            <div class="card custom-card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0 pb-0">
                    <h5 class="card-title">
                        <i class="fas fa-image" style="color:var(--primary-orange)"></i>
                        @(currentLang == "ar" ? "الصورة الشخصية" : "Profile Photo")
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="position-relative d-inline-block mb-3">
                        <img id="profilePreview" class="rounded-circle img-thumbnail shadow-sm"
                             src="@(Model.Student.ApplicationUser.Img != null
                                                             ? Url.Content("~/images/users/" + Model.Student.ApplicationUser.Img)
                                                             : $"https://ui-avatars.com/api/?name={Model.Student.NameEn}&background=fffaf5&color=fd7e14&size=128")"
                             style="width:160px; height:160px; border: 4px solid var(--soft-orange); object-fit: cover;">
                    </div>

                    <form asp-action="ChangeProfilePhoto" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="StudentId" value="@Model.Student.Id" />
                        <input type="file" id="photoInput" name="photo" accept="image/*" style="display:none;" />

                        <div class="px-3">
                            <button class="btn btn-orange-custom w-100 mb-2" type="button" onclick="document.getElementById('photoInput').click();">
                                <i class="fas fa-camera me-2"></i>@(currentLang == "ar" ? "تغيير الصورة" : "Change Photo")
                            </button>
                            <button id="savePhotoBtn" class="btn btn-success w-100 d-none" type="submit">
                                <i class="fas fa-check me-2"></i>@(currentLang == "ar" ? "تأكيد الصورة الجديدة" : "Confirm New Photo")
                            </button>
                        </div>
                    </form>

                    <hr class="mx-3 my-4 opacity-25">

                    <div class="@(currentLang == "ar" ? "text-end" : "text-start") px-3">
                        <p class="small text-muted mb-2"><i class="fas fa-envelope me-2"></i> @Model.Student.ApplicationUser.Email</p>
                        <p class="small text-muted mb-2"><i class="fas fa-user-pen me-2"></i> @Model.Student.ApplicationUser.UserName</p>
                        <p class="small text-muted mb-0"><i class="fas fa-phone me-2"></i> @(Model.Student.ApplicationUser.PhoneNumber ?? (currentLang == "ar" ? "لا يوجد هاتف" : "No Phone"))</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-xl-8" style="color:var(--primary-orange)">
            <div class="card custom-card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-circle" style="color:var(--primary-orange)"></i>
                        @(currentLang == "ar" ? "بيانات الطالب" : "Student Profile")
                    </h5>
                    <button type="button" id="enableEditBtn" class="btn btn-outline-orange btn-sm shadow-sm">
                        <i class="fas fa-edit me-1"></i> @(currentLang == "ar" ? "تعديل البيانات" : "Edit Profile")
                    </button>
                </div>
                <div class="card-body p-4">
                    <form asp-action="EditStudentDetails" id="instructorForm">
                        <input type="hidden" asp-for="Student.Id" />

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">@(currentLang == "ar" ? "الاسم (EN)" : "Full Name (EN)")</label>
                                <input class="form-control form-editable bg-light border-0 py-2" asp-for="Student.NameEn" type="text" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">@(currentLang == "ar" ? "الاسم (AR)" : "Full Name (AR)")</label>
                                <input class="form-control form-editable bg-light border-0 py-2" type="text" asp-for="Student.NameAr" readonly>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">@(currentLang == "ar" ? "البريد الإلكتروني" : "Email")</label>
                                <input class="form-control form-editable bg-light border-0 py-2" type="email" asp-for="Student.ApplicationUser.Email" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">@(currentLang == "ar" ? "رقم الهاتف" : "Phone Number")</label>
                                <input class="form-control form-editable bg-light border-0 py-2" asp-for="Student.ApplicationUser.PhoneNumber" readonly>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">@(currentLang == "ar" ? "العنوان (EN)" : "Address (EN)")</label>
                                <input class="form-control form-editable bg-light border-0 py-2" type="text" asp-for="Student.ApplicationUser.AddressEN" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">@(currentLang == "ar" ? "العنوان (AR)" : "Address (AR)")</label>
                                <input class="form-control form-editable bg-light border-0 py-2" type="text" asp-for="Student.ApplicationUser.AddressAR" readonly>
                            </div>
                        </div>

                        <div id="formActions" class="d-none gap-2 mt-4 pt-3 border-top">
                            <button class="btn btn-orange-custom px-4 shadow-sm" type="submit">
                                <i class="fas fa-save me-2"></i> @(currentLang == "ar" ? "حفظ التغييرات" : "Save Changes")
                            </button>
                            <button class="btn btn-light px-4 border" type="button" id="cancelEditBtn">
                                @(currentLang == "ar" ? "إلغاء" : "Cancel")
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="crs" class="card custom-card mt-4">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-book-reader icon-primary"></i>
                @(currentLang == "ar" ? "الكورسات المسجلة" : "Enrolled Courses")
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive mb-3">
                <table id="StudentCoursesTable" class="table admin-table w-100">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>@(currentLang == "ar" ? "اسم الكورس" : "Course")</th>
                            <th class="text-center">@(currentLang == "ar" ? "التحكم" : "Actions")</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="assign-section">
                <label class="fw-bold small mb-2">
                    <i class="fas fa-plus-circle text-orange"></i>
                    @(currentLang == "ar" ? "إضافة كورس للطالب" : "Assign Course")
                </label>
                <div class="row g-2">
                    <div class="col-md-9">
                        <select id="courseSelect" class="form-control"></select>
                    </div>
                    <div class="col-md-3">
                        <button id="assignCourseBtn" class="btn btn-orange-custom w-100">
                            <i class="fas fa-plus"></i> @(currentLang == "ar" ? "إضافة" : "Assign")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="ins" class="card custom-card mt-4">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-chalkboard-teacher icon-primary"></i>
                @(currentLang == "ar" ? "المدربين الموكلين" : "Assigned Instructors")
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive mb-3">
                <table id="StudentInstructorsTable" class="table admin-table w-100">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>@(currentLang == "ar" ? "اسم المدرب" : "Instructor")</th>
                            <th class="text-center">@(currentLang == "ar" ? "التحكم" : "Actions")</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="assign-section">
                <label class="fw-bold small mb-2">
                    <i class="fas fa-user-plus text-orange"></i>
                    @(currentLang == "ar" ? "تعيين مدرب للطالب" : "Assign Instructor")
                </label>
                <div class="row g-2">
                    <div class="col-md-9">
                        <select id="instructorSelect" class="form-control"></select>
                    </div>
                    <div class="col-md-3">
                        <button id="assignInstructorBtn" class="btn btn-orange-custom w-100">
                            <i class="fas fa-plus"></i> @(currentLang == "ar" ? "تعيين" : "Assign")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        var currentLang = '@currentLang';

        var dtLang = {
            ar: {
                processing: "جاري التحميل...",
                search: "بحث:",
                lengthMenu: "_MENU_",
                info: "عرض _START_ إلى _END_ من _TOTAL_",
                zeroRecords: "لا توجد نتائج",
                paginate: { next: "»", previous: "«" }
            },
            en: {
                processing: "Loading...",
                search: "Search:",
                lengthMenu: "_MENU_",
                info: "Showing _START_ to _END_ of _TOTAL_",
                zeroRecords: "No matching records found",
                paginate: { next: "»", previous: "«" }
            }
        };

        $(document).ready(function () {
            const studentId = $('#studentId').val();

            /* ================= COURSES TABLE ================= */
            const coursesTable = $('#StudentCoursesTable').DataTable({
                processing: true,
                serverSide: true,
                ordering: false,
                language: dtLang[currentLang],
                ajax: {
                    url: '/Admin/Student/GetStudentCourses',
                    type: 'POST',
                    data: d => { d.studentId = studentId; }
                },
                columns: [
                    { data: null, render: (d, t, r, m) => m.row + 1 },
                    {
                        data: 'title',
                        render: (data, type, row) => `<i class="fas fa-book me-1 text-muted"></i> <a href="/Admin/course/Details/${row.courseId}" class="course-link">${data}</a>`
                    },
                    {
                        data: 'courseId',
                        className: 'text-center',
                        render: (id, type, row) => `
                            <button class="btn btn-sm btn-light border" onclick="removeCourse('${id}', '${row.title}')">
                                <i class="fas fa-trash text-danger"></i>
                            </button>`
                    }
                ]
            });

            /* ================= INSTRUCTORS TABLE ================= */
            const instructorsTable = $('#StudentInstructorsTable').DataTable({
                processing: true,
                serverSide: true,
                ordering: false,
                language: dtLang[currentLang],
                ajax: {
                    url: '/Admin/Student/GetStudentInstructors',
                    type: 'POST',
                    data: d => { d.studentId = studentId; }
                },
                columns: [
                    { data: null, render: (d, t, r, m) => m.row + 1 },
                    {
                        data: 'name',
                        render: (data, type, row) => `<i class="fas fa-chalkboard-teacher me-1 text-muted"></i> <a href="/Admin/Instructor/Details/${row.instructorId}" class="instructor-link">${data}</a>`
                    },
                    {
                        data: 'instructorId',
                        className: 'text-center',
                        render: (id, type, row) => `
                            <button class="btn btn-sm btn-light border" onclick="removeInstructor('${id}', '${row.name}')">
                                <i class="fas fa-trash text-danger"></i>
                            </button>`
                    }
                ]
            });

            /* ================= SELECT2 ================= */
            $('#courseSelect').select2({
                placeholder: currentLang == 'ar' ? 'ابحث عن كورس...' : 'Search course...',
                minimumInputLength: 2,
                ajax: {
                    url: '/Admin/Student/SearchCourses',
                    data: p => ({ term: p.term, stdId: studentId }),
                    processResults: d => ({ results: d })
                }
            });

            $('#instructorSelect').select2({
                placeholder: currentLang == 'ar' ? 'ابحث عن مدرب...' : 'Search instructor...',
                minimumInputLength: 2,
                ajax: {
                    url: '/Admin/Student/SearchInstructors',
                    data: p => ({ term: p.term, studentId }),
                    processResults: d => ({ results: d })
                }
            });

            /* ================= ASSIGN ACTIONS ================= */
            $('#assignCourseBtn').click(() => {
                const courseId = $('#courseSelect').val();
                const courseName = $('#courseSelect option:selected').text();
                if(!courseId) return;
                assign('/Admin/Student/AssignCourse', { studentId, courseId },
                    currentLang == 'ar' ? `تم إضافة كورس (${courseName}) بنجاح` : `Course (${courseName}) assigned successfully.`);
            });

            $('#assignInstructorBtn').click(() => {
                const instructorId = $('#instructorSelect').val();
                const instructorName = $('#instructorSelect option:selected').text();
                if(!instructorId) return;
                assign('/Admin/Student/AssignInstructor', { studentId, instructorId },
                    currentLang == 'ar' ? `تم تعيين المدرب (${instructorName}) بنجاح` : `Instructor (${instructorName}) assigned successfully.`);
            });
        });

        function assign(url, data, successMessage) {
            Swal.fire({
                title: currentLang == 'ar' ? 'جاري الحفظ...' : 'Saving...',
                didOpen: () => Swal.showLoading()
            });

            $.post(url, data, function (res) {
                if (res.success) {
                    Swal.fire({ icon: 'success', title: currentLang == 'ar' ? 'تم' : 'Done', text: successMessage, timer: 1500, showConfirmButton: false });
                    $('#StudentCoursesTable').DataTable().ajax.reload();
                    $('#StudentInstructorsTable').DataTable().ajax.reload();
                    $('.form-control').val(null).trigger('change');
                } else {
                    Swal.fire('Error', res.message || 'Operation failed', 'error');
                }
            });
        }

        /* ================= REMOVE ACTIONS ================= */
        function removeCourse(id, title) {
            Swal.fire({
                title: currentLang == 'ar' ? 'حذف الكورس؟' : 'Remove Course?',
                html: currentLang == 'ar' ? `هل أنت متأكد من حذف الكورس <b>${title}</b> من هذا الطالب؟` : `Are you sure you want to remove <b>${title}</b>?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: currentLang == 'ar' ? 'نعم، احذف' : 'Yes, remove',
                cancelButtonText: currentLang == 'ar' ? 'إلغاء' : 'Cancel'
            }).then(r => {
                if (r.isConfirmed) {
                    $.get('/Admin/Student/RemoveCourse', { courseId: id, studentId: $('#studentId').val() }, function() {
                        Swal.fire({ icon: 'success', title: currentLang == 'ar' ? 'تم الحذف' : 'Removed!', timer: 1200, showConfirmButton: false });
                        $('#StudentCoursesTable').DataTable().ajax.reload();
                    });
                }
            });
        }

        function removeInstructor(id, name) {
            Swal.fire({
                title: currentLang == 'ar' ? 'إلغاء تعيين المدرب؟' : 'Unassign Instructor?',
                html: currentLang == 'ar' ? `هل أنت متأكد من إلغاء تعيين المدرب <b>${name}</b> لهذا الطالب؟` : `Are you sure you want to unassign <b>${name}</b>?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: currentLang == 'ar' ? 'نعم، ازالة' : 'Yes, remove',
                cancelButtonText: currentLang == 'ar' ? 'إلغاء' : 'Cancel'
            }).then(r => {
                if (r.isConfirmed) {
                    $.get('/Admin/Student/RemoveInstructor', { insId: id, stdId: $('#studentId').val() }, function() {
                        Swal.fire({ icon: 'success', title: currentLang == 'ar' ? 'تم الإلغاء' : 'Removed!', timer: 1200, showConfirmButton: false });
                        $('#StudentInstructorsTable').DataTable().ajax.reload();
                    });
                }
            });
        }

        /* Form Controls */
        $('#enableEditBtn').on('click', function() {
            $('.form-editable').removeAttr('readonly').removeClass('bg-light');
            $('#formActions').removeClass('d-none').addClass('d-flex');
            $(this).hide();
        });

        $('#cancelEditBtn').on('click', () => location.reload());

        $('#photoInput').on('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => $('#profilePreview').attr('src', e.target.result);
                reader.readAsDataURL(file);
                $('#savePhotoBtn').removeClass('d-none');
            }
        });
    </script>
}