@using Models.ViewModels.Student
@model StudentDetailsVM

@{
    var currentLang = Context.Session.GetString("Language") ?? "en";
    var direction = currentLang == "ar" ? "rtl" : "ltr";
}

<div class="container-fluid py-4" style="direction:@direction">

    <input type="hidden" id="studentId" value="@Model.Student.Id" />


    <div class="d-flex justify-content-between align-items-center mb-4 header-section">
        <div>
            <h2 class="fw-bold mb-1 fs-3"><i class="fas fa-chalkboard-teacher text-orange me-2"></i> Student Management</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/Admin/Student" class="text-muted text-decoration-none">Students</a></li>
                    <li class="breadcrumb-item active text-orange" aria-current="page">@Model.Student.NameEn</li>
                </ol>
            </nav>
        </div>

    </div>



    <!-- ================= HEADER ================= -->
    <div class="page-header">
        <h2>
            <i class="fas fa-user-graduate icon-primary me-2"></i>
            @Model.Student.NameEn
        </h2>
    </div>

    <!-- ================= PROFILE ================= -->
    <div class="row mb-4">

        <div class="col-6 col-md-6 col-xl-3 mb-3">
            <div class="stat-card text-center">
                <i class="fas fa-book fa-2x mb-2"></i>
                <h3>@Model.StudentCourses.Count()</h3>
                <p>@(currentLang == "ar" ? "الكورسات" : "Courses")</p>
            </div>
        </div>

        <div class="col-6 col-md-6 col-xl-3 mb-3">
            <div class="stat-card text-center">
                <i class="fas fa-chalkboard-teacher fa-2x mb-2"></i>
                <h3>@Model.InstructorStudents.Count()</h3>
                <p>@(currentLang == "ar" ? "المدربين" : "Instructors")</p>
            </div>
        </div>

    </div>

    <div class="row">
        <div class="col-12 col-xl-4">
            <div class="card custom-card border-0 shadow-sm ">
                <div class="card-header bg-white border-bottom-0 pb-0">
                    <h5 class="card-title"><i class="fas fa-image" style="color:var(--primary-orange)"></i> Profile Photo</h5>
                </div>
                <div class="card-body text-center">
                    <div class="position-relative d-inline-block mb-3">
                        <img id="profilePreview" class="rounded-circle img-thumbnail shadow-sm"
                             src="@(Model.Student.ApplicationUser.Img != null
                                ? Url.Content("~/images/users/" + Model.Student.ApplicationUser.Img)
                                : $"https://ui-avatars.com/api/?name={Model.Student.NameEn}&background=fffaf5&color=fd7e14&size=128")"
                             style="width:160px; height:160px; border: 4px solid var(--soft-orange); object-fit: cover;">
                    </div>

                    <form asp-action="ChangeProfilePhoto" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="StudentId" value="@Model.Student.Id" />
                        <input type="file" id="photoInput" name="photo" accept="image/*" style="display:none;" />

                        <div class="px-3">
                            <button class="btn btn-orange-custom w-100 mb-2" type="button" onclick="document.getElementById('photoInput').click();">
                                <i class="fas fa-camera me-2"></i>Change Photo
                            </button>
                            <button id="savePhotoBtn" class="btn btn-success w-100 d-none" type="submit">
                                <i class="fas fa-check me-2"></i>Confirm New Photo
                            </button>
                        </div>
                    </form>

                    <hr class="mx-3 my-4 opacity-25">

                    <div class="text-start px-3">
                        <p class="small text-muted mb-2"><i class="fas fa-envelope me-2"></i> @Model.Student.ApplicationUser.Email</p>
                        <p class="small text-muted mb-2"><i class="fas fa-user-pen me-2"></i> @Model.Student.ApplicationUser.UserName</p>
                        <p class="small text-muted mb-0"><i class="fas fa-phone me-2"></i> @(Model.Student.ApplicationUser.PhoneNumber ?? "No Phone")</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-xl-8" style="color:var(--primary-orange)">
            <div class="card custom-card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="card-title mb-0"><i class="fas fa-user-circle" style="color:var(--primary-orange)"></i> Student Profile</h5>
                    <button type="button" id="enableEditBtn" class="btn btn-outline-orange btn-sm shadow-sm">
                        <i class="fas fa-edit me-1"></i> Edit Profile
                    </button>
                </div>
                <div class="card-body p-4">
                    <form asp-action="EditStudentDetails" id="instructorForm">
                        <input type="hidden" asp-for="Student.Id" />

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Full Name (EN)</label>
                                <input class="form-control form-editable bg-light border-0 py-2" asp-for="Student.NameEn" type="text" readonly>
                                <span class="text-danger" asp-validation-for="Student.NameEn"></span>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted text-end d-block">الاسم بالكامل (AR)</label>
                                <input class="form-control form-editable bg-light border-0 py-2" type="text" asp-for="Student.NameAr" style="text-align:right" readonly>
                                <span class="text-danger" asp-validation-for="Student.NameAr"></span>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Email</label>
                                <input class="form-control form-editable bg-light border-0 py-2" type="email" asp-for="Student.ApplicationUser.Email" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Phone Number</label>
                                <input class="form-control form-editable bg-light border-0 py-2" asp-for="Student.ApplicationUser.PhoneNumber" readonly>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Address (EN)</label>
                                <input class="form-control form-editable bg-light border-0 py-2" type="text" asp-for="Student.ApplicationUser.AddressEN" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted text-end d-block">العنوان (AR)</label>
                                <input class="form-control form-editable bg-light border-0 py-2" type="text" asp-for="Student.ApplicationUser.AddressAR" style="text-align:right" readonly>
                            </div>
                        </div>

                        
                        <div id="formActions" class="d-none gap-2 mt-4 pt-3 border-top">
                            <button class="btn btn-orange-custom px-4 shadow-sm" type="submit">
                                <i class="fas fa-save me-2"></i> Save Changes
                            </button>
                            <button class="btn btn-light px-4 border" type="button" id="cancelEditBtn">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= COURSES ================= -->
    <div class="card custom-card">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-book-reader icon-primary"></i>
                @(currentLang == "ar" ? "الكورسات" : "Enrolled Courses")
            </h5>
        </div>

        <div class="card-body">

            <div class="table-responsive mb-3">
                <table id="StudentCoursesTable" class="table admin-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>@(currentLang == "ar" ? "اسم الكورس" : "Course")</th>
                            <th class="text-center">@((currentLang == "ar") ? "التحكم" : "Actions")</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="assign-section">
                <label class="fw-bold small mb-2">
                    <i class="fas fa-plus-circle text-orange"></i>
                    @(currentLang == "ar" ? "إضافة كورس" : "Assign Course")
                </label>

                <div class="row g-2">
                    <div class="col-md-9">
                        <select id="courseSelect" class="form-control"></select>
                    </div>
                    <div class="col-md-3">
                        <button id="assignCourseBtn" class="btn btn-orange-custom w-100">
                            <i class="fas fa-plus"></i> Assign
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ================= INSTRUCTORS ================= -->
    <div class="card custom-card mt-4">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-chalkboard-teacher icon-primary"></i>
                @(currentLang == "ar" ? "المدربين" : "Assigned Instructors")
            </h5>
        </div>

        <div class="card-body">

            <div class="table-responsive mb-3">
                <table id="StudentInstructorsTable" class="table admin-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>@(currentLang == "ar" ? "الاسم" : "Instructor")</th>
                            <th class="text-center">@((currentLang == "ar") ? "التحكم" : "Actions")</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="assign-section">
                <label class="fw-bold small mb-2">
                    <i class="fas fa-user-plus text-orange"></i>
                    @(currentLang == "ar" ? "إضافة مدرب" : "Assign Instructor")
                </label>

                <div class="row g-2">
                    <div class="col-md-9">
                        <select id="instructorSelect" class="form-control"></select>
                    </div>
                    <div class="col-md-3">
                        <button id="assignInstructorBtn" class="btn btn-orange-custom w-100">
                            <i class="fas fa-plus"></i> Assign
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

</div>

@section Scripts {

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {

            const studentId = $('#studentId').val();

            /* ================= COURSES TABLE ================= */
            const coursesTable = $('#StudentCoursesTable').DataTable({
                processing: true,
                serverSide: true,
                ordering: false,
                stateSave: true,
                responsive: true,
                autoWidth: false,
                ajax: {
                    url: '/Admin/Student/GetStudentCourses',
                    type: 'POST',
                    data: function (d) {
                        d.studentId = studentId;
                    }
                },
                columns: [
                    {
                        data: null,
                        render: (d, t, r, m) => `<span class="text-muted">${m.row + 1}</span>`
                    },
                    {
                        data: 'title',
                         render: function (data, type, row) {
                            return ` <i class="fas fa-book me-1 icon-primary" style="opacity:0.7"></i> <a href="/Admin/course/Details/${row.courseId}" class="course-link">${data}</a>`;
                        }
                    
                    },
                    {
                        data: 'courseId',
                        className: 'text-center',
                        render: (id, type, row) => `
                            <div class="action-buttons justify-content-center">
                                <a href="/Admin/Course/Details/${id}" class="btn btn-sm btn-light border">
                                    <i class="fas fa-eye text-primary"></i>
                                </a>
                                <button class="btn btn-sm btn-light border"
                                    onclick="removeCourse('${id}', '${row.title}')">
                                    <i class="fas fa-trash text-danger"></i>
                                </button>
                            </div>`
                    }
                ]
            });

            /* ================= INSTRUCTORS TABLE ================= */
            const instructorsTable = $('#StudentInstructorsTable').DataTable({
                processing: true,
                serverSide: true,
                ordering: false,
                stateSave: true,
                responsive: true,
                autoWidth: false,
                ajax: {
                    url: '/Admin/Student/GetStudentInstructors',
                    type: 'POST',
                    data: function (d) {
                        d.studentId = studentId;
                    }
                },
                columns: [
                    {
                        data: null,
                        render: (d, t, r, m) => `<span class="text-muted">${m.row + 1}</span>`
                    },
                    { data: 'name',
                        render: function (data, type, row) {
                            return ` <i class="fas fa-chalkboard-teacher me-1 icon-primary" style="opacity:0.7"></i> <a href="/Admin/Instructor/Details/${row.instructorId}" class="instructor-link">${data}</a>`;
                        }
                    },
                    {
                        data: 'instructorId',
                        className: 'text-center',
                        render: (id, type, row) => `
                            <div class="action-buttons justify-content-center">
                                <a href="/Admin/Instructor/Details/${id}" class="btn btn-sm btn-light border">
                                    <i class="fas fa-eye text-primary"></i>
                                </a>
                                <button class="btn btn-sm btn-light border"
                                    onclick="removeInstructor('${id}', '${row.name}')">
                                    <i class="fas fa-trash text-danger"></i>
                                </button>
                            </div>`
                    }
                ]
            });

            /* ================= SELECT2 ================= */
            $('#courseSelect').select2({
                placeholder: 'Search course...',
                minimumInputLength: 2,
                width: '100%',
                dropdownParent: $('#courseSelect').closest('.assign-section'),
                ajax: {
                    url: '/Admin/Student/SearchCourses',
                    delay: 300,
                    data: p => ({ term: p.term, stdId: studentId }),
                    processResults: d => ({ results: d })
                }
            });

            $('#instructorSelect').select2({
                placeholder: 'Search instructor...',
                minimumInputLength: 2,
                width: '100%',
                dropdownParent: $('#instructorSelect').closest('.assign-section'),
                ajax: {
                    url: '/Admin/Student/SearchInstructors',
                    delay: 300,
                    data: p => ({ term: p.term, studentId }),
                    processResults: d => ({ results: d })
                }
            });

            /* ================= ASSIGN ================= */
            $('#assignCourseBtn').click(() =>
                assign('/Admin/Student/AssignCourse',
                    { studentId, courseId: $('#courseSelect').val() },
                    'Course assigned successfully.'
                )
            );

            $('#assignInstructorBtn').click(() =>
                assign('/Admin/Student/AssignInstructor',
                    { studentId, instructorId: $('#instructorSelect').val() },
                    'Instructor assigned successfully.'
                )
            );

        });

        /* ================= ASSIGN FUNCTION ================= */
        function assign(url, data, successMessage) {
            const value = Object.values(data)[1];
            if (!value) return Swal.fire('Wait', 'Select item first', 'warning');

            $.ajax({
                url: url,
                type: 'POST',
                data: data,
                beforeSend: function () {
                    Swal.fire({
                        title: 'Saving...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });
                },
                success: function (res) {
                    if (res.success) {
                        Swal.fire({ icon: 'success', title: 'Done', text: successMessage, timer: 1200, showConfirmButton: false });
                        $('#StudentCoursesTable').DataTable().ajax.reload(null, false);
                        $('#StudentInstructorsTable').DataTable().ajax.reload(null, false);
                        $('#courseSelect').val(null).trigger('change');
                        $('#instructorSelect').val(null).trigger('change');
                    } else {
                        Swal.fire({ icon: 'error', title: 'Error', text: 'Operation failed' });
                    }
                },
                error: function () {
                    Swal.fire({ icon: 'error', title: 'Error', text: 'Server error occurred' });
                }
            });
        }

        /* ================= REMOVE ================= */
        function removeCourse(id, title) {
            Swal.fire({
                title: 'Remove Course?',
                html: `<p>You are about to remove the course <strong>${title}</strong> from the student.</p>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, remove',
                cancelButtonText: 'Cancel',
                confirmButtonColor: getComputedStyle(document.documentElement)
                    .getPropertyValue('--color-primary').trim()
            }).then(r => {
                if (r.isConfirmed) {
                    $.ajax({
                        url: '/Admin/Student/RemoveCourse',
                        type: 'GET',
                        data: { courseId: id, studentId: $('#studentId').val() },
                        beforeSend: function () {
                            Swal.fire({
                                title: 'Removing...',
                                allowOutsideClick: false,
                                didOpen: () => Swal.showLoading()
                            });
                        },
                        success: function () {
                            Swal.fire({ icon: 'success', title: 'Removed!', timer: 1200, showConfirmButton: false });
                            $('#StudentCoursesTable').DataTable().ajax.reload(null, false);
                        },
                        error: function () {
                            Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to remove course' });
                        }
                    });
                }
            });
        }

        function removeInstructor(id, name) {
            Swal.fire({
                title: 'Unassign Instructor?',
                html: `<p>You are about to unassign the instructor <strong>${name}</strong> from the student.</p>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, remove',
                cancelButtonText: 'Cancel',
                confirmButtonColor: getComputedStyle(document.documentElement)
                    .getPropertyValue('--color-primary').trim()
            }).then(r => {
                if (r.isConfirmed) {
                    $.ajax({
                        url: '/Admin/Student/RemoveInstructor',
                        type: 'GET',
                        data: { insId: id, stdId: $('#studentId').val() },
                        beforeSend: function () {
                            Swal.fire({
                                title: 'Removing...',
                                allowOutsideClick: false,
                                didOpen: () => Swal.showLoading()
                            });
                        },
                        success: function () {
                            Swal.fire({ icon: 'success', title: 'Removed!', timer: 1200, showConfirmButton: false });
                            $('#StudentInstructorsTable').DataTable().ajax.reload(null, false);
                        },
                        error: function () {
                            Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to remove instructor' });
                        }
                    });
                }
            });
        }


        /* Form */


        $('#enableEditBtn').on('click', function() {

            $('.form-editable').removeAttr('readonly').removeClass('bg-light');

            $('#formActions').removeClass('d-none').addClass('d-flex');
            $(this).hide();
        });


        $('#cancelEditBtn').on('click', function() {
            location.reload();
        });

        // img

            $('#photoInput').on('change', function (e) {
            const file = e.target.files[0];
            if (file) {

                const reader = new FileReader();
                reader.onload = function (event) {
                    $('#profilePreview').attr('src', event.target.result);
                };
                reader.readAsDataURL(file);


                $('#savePhotoBtn').removeClass('d-none');
            }
        });


    </script>


}
