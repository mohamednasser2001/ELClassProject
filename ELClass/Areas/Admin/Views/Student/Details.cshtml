@using Models.ViewModels.Student
@model StudentDetailsVM

@{
    var currentLang = Context.Session.GetString("Language") ?? "en";
    var direction = currentLang == "ar" ? "rtl" : "ltr";
}

<style>
    /* 1. الإعدادات العامة والألوان */
    :root {
        --primary-orange: #fd7e14;
        --hover-orange: #e86b00;
        --soft-orange: #fffaf5;
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    /* تحسين الاستجابة للهيدر */
    .header-section {
        flex-wrap: wrap;
        gap: 15px;
    }

    /* 2. تصميم الكروت */
    .custom-card {
        border: none;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        background-color: #ffffff;
        border-top: 4px solid var(--primary-orange);
        margin-bottom: 25px;
        overflow: hidden;
    }

    .card-header {
        background-color: transparent !important;
        border-bottom: 1px solid #f0f0f0 !important;
        padding: 15px 20px !important;
    }

    .card-title {
        font-weight: 700;
        color: #333;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.1rem;
    }

    /* 3. قسم الإضافة (Assign Section) */
    .assign-section {
        background: var(--soft-orange);
        border-radius: 12px;
        padding: 1.2rem;
        margin-top: 1rem;
        border: 2px dashed var(--primary-orange);
    }

    /* 4. كروت العناصر */
    .item-badge-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        border: 1px solid #eee;
        border-inline-start: 4px solid var(--primary-orange);
        transition: all 0.3s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

        .item-badge-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

    /* 5. الأزرار */
    .btn-orange-custom {
        background-color: var(--primary-orange);
        border: none;
        color: white !important;
        font-weight: 500;
        border-radius: 8px;
        transition: 0.3s;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        white-space: nowrap;
    }

        .btn-orange-custom:hover {
            background-color: var(--hover-orange);
        }

    /* Select2 Responsive Fix */
    .select2-container {
        width: 100% !important;
    }

    .select2-container--default .select2-selection--single {
        border-radius: 8px;
        height: 40px;
        border-color: #dee2e6;
        display: flex;
        align-items: center;
    }

    /* Media Queries لضبط الشاشات الصغيرة */
    @@media (max-width: 768px) {
        .header-section {
            flex-direction: column;
            align-items: flex-start !important;
        }

        .assign-section .row > div {
            margin-bottom: 10px;
        }

        .item-badge-card h6 {
            font-size: 0.85rem;
        }
    }
</style>

<div class="container-fluid py-4" style="direction: @direction; text-align: @(direction == "rtl" ? "right" : "left")">
    <input type="hidden" id="studentId" value="@Model.Student.Id" />

    <div class="d-flex justify-content-between align-items-center mb-4 header-section">
        <div>
            <h2 class="fw-bold mb-1 fs-3"><i class="fas fa-user-graduate text-orange me-2"></i> Student Management</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/Admin/Student" class="text-muted text-decoration-none">Students</a></li>
                    <li class="breadcrumb-item active text-orange" aria-current="page">@Model.Student.NameEn</li>
                </ol>
            </nav>
        </div>
        <span class="badge bg-white text-dark border p-2 shadow-sm">
            <i class="fas fa-id-card" style="color:var(--primary-orange)"></i> Student ID: @Model.Student.Id
        </span>
    </div>

    <div class="row">
        <div class="col-12 col-xl-4">
            <div class="card custom-card">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-camera" style="color:var(--primary-orange)"></i> Profile Picture</h5>
                </div>
                <div class="card-body text-center">
                    <img class="rounded-circle img-thumbnail mb-3 shadow-sm"
                         src="https://ui-avatars.com/api/?name=@Model.Student.NameEn&background=fffaf5&color=fd7e14&size=128"
                         style="width:140px; height:140px; border: 3px solid var(--soft-orange); object-fit: cover;">
                    <button class="btn btn-orange-custom w-100"><i class="fas fa-upload"></i> Update Photo</button>
                </div>
            </div>
        </div>

        <div class="col-12 col-xl-8">
            <div class="card custom-card">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-user-edit" style="color:var(--primary-orange)"></i> Account Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="small mb-1 fw-bold text-muted">Full Name (English)</label>
                            <input class="form-control bg-light" value="@Model.Student.NameEn" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="small mb-1 fw-bold text-muted">Username</label>
                            <input class="form-control bg-light" value="@Model.Student.ApplicationUser.UserName" readonly>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="small mb-1 fw-bold text-muted">Email Address</label>
                        <input class="form-control bg-light" value="@Model.Student.ApplicationUser.Email" readonly>
                    </div>
                    <button class="btn btn-orange-custom px-4"><i class="fas fa-save"></i> Edit Profile</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card custom-card">
        <div class="card-header">
            <h5 class="card-title"><i class="fas fa-book-reader" style="color:var(--primary-orange)"></i> Enrolled Courses</h5>
        </div>
        <div class="card-body">
            <div class="row">
                @if (Model.StudentCourses.Any())
                {
                    foreach (var item in Model.StudentCourses)
                    {
                        <div class="col-6 col-md-4 col-lg-3 mb-3">
                            <div class="item-badge-card">
                                <div class="mb-3">
                                    <small class="text-muted d-block mb-1">Course Title</small>
                                    <h6 class="fw-bold text-dark mb-0 text-truncate" title="@item.Course.TitleEn">@item.Course.TitleEn</h6>
                                </div>
                                <div class="d-flex gap-1">
                                    <a class="btn btn-sm btn-light border flex-grow-1" href="/Admin/Course/Details/@item.CourseId" title="View"><i class="fas fa-eye text-primary"></i></a>
                                    <button class="btn btn-sm btn-light border flex-grow-1" onclick="removeCourse(@item.CourseId)" title="Remove"><i class="fas fa-trash text-danger"></i></button>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12 text-center py-4 text-muted">No courses found for this student.</div>
                }
            </div>

            <div class="assign-section mt-4">
                <label class="fw-bold mb-2 small"><i class="fas fa-plus-circle text-orange"></i> Enroll in New Course</label>
                <div class="row g-2">
                    <div class="col-12 col-md-9">
                        <select id="courseSelect" class="form-control"></select>
                    </div>
                    <div class="col-12 col-md-3">
                        <button id="assignCourseBtn" class="btn btn-orange-custom w-100">
                            <i class="fas fa-plus"></i> Enroll
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card custom-card">
        <div class="card-header">
            <h5 class="card-title"><i class="fas fa-chalkboard-teacher" style="color:var(--primary-orange)"></i> Assigned Instructors</h5>
        </div>
        <div class="card-body">
            <div class="row">
                @if (Model.InstructorStudents.Any())
                {
                    foreach (var item in Model.InstructorStudents)
                    {
                        <div class="col-6 col-md-4 col-lg-3 mb-3">
                            <div class="item-badge-card text-center">
                                <div class="mb-3">
                                    <i class="fas fa-user-tie fa-2x mb-2 text-muted"></i>
                                    <h6 class="fw-bold text-dark mb-0 text-truncate">@item.Instructor.NameEn</h6>
                                    <small class="text-muted">Instructor</small>
                                </div>
                                <div class="d-flex gap-1">
                                    <a class="btn btn-sm btn-light border flex-grow-1" href="/Admin/Instructor/Details/@item.InstructorId"><i class="fas fa-eye text-primary"></i></a>
                                    <button class="btn btn-sm btn-light border flex-grow-1" onclick="removeInstructor('@item.InstructorId')"><i class="fas fa-trash text-danger"></i></button>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12 text-center py-4 text-muted">No instructors assigned.</div>
                }
            </div>

            <div class="assign-section mt-4">
                <label class="fw-bold mb-2 small"><i class="fas fa-user-plus text-orange"></i> Assign New Instructor</label>
                <div class="row g-2">
                    <div class="col-12 col-md-9">
                        <select id="instructorSelect" class="form-control"></select>
                    </div>
                    <div class="col-12 col-md-3">
                        <button id="assignInstructorBtn" class="btn btn-orange-custom w-100">
                            <i class="fas fa-plus"></i> Assign
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {
            const stdId = $('#studentId').val();

            // 1. Course Search Select2
            $('#courseSelect').select2({
                placeholder: "Search course...",
                allowClear: true,
                width: '100%',
                ajax: {
                    url: '/Admin/Student/SearchCourses',
                    data: params => ({ term: params.term, stdId: stdId }),
                    processResults: data => ({ results: data })
                }
            });

            // 2. Instructor Search Select2
            $('#instructorSelect').select2({
                placeholder: "Search instructor...",
                allowClear: true,
                width: '100%',
                ajax: {
                    url: '/Admin/Student/SearchInstructors',
                    data: params => ({ term: params.term, studentId: stdId }),
                    processResults: data => ({ results: data })
                }
            });

            // 3. Assign Course AJAX
            $('#assignCourseBtn').click(function () {
                const cId = $('#courseSelect').val();
                if (!cId) return Swal.fire('Note', 'Please select a course', 'info');

                $.ajax({
                    url: '/Admin/Student/AssignCourse',
                    type: 'POST',
                    data: { studentId: stdId, courseId: cId },
                    beforeSend: () => $('#assignCourseBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>'),
                    success: res => { if (res.success) location.reload(); else Swal.fire('Error', res.message, 'error'); },
                    error: () => Swal.fire('Error', 'Connection error', 'error'),
                    complete: () => $('#assignCourseBtn').prop('disabled', false).html('<i class="fas fa-plus"></i> Enroll')
                });
            });

            // 4. Assign Instructor AJAX
            $('#assignInstructorBtn').click(function () {
                const insId = $('#instructorSelect').val();
                if (!insId) return Swal.fire('Note', 'Please select an instructor', 'info');

                $.ajax({
                    url: '/Admin/Student/AssignInstructor',
                    type: 'POST',
                    data: { studentId: stdId, instructorId: insId },
                    beforeSend: () => $('#assignInstructorBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>'),
                    success: res => { if (res.success) location.reload(); else Swal.fire('Error', res.message, 'error'); },
                    error: () => Swal.fire('Error', 'Connection error', 'error'),
                    complete: () => $('#assignInstructorBtn').prop('disabled', false).html('<i class="fas fa-plus"></i> Assign')
                });
            });
        });

        // Remove Functions
        function removeCourse(id) {
            Swal.fire({
                title: 'Are you sure?',
                text: "Remove this course enrollment?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#fd7e14',
                confirmButtonText: 'Yes, remove'
            }).then(r => {
                if (r.isConfirmed) window.location.href = `/Admin/Student/RemoveCourse?courseId=${id}&studentId=${$('#studentId').val()}`;
            });
        }

        function removeInstructor(id) {
            Swal.fire({
                title: 'Are you sure?',
                text: "Unassign this instructor?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#fd7e14',
                confirmButtonText: 'Yes, remove'
            }).then(r => {
                if (r.isConfirmed) window.location.href = `/Admin/Student/RemoveInstructor?insId=${id}&stdId=${$('#studentId').val()}`;
            });
        }
    </script>
}