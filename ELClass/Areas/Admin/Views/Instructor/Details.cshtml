@using Models.ViewModels.Instructor
@model InstructorDetailsVM

@{
    var currentLang = Context.Session.GetString("Language") ?? "en";
    var direction = currentLang == "ar" ? "rtl" : "ltr";
}





<div class="container-fluid py-4" style="direction:@direction">

    <input type="hidden" id="instructorId" value="@Model.Instructor.Id" />




    <!-- ================= INSTRUCTOR PROFILE ================= -->
    <div class="d-flex justify-content-between align-items-center mb-4 header-section">
        <div>
            <h2 class="fw-bold mb-1 fs-3"><i class="fas fa-chalkboard-teacher text-orange me-2"></i> Instructor Management</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/Admin/Instructor" class="text-muted text-decoration-none">Instructors</a></li>
                    <li class="breadcrumb-item active text-orange" aria-current="page">@Model.Instructor.NameEn</li>
                </ol>
            </nav>
        </div>

    </div>


    <!-- ================= HEADER ================= -->
    <div class="page-header">
        <h2>
            <i class="fas fa-chalkboard-teacher icon-primary me-2"></i>
            @Model.Instructor.NameEn
        </h2>

    </div>

    <div class="row mb-4">

        <div class="col-6 col-md-6 col-xl-3 mb-3">
            <div class="stat-card text-center">
                <i class="fas fa-book fa-2x mb-2"></i>
                <h3>@Model.InstructorCourses.Count()</h3>
                <p>@(currentLang == "ar" ? "الكورسات" : "Courses")</p>
            </div>
        </div>

        <div class="col-6 col-md-6 col-xl-3 mb-3">
            <div class="stat-card text-center">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h3>@Model.InstructorStudents.Count()</h3>
                <p>@(currentLang == "ar" ? "الطلاب" : "Students")</p>
            </div>
        </div>

    </div>


    <div class="row">
        <div class="col-12 col-xl-4">
            <div class="card custom-card">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-image" style="color:var(--primary-orange)"></i> Photo</h5>
                </div>
                <div class="card-body text-center">
                    <img class="rounded-circle img-thumbnail mb-3 shadow-sm"
                         src="https://ui-avatars.com/api/?name=@Model.Instructor.NameEn&background=fffaf5&color=fd7e14&size=128"
                         style="width:140px; height:140px; border: 3px solid var(--soft-orange); object-fit: cover;">
                    <button class="btn btn-orange-custom w-100" type="button"><i class="fas fa-sync me-2"></i>Update Image</button>
                </div>
            </div>
        </div>

        <div class="col-12 col-xl-8">
            <div class="card custom-card">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-info-circle" style="color:var(--primary-orange)"></i> Personal Information</h5>
                </div>
                <div class="card-body">
                    <form>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="small mb-1 fw-bold text-muted">Name (English)</label>
                                <input class="form-control bg-light" type="text" value="@Model.Instructor.NameEn" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="small mb-1 fw-bold text-muted">Name (Arabic)</label>
                                <input class="form-control bg-light" type="text" value="@Model.Instructor.NameAr" readonly style="text-align:right">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="small mb-1 fw-bold text-muted">Email Address</label>
                            <input class="form-control bg-light" type="email" value="@Model.Instructor.ApplicationUser?.Email" readonly>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-orange-custom" type="button"><i class="fas fa-edit me-2"></i>Edit Instructor</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>



    <!-- ================= COURSES ================= -->
    <div class="card custom-card">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-layer-group icon-primary"></i>
                @(currentLang == "ar" ? "الكورسات" : "Managed Courses")
            </h5>
        </div>

        <div class="card-body">

            <div class="table-responsive mb-3">
                <table id="InstructorCoursesTable" class="table admin-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>@(currentLang == "ar" ? "اسم الكورس" : "Course Name")</th>
                            <th class="text-center">@((currentLang == "ar") ? "التحكم" : "Actions")</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Assign Course -->
            <div class="assign-section">
                <label class="fw-bold small mb-2">
                    <i class="fas fa-plus-circle text-orange"></i>
                    @(currentLang == "ar" ? "إضافة كورس" : "Assign New Course")
                </label>

                <div class="row g-2">
                    <div class="col-md-9">
                        <select id="courseSelect" class="form-control"></select>
                    </div>
                    <div class="col-md-3">
                        <button id="assignCourseBtn" class="btn btn-orange-custom w-100">
                            <i class="fas fa-plus"></i> Assign
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ================= STUDENTS ================= -->
    <div class="card custom-card mt-4">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-user-graduate icon-primary"></i>
                @(currentLang == "ar" ? "الطلاب" : "Students")
            </h5>
        </div>

        <div class="card-body">

            <div class="table-responsive mb-3">
                <table id="InstructorStudentsTable" class="table admin-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>@(currentLang == "ar" ? "اسم الطالب" : "Student Name")</th>
                            <th class="text-center">@((currentLang == "ar") ? "التحكم" : "Actions")</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Assign Student -->
            <div class="assign-section">
                <label class="fw-bold small mb-2">
                    <i class="fas fa-user-plus text-orange"></i>
                    @(currentLang == "ar" ? "إضافة طالب" : "Assign New Student")
                </label>

                <div class="row g-2">
                    <div class="col-md-9">
                        <select id="studentSelect" class="form-control"></select>
                    </div>
                    <div class="col-md-3">
                        <button id="assignStudentBtn" class="btn btn-orange-custom w-100">
                            <i class="fas fa-user-plus"></i> Assign
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

</div>

@section Scripts {

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

   
    <script>
        $(document).ready(function () {

            const instructorId = $('#instructorId').val();

            /* ================= COURSES TABLE ================= */
                   const coursesTable = $('#InstructorCoursesTable').DataTable({
                    processing: true,
                    serverSide: true,
                    ordering: false,
                    responsive: true,
                    autoWidth: false,
                    ajax: {
                        url: '/Admin/Instructor/GetInstructorCourses',
                        type: 'POST',
                        data: function (d) {
                            d.instructorId = instructorId;
                        }
                    },
                    columns: [
                        {
                            data: null,
                            render: (d, t, r, m) =>
                                `<span class="text-muted">${m.row + 1}</span>`
                        },
                        { data: 'title' },
                        {
                            data: 'courseId',
                            className: 'text-center',
                            render: function (id, type, row) {
                                return `
                                <div class="action-buttons justify-content-center">
                                    <a href="/Admin/Course/Details/${id}" class="btn btn-sm btn-light border">
                                        <i class="fas fa-eye text-primary"></i>
                                    </a>
                                    <button class="btn btn-sm btn-light border"
                                        onclick="confirmRemoveCourse('${id}', '${row.title}')">
                                        <i class="fas fa-trash text-danger"></i>
                                    </button>
                                </div>`;
                            }
                        }
                    ]
                });


            /* ================= STUDENTS TABLE ================= */
                    const studentsTable = $('#InstructorStudentsTable').DataTable({
                processing: true,
                serverSide: true,
                ordering: false,
                responsive: true,      
                autoWidth: false,       
                ajax: {
                    url: '/Admin/Instructor/GetInstructorStudents',
                    type: 'POST',
                    data: function (d) {
                        d.instructorId = instructorId;
                    }
                },
                columns: [
                    {
                        data: null,
                        render: (d, t, r, m) =>
                            `<span class="text-muted">${m.row + 1}</span>`
                    },
                    {
                        data: 'name'
                    },
                    {
                        data: 'studentId',
                        className: 'text-center',
                        render: function (id, type, row) {
                            return `
                                <div class="action-buttons justify-content-center">
                                    <a href="/Admin/Student/Details/${id}"
                                       class="btn btn-sm btn-light border">
                                        <i class="fas fa-eye text-primary"></i>
                                    </a>
                                    <button class="btn btn-sm btn-light border"
                                        onclick="confirmRemoveStudent('${id}', '${row.name}')">
                                        <i class="fas fa-trash text-danger"></i>
                                    </button>
                                </div>`;
                        }
                    }
                ],
                columnDefs: [
                    {
                        targets: 0,
                        responsivePriority: 3   
                    },
                    {
                        targets: 1,
                        responsivePriority: 1   
                    },
                    {
                        targets: -1,
                        responsivePriority: 2  
                    }
                ]
            });

                    $(window).on('resize', function () {
            $('#InstructorCoursesTable').DataTable().columns.adjust().responsive.recalc();
            $('#InstructorStudentsTable').DataTable().columns.adjust().responsive.recalc();
             });

            /* ================= SELECT2 ================= */
            $('#courseSelect').select2({
                placeholder: 'Search course...',
                minimumInputLength: 2,
                width: '100%',
                dropdownParent: $('#courseSelect').closest('.assign-section'),
                ajax: {
                    url: '/Admin/Instructor/SearchCourses',
                    delay: 300,
                    data: function (params) {
                        return {
                            term: params.term,
                            instructorId: instructorId
                        };
                    },
                    processResults: function (data) {
                        return { results: data };
                    }
                }
            });

            $('#studentSelect').select2({
                placeholder: 'Search student...',
                minimumInputLength: 2,
                width: '100%',
                dropdownParent: $('#studentSelect').closest('.assign-section'),
                ajax: {
                    url: '/Admin/Instructor/SearchStudents',
                    delay: 300,
                    data: function (params) {
                        return {
                            term: params.term,
                            instructorId: instructorId
                        };
                    },
                    processResults: function (data) {
                        return { results: data };
                    }
                }
            });

            /* ================= ASSIGN BUTTONS ================= */
            $('#assignCourseBtn').on('click', function () {
                assign(
                    '/Admin/Instructor/AssignCourse',
                    {
                        instructorId: instructorId,
                        courseId: $('#courseSelect').val()
                    },
                    'Course assigned successfully.'
                );
            });

            $('#assignStudentBtn').on('click', function () {
                assign(
                    '/Admin/Instructor/AssignStudent',
                    {
                        instructorId: instructorId,
                        studentId: $('#studentSelect').val()
                    },
                    'Student assigned successfully.'
                );
            });

        });

        /* ================= ASSIGN FUNCTION ================= */
        function assign(url, data, successMessage) {

            const value = Object.values(data)[1];
            if (!value) {
                Swal.fire('Wait', 'Please select an item first.', 'warning');
                return;
            }

            $.ajax({
                url: url,
                type: 'POST',
                data: data,
                beforeSend: function () {
                    Swal.fire({
                        title: 'Saving...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });
                },
                success: function (res) {

                    if (res && res.success === true) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Done!',
                            text: successMessage,
                            timer: 1500,
                            showConfirmButton: false
                        });

                        $('#InstructorCoursesTable').DataTable().ajax.reload(null, false);
                        $('#InstructorStudentsTable').DataTable().ajax.reload(null, false);

                        $('#courseSelect').val(null).trigger('change');
                        $('#studentSelect').val(null).trigger('change');
                    }
                    else {
                        Swal.fire('Error', 'Operation failed.', 'error');
                    }
                },
                error: function () {
                    Swal.fire('Error', 'Server error occurred.', 'error');
                }
            });
        }

        /* ================= REMOVE COURSE ================= */
        function confirmRemoveCourse(courseId, courseName) {
            Swal.fire({
                title: 'Remove Course?',
                html: `<p>You are about to remove:</p><strong class="text-orange">${courseName}</strong>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, remove',
                cancelButtonText: 'Cancel'
            }).then(result => {
                if (result.isConfirmed) {
                    removeCourse(courseId);
                }
            });
        }

        function removeCourse(courseId) {
            $.ajax({
                url: '/Admin/Instructor/RemoveCourse',
                type: 'GET',
                data: {
                    courseId: courseId,
                    instructorId: $('#instructorId').val()
                },
                beforeSend: function () {
                    Swal.fire({
                        title: 'Removing...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });
                },
                success: function () {
                    Swal.fire({
                        icon: 'success',
                        title: 'Removed!',
                        timer: 1200,
                        showConfirmButton: false
                    });

                    $('#InstructorCoursesTable').DataTable().ajax.reload(null, false);
                },
                error: function () {
                    Swal.fire('Error', 'Failed to remove course.', 'error');
                }
            });
        }

        /* ================= REMOVE STUDENT ================= */
        function confirmRemoveStudent(studentId, studentName) {
            Swal.fire({
                title: 'Unassign Student?',
                html: `<p>You are about to remove:</p><strong class="text-orange">${studentName}</strong>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, remove',
                cancelButtonText: 'Cancel'
            }).then(result => {
                if (result.isConfirmed) {
                    removeStudent(studentId);
                }
            });
        }

        function removeStudent(studentId) {
            $.ajax({
                url: '/Admin/Instructor/RemoveStudent',
                type: 'GET',
                data: {
                    studentId: studentId,
                    instructorId: $('#instructorId').val()
                },
                beforeSend: function () {
                    Swal.fire({
                        title: 'Removing...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });
                },
                success: function () {
                    Swal.fire({
                        icon: 'success',
                        title: 'Removed!',
                        timer: 1200,
                        showConfirmButton: false
                    });

                    $('#InstructorStudentsTable').DataTable().ajax.reload(null, false);
                },
                error: function () {
                    Swal.fire('Error', 'Failed to remove student.', 'error');
                }
            });
        }
    </script>


}
