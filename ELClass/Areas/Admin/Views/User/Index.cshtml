@{
    var currentLang = System.Threading.Thread.CurrentThread.CurrentCulture.Name.StartsWith("ar") ? "ar" : "en";
    var direction = currentLang == "ar" ? "rtl" : "ltr";
}

<div class="container-fluid" style="direction: @direction;">
    <div class="row">
        <div class="col-12">
            <div class="card custom-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">
                        <i class="fa fa-users me-2 icon-primary"></i>
                        @(currentLang == "ar" ? "قائمة المستخدمين" : "Users List")
                    </h3>
                </div>

                <div class="card-body p-2 p-md-4">
                    <div class="table-responsive">
                        <table id="usersTable" class="table w-100">
                            <thead>
                                <tr>
                                    <th style="text-align: @(currentLang == "ar" ? "right" : "left")">#</th>
                                    <th style="text-align: @(currentLang == "ar" ? "right" : "left")">@(currentLang == "ar" ? "اسم المستخدم" : "User Name")</th>
                                    <th style="text-align: @(currentLang == "ar" ? "right" : "left")" class="d-none d-md-table-cell">@(currentLang == "ar" ? "البريد الإلكتروني" : "Email")</th>
                                    <th style="text-align: @(currentLang == "ar" ? "right" : "left")" class="d-none d-md-table-cell">@(currentLang == "ar" ? "الدور" : "Role")</th>
                                    <th style="text-align: @(currentLang == "ar" ? "right" : "left")">@(currentLang == "ar" ? "التحكم" : "Actions")</th>
                                </tr>
                                @Html.AntiForgeryToken()
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        var currentLang = '@currentLang';

        var languageSettings = {
            ar: {
                processing: "جاري التحميل...",
                search: "بحث:",
                lengthMenu: "_MENU_",
                info: "عرض _START_ إلى _END_ من _TOTAL_",
                zeroRecords: "لم يتم العثور على نتائج",
                paginate: { next: "»", previous: "«" }
            },
            en: {
                processing: "Loading...",
                search: "Search:",
                lengthMenu: "_MENU_",
                info: "Showing _START_ to _END_ of _TOTAL_",
                zeroRecords: "No matching records found",
                paginate: { next: "»", previous: "«" }
            }
        };

        $(document).ready(function () {
            $('#usersTable').DataTable({
                processing: true,
                serverSide: true,
                ordering: true,
                stateSave: true,
                responsive: true,
                ajax: {
                    url: '/Admin/User/GetUsers',
                    type: 'POST'
                },
                columns: [
                    {
                        data: null,
                        render: function (data, type, row, meta) {
                            return `<span class="text-muted small">${meta.row + meta.settings._iDisplayStart + 1}</span>`;
                        }
                    },
                    {
                        data: 'userName',
                        render: function (data, type, row) {
                            return `<i class="fas fa-user-circle me-1 icon-primary" style="opacity:0.7"></i>
                                    <a href="/Admin/user/Details/${row.id}" class="course-link">${data}</a>`;
                        }
                    },
                    {
                        data: 'email',
                        className: 'd-none d-md-table-cell',
                        render: (data) => `<span class="small text-muted">${data}</span>`
                    },
                    {
                        data: 'role',
                        className: 'd-md-table-cell',
                        render: function (data, type, row) {
                            var badgeClass = "bg-light text-dark border";
                            if (data && data.indexOf('SuperAdmin') !== -1) badgeClass = "bg-primary text-white";
                            else if (data && data.indexOf('Admin') !== -1) badgeClass = "bg-info text-white";

                            return `
                                <a href="/Admin/User/ManageRole/${row.id}" class="text-decoration-none">
                                    <span class="badge ${badgeClass} shadow-sm" style="cursor: pointer;">
                                        <i class="fas fa-user-shield me-1 small"></i> ${data || 'No Role'}
                                    </span>
                                </a>`;
                        }
                    },
                    {
                        data: 'id',
                        render: function (data, type, row) {
                            var actionText = row.isBlocked ? (currentLang === 'ar' ? 'إلغاء الحظر' : 'Unblock') : (currentLang === 'ar' ? 'حظر' : 'Block');
                            var iconClass = row.isBlocked ? 'fa-lock' : 'fa-lock-open';
                            var iconColor = row.isBlocked ? 'text-danger' : 'text-success';
                            var btnClass = row.isBlocked ? 'btn-outline-secondary' : 'btn-outline-danger';

                            return `
                                <div class="d-flex gap-2 justify-content-center align-items-center">
                                    <button onclick="toggleBlock('${data}')" class="btn btn-sm ${btnClass} text-nowrap">
                                      <i class="fas ${iconClass} ${iconColor} me-1" style="font-size: 1.1rem;"></i> ${actionText}
                                    </button>

                                    <button class="btn btn-sm btn-light border text-danger"
                                            onclick="deleteUser('${data}', '${row.userName}', '${row.role}')">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>`;
                        }
                    }
                ],
                language: languageSettings[currentLang],
                pageLength: 10,
                dom: '<"d-flex justify-content-between mb-2"lf>rt<"d-flex justify-content-between mt-2"ip>'
            });
        });

        function deleteUser(id, userName, role) {
            var isStudent = role && role.indexOf('Student') !== -1;
            var targetUrl = isStudent ? '/Admin/Student/Delete' : '/Admin/Instructor/Delete';
            var token = $('input[name="__RequestVerificationToken"]').val();

            var titleMsg = currentLang === 'ar' ? `هل أنت متأكد من حذف ${userName}؟` : `Are you sure you want to delete ${userName}?`;
            var textMsg = currentLang === 'ar' ? 'سيتم حذف كافة البيانات المرتبطة بهذا الحساب!' : 'All data associated with this account will be deleted!';

            Swal.fire({
                title: titleMsg,
                text: textMsg,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: currentLang === 'ar' ? 'نعم، احذف!' : 'Yes, delete it!',
                cancelButtonText: currentLang === 'ar' ? 'إلغاء' : 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: targetUrl,
                        type: 'POST',
                        data: { id: id , __RequestVerificationToken: token},
                        success: function (response) {
                            if (response.success !== false) {
                                $('#usersTable').DataTable().ajax.reload(null, false);
                                Swal.fire(
                                    currentLang === 'ar' ? 'تم الحذف!' : 'Deleted!',
                                    currentLang === 'ar' ? 'تم حذف المستخدم بنجاح.' : 'User deleted successfully.',
                                    'success'
                                );
                            } else {
                                Swal.fire('Error!', response.message || 'Error deleting user', 'error');
                            }
                        },
                        error: function () {
                            Swal.fire('Error!', 'Something went wrong on the server', 'error');
                        }
                    });
                }
            });
        }

        function toggleBlock(id) {
            $.ajax({
                url: '/Admin/User/ToggleBlock',
                type: 'POST',
                data: { id: id },
                success: function (response) {
                    if (response.success) {
                        $('#usersTable').DataTable().ajax.reload(null, false);
                        const Toast = Swal.mixin({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000
                        });
                        Toast.fire({
                            icon: 'success',
                            title: response.message
                        });
                    } else {
                        Swal.fire('Error!', response.message, 'error');
                    }
                },
                error: function () {
                    Swal.fire('Error!', 'Something went wrong', 'error');
                }
            });
        }
    </script>
}