@using Models.ViewModels.Course
@model CourseDetailsVM

@{
    var currentLang = Context.Session.GetString("Language") ?? "en";
    var direction = currentLang == "ar" ? "rtl" : "ltr";
}

<div class="container-fluid py-4" style="direction:@direction">
    <input type="hidden" id="courseId" value="@Model.Course.Id" />

    <div class="page-header mb-4">
        <h2>
            <i class="fas fa-book-open icon-primary me-2"></i>
            @Model.Course.TitleEn
        </h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/Admin/Course" class="text-muted">Courses</a></li>
                <li class="breadcrumb-item active text-orange">Details</li>
            </ol>
        </nav>
    </div>

    <div class="row mb-4">
        <div class="col-6 col-md-3">
            <div class="stat-card text-center">
                <i class="fas fa-chalkboard-teacher fa-2x mb-2"></i>
                <h3>@Model.InstructorCourses.Count()</h3>
                <p>Instructors</p>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card text-center">
                <i class="fas fa-user-graduate fa-2x mb-2"></i>
                <h3>@Model.StudentCourses.Count()</h3>
                <p>Students</p>
            </div>
        </div>
    </div>

    <!-- Assigned Instructors Section -->
    <div class="card custom-card mb-4">
        <div class="card-header">
            <h5 class="card-title"><i class="fas fa-chalkboard-teacher icon-primary"></i> Assigned Instructors</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive mb-3">
                <table id="instructorsCourseTable" class="table admin-table w-100">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="assign-section mt-3">
                <label class="fw-bold small mb-2"><i class="fas fa-plus-circle text-orange"></i> Assign Instructor</label>
                <div class="row g-2">
                    <div class="col-md-9">
                        <select id="instructorSelect" class="form-control"></select>
                    </div>
                    <div class="col-md-3">
                        <button id="assignInstructorBtn" class="btn btn-orange-custom w-100">
                            <i class="fas fa-plus"></i> Assign
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enrolled Students Section -->
    <div class="card custom-card">
        <div class="card-header">
            <h5 class="card-title"><i class="fas fa-user-graduate icon-primary"></i> Enrolled Students</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive mb-3">
                <table id="studentsCourseTable" class="table admin-table w-100">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="assign-section mt-3">
                <label class="fw-bold small mb-2"><i class="fas fa-user-plus text-orange"></i> Enroll Student</label>
                <div class="row g-2">
                    <div class="col-md-9">
                        <select id="studentSelect" class="form-control"></select>
                    </div>
                    <div class="col-md-3">
                        <button id="enrollStudentBtn" class="btn btn-orange-custom w-100">
                            <i class="fas fa-plus"></i> Enroll
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {
            const courseId = $('#courseId').val();

            // Instructors Table Initialization
            const insTable = $('#instructorsCourseTable').DataTable({
                processing: true,
                serverSide: true,
                ordering: false,
                responsive: true,
                ajax: {
                    url: '/Admin/Course/GetCourseInstructors',
                    type: 'POST',
                    data: function (d) { d.courseId = courseId; }
                },
                columns: [
                    { data: null, render: (d, t, r, m) => m.row + 1 + m.settings._iDisplayStart },
                    { data: 'name' },
                    {
                        data: 'instructorId',
                        className: 'text-center',
                        render: (id) => `
                            <div class="action-buttons justify-content-center">
                                <a href="/Admin/Instructor/Details/${id}" class="btn btn-sm btn-light border"><i class="fas fa-eye text-primary"></i></a>
                                <button class="btn btn-sm btn-light border" onclick="removeInstructor('${id}')"><i class="fas fa-trash text-danger"></i></button>
                            </div>`
                    }
                ]
            });

            // Students Table Initialization
            const stdTable = $('#studentsCourseTable').DataTable({
                processing: true,
                serverSide: true,
                ordering: false,
                responsive: true,
                ajax: {
                    url: '/Admin/Course/GetCourseStudents',
                    type: 'POST',
                    data: function (d) { d.courseId = courseId; }
                },
                columns: [
                    { data: null, render: (d, t, r, m) => m.row + 1 + m.settings._iDisplayStart },
                    { data: 'name' },
                    {
                        data: 'studentId',
                        className: 'text-center',
                        render: (id) => `
                            <div class="action-buttons justify-content-center">
                                <a href="/Admin/Student/Details/${id}" class="btn btn-sm btn-light border"><i class="fas fa-eye text-primary"></i></a>
                                <button class="btn btn-sm btn-light border" onclick="removeStudent('${id}')"><i class="fas fa-trash text-danger"></i></button>
                            </div>`
                    }
                ]
            });

            // Select2 Initialization for Instructor and Student
            $('#instructorSelect').select2({
                placeholder: "Search Instructor...",
                width: '100%',
                ajax: {
                    url: '/Admin/Course/SearchInstructors',
                    dataType: 'json',
                    data: p => ({ term: p.term, courseId: courseId }),
                    processResults: d => ({ results: d })
                }
            });

            $('#studentSelect').select2({
                placeholder: "Search Student...",
                width: '100%',
                ajax: {
                    url: '/Admin/Course/SearchStudents',
                    dataType: 'json',
                    data: p => ({ term: p.term, courseId: courseId }),
                    processResults: d => ({ results: d })
                }
            });

            // Assign Instructor
            $('#assignInstructorBtn').click(() => {
                const id = $('#instructorSelect').val();
                if (!id) return;
                $.post('/Admin/Course/AssignInstructor', { courseId, InstructorId: id }, res => {
                    if (res.success) {
                        Swal.fire({ icon: 'success', title: 'Done!', text: 'Instructor assigned successfully', timer: 1500, showConfirmButton: false });
                        insTable.ajax.reload();
                        $('#instructorSelect').val(null).trigger('change');
                    }
                });
            });

            // Enroll Student
            $('#enrollStudentBtn').click(() => {
                const id = $('#studentSelect').val();
                if (!id) return;
                $.post('/Admin/Course/AssignStudent', { courseId, studentId: id }, res => {
                    if (res.success) {
                        Swal.fire({ icon: 'success', title: 'Done!', text: 'Student enrolled successfully', timer: 1500, showConfirmButton: false });
                        stdTable.ajax.reload();
                        $('#studentSelect').val(null).trigger('change');
                    }
                });
            });
        });

        // Remove Instructor
        function removeInstructor(id) {
            Swal.fire({
                title: 'Are you sure?',
                text: "You want to remove this instructor?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.get(`/Admin/Course/RemoveInstructor?instructorId=${id}&courseId=${$('#courseId').val()}`, function () {
                        $('#instructorsCourseTable').DataTable().ajax.reload();
                        Swal.fire('Deleted!', 'Instructor removed successfully.', 'success');
                    });
                }
            });
        }

        // Remove Student
        function removeStudent(id) {
            Swal.fire({
                title: 'Are you sure?',
                text: "You want to remove this student?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, remove!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.get(`/Admin/Course/RemoveStudent?studentId=${id}&courseId=${$('#courseId').val()}`, function () {
                        $('#studentsCourseTable').DataTable().ajax.reload();
                        Swal.fire('Removed!', 'Student removed successfully.', 'success');
                    });
                }
            });
        }
    </script>
}
