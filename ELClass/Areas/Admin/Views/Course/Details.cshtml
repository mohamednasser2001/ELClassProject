@using ELClass.services
@using Models.ViewModels.Course
@model CourseDetailsVM

@{
    
    var isArabic = CultureHelper.IsArabic;
    var direction = isArabic ? "rtl" : "ltr";
}

<div class="container-fluid py-4" style="direction:@direction">
    <input type="hidden" id="courseId" value="@Model.Course.Id" />

    <div class="page-header mb-4">
        <h2>
            <i class="fas fa-book-open icon-primary me-2"></i>
            @(isArabic? Model.Course.TitleAr : Model.Course.TitleEn)
        </h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/Admin/Course" class="text-muted">@(isArabic ? "الكورسات" : "Courses")</a></li>
                <li class="breadcrumb-item active text-orange">@(isArabic ? "التفاصيل" : "Details")</li>
            </ol>
        </nav>
    </div>

    <div class="row mb-4">
        <div class="col-6 col-md-3">
            <a href="#ins">
                <div class="stat-card text-center">
                    <i class="fas fa-user fa-2x mb-2"></i>
                    <h3 class="text-white">@Model.InstructorCourses.Count()</h3>
                    <p>@(isArabic ? "المحاضرين" : "Instructors")</p>
                </div>
            </a>
        </div>
        <div class="col-6 col-md-3">
            <a href="#std">
                <div class="stat-card text-center">
                    <i class="fas fa-user-graduate fa-2x mb-2"></i>
                    <h3 class="text-white">@Model.StudentCourses.Count()</h3>
                    <p>@(isArabic ? "الطلاب" : "Students")</p>
                </div>
            </a>
        </div>
        <div class="col-6 col-md-3">
            <a href="/Instructor/course/details/@Model.Course.Id">
                <div class="stat-card text-center">
                    <i class="fas fa-book fa-2x mb-2"></i>
                    <h3 class="text-white">@ViewBag.LessonNumbers</h3>
                    <p>@(isArabic ? "الدروس" : "Lessons")</p>
                </div>
            </a>
        </div>

       

    </div>

    
        
    

    <div id="ins" class="card custom-card mb-4">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-chalkboard-instructor icon-primary"></i>
                @(isArabic ? "المحاضرين المعينين" : "Assigned Instructors")
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive mb-3">
                <table id="instructorsCourseTable" class="table admin-table w-100">
                    <thead>
                        <tr>
                            <th style="text-align: @(isArabic ? "right" : "left")">#</th>
                            <th style="text-align: @(isArabic ? "right" : "left")">@(isArabic ? "الاسم" : "Name")</th>
                            <th class="text-center">@(isArabic ? "التحكم" : "Actions")</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="assign-section mt-3">
                <label class="fw-bold small mb-2"><i class="fas fa-plus-circle text-orange"></i> @(isArabic ? "تعيين محاضر" : "Assign Instructor")</label>
                <div class="row g-2">
                    <div class="col-md-9">
                        <select id="instructorSelect" class="form-control"></select>
                    </div>
                    <div class="col-md-3">
                        <button id="assignInstructorBtn" class="btn btn-orange-custom w-100">
                            <i class="fas fa-plus"></i> @(isArabic ? "تعيين" : "Assign")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card custom-card">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-user-graduate icon-primary"></i>
                @(isArabic ? "الطلاب المسجلين" : "Enrolled Students")
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive mb-3">
                <table id="studentsCourseTable" class="table admin-table w-100">
                    <thead>
                        <tr>
                            <th style="text-align: @(isArabic ? "right" : "left")">#</th>
                            <th style="text-align: @(isArabic ? "right" : "left")">@(isArabic ? "الاسم" : "Name")</th>
                            <th class="text-center">@(isArabic ? "التحكم" : "Actions")</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="assign-section mt-3">
                <label class="fw-bold small mb-2"><i class="fas fa-user-plus text-orange"></i> @(isArabic ? "تسجيل طالب" : "Enroll Student")</label>
                <div class="row g-2">
                    <div class="col-md-9">
                        <select id="studentSelect" class="form-control"></select>
                    </div>
                    <div class="col-md-3">
                        <button id="enrollStudentBtn" class="btn btn-orange-custom w-100">
                            <i class="fas fa-plus"></i> @(isArabic ? "تسجيل" : "Enroll")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {
            const courseId = $('#courseId').val();
            const isAr = @isArabic.ToString().ToLower();

            const insTable = $('#instructorsCourseTable').DataTable({
                processing: true,
                serverSide: true,
                ordering: false,
                stateSave: true,
                responsive: true,
                language: {
                    url: isAr ? "//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json" : ""
                },
                ajax: {
                    url: '/Admin/Course/GetCourseInstructors',
                    type: 'POST',
                    data: function (d) { d.courseId = courseId; }
                },
                columns: [
                    { data: null, render: (d, t, r, m) => m.row + 1 + m.settings._iDisplayStart },
                    { data: 'name', render: function (data, type, row) {
                    return `<a href="/Admin/Instructor/Details/${row.instructorId}" class="Instructor-link">
                        <i class="fas fa-chalkboard-instructor me-1 icon-primary" style="opacity:0.7"></i> ${data}
                        </a>`;
                     }
                    },
                    {
                        data: 'instructorId',
                        className: 'text-center',
                        render: (id) => `
                            <div class="action-buttons justify-content-center">
                                <a href="/Admin/Instructor/Details/${id}" class="btn btn-sm btn-light border"><i class="fas fa-eye text-primary"></i></a>
                                <button class="btn btn-sm btn-light border" onclick="removeInstructor('${id}')"><i class="fas fa-trash text-danger"></i></button>
                            </div>`
                    }
                ]
            });

            const stdTable = $('#studentsCourseTable').DataTable({
                processing: true,
                serverSide: true,
                ordering: false,
                stateSave: true,
                responsive: true,
                language: {
                    url: isAr ? "//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json" : ""
                },
                ajax: {
                    url: '/Admin/Course/GetCourseStudents',
                    type: 'POST',
                    data: function (d) { d.courseId = courseId; }
                },
                columns: [
                    { data: null, render: (d, t, r, m) => m.row + 1 + m.settings._iDisplayStart },
                    { data: 'name' ,
                    render: function (data, type, row) {
                        return `<a href="/Admin/Student/Details/${row.studentId}" class="student-link">
                                <i class="fas fa-user-circle me-1 icon-primary" style="opacity:0.7"></i> ${data}
                                </a>`;
                    }
                    },
                    {
                        data: 'studentId',
                        className: 'text-center',
                        render: (id) => `
                            <div class="action-buttons justify-content-center">
                                <a href="/Admin/Student/Details/${id}" class="btn btn-sm btn-light border"><i class="fas fa-eye text-primary"></i></a>
                                <button class="btn btn-sm btn-light border" onclick="removeStudent('${id}')"><i class="fas fa-trash text-danger"></i></button>
                            </div>`
                    }
                ]
            });

            $('#instructorSelect').select2({
                placeholder: isAr ? "ابحث عن محاضر..." : "Search Instructor...",
                width: '100%',
                ajax: {
                    url: '/Admin/Course/SearchInstructors',
                    dataType: 'json',
                    data: p => ({ term: p.term, courseId: courseId }),
                    processResults: d => ({ results: d })
                }
            });

            $('#studentSelect').select2({
                placeholder: isAr ? "ابحث عن طالب..." : "Search Student...",
                width: '100%',
                ajax: {
                    url: '/Admin/Course/SearchStudents',
                    dataType: 'json',
                    data: p => ({ term: p.term, courseId: courseId }),
                    processResults: d => ({ results: d })
                }
            });

            $('#assignInstructorBtn').click(() => {
                const id = $('#instructorSelect').val();
                if (!id) return;
                $.post('/Admin/Course/AssignInstructor', { courseId, InstructorId: id }, res => {
                    if (res.success) {
                        Swal.fire({ icon: 'success', title: isAr ? 'تم!' : 'Done!', text: isAr ? 'تم تعيين المحاضر بنجاح' : 'Instructor assigned successfully', timer: 1500, showConfirmButton: false });
                        insTable.ajax.reload();
                        $('#instructorSelect').val(null).trigger('change');
                    }
                });
            });

            $('#enrollStudentBtn').click(() => {
                const id = $('#studentSelect').val();
                if (!id) return;
                $.post('/Admin/Course/AssignStudent', { courseId, studentId: id }, res => {
                    if (res.success) {
                        Swal.fire({ icon: 'success', title: isAr ? 'تم!' : 'Done!', text: isAr ? 'تم تسجيل الطالب بنجاح' : 'Student enrolled successfully', timer: 1500, showConfirmButton: false });
                        stdTable.ajax.reload();
                        $('#studentSelect').val(null).trigger('change');
                    }
                });
            });
        });

        function removeInstructor(id) {
            const isAr = @isArabic.ToString().ToLower();
            Swal.fire({
                title: isAr ? 'هل أنت متأكد؟' : 'Are you sure?',
                text: isAr ? 'هل تريد إزالة هذا المحاضر؟' : "You want to remove this instructor?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: isAr ? 'نعم، احذف!' : 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.get(`/Admin/Course/RemoveInstructor?instructorId=${id}&courseId=${$('#courseId').val()}`, function () {
                        $('#instructorsCourseTable').DataTable().ajax.reload();
                        Swal.fire(isAr ? 'تم الحذف!' : 'Deleted!', isAr ? 'تمت إزالة المحاضر بنجاح.' : 'Instructor removed successfully.', 'success');
                    });
                }
            });
        }

        function removeStudent(id) {
            const isAr = @isArabic.ToString().ToLower();
            Swal.fire({
                title: isAr ? 'هل أنت متأكد؟' : 'Are you sure?',
                text: isAr ? 'هل تريد إزالة هذا الطالب؟' : "You want to remove this student?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: isAr ? 'نعم، إزالة!' : 'Yes, remove!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.get(`/Admin/Course/RemoveStudent?studentId=${id}&courseId=${$('#courseId').val()}`, function () {
                        $('#studentsCourseTable').DataTable().ajax.reload();
                        Swal.fire(isAr ? 'تمت الإزالة!' : 'Removed!', isAr ? 'تمت إزالة الطالب بنجاح.' : 'Student removed successfully.', 'success');
                    });
                }
            });
        }

        

    </script>
}