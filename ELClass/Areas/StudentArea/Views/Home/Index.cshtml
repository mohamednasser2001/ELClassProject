@using Models
@using System.Text.RegularExpressions
@inject Microsoft.AspNetCore.Identity.UserManager<ApplicationUser> _userManager
@model Models.ViewModels.StudentDashboardVM

@{
    Layout = "_StudentLayout";
}

<!-- Topbar -->
<header class="topbar">
    <div class="topbar__left">
        <h1 class="page-title">لوحة الطالب</h1>
        <p class="page-subtitle">نظرة سريعة على تقدمك ومهامك</p>
    </div>

    <div class="topbar__right">
        <button class="icon-btn" type="button" aria-label="Notifications">🔔</button>
        @{
            var currentUser = await _userManager.GetUserAsync(User);

            var rawName = currentUser?.NameAR
                ?? currentUser?.NameEN
                ?? currentUser?.UserName
                ?? "Student";

            var displayName = Regex.Replace(rawName, "([a-z])([A-Z])", "$1 $2");

            var nameParts = displayName.Split(' ', StringSplitOptions.RemoveEmptyEntries);

            var initials = nameParts.Length >= 2
                ? $"{nameParts[0][0]}{nameParts[1][0]}"
                : nameParts.Length == 1
                    ? $"{nameParts[0][0]}"
                    : "S";

            var profileImage = !string.IsNullOrEmpty(currentUser?.Img)
                ? Url.Content("~/Images/Users/" + currentUser.Img)
                : null;
        }

        <div class="user">
            @if (!string.IsNullOrWhiteSpace(profileImage))
            {
                <img class="user__avatar" src="@profileImage" alt="Student avatar" />
            }
            else
            {
                <div class="user__avatar user__avatar--initials">
                    @initials
                </div>
            }

            <div class="user__meta">
                <div class="user__name">
                    <span class="hello">Hello</span> @displayName
                </div>
            
            </div>
        </div>
    </div>
</header>

<!-- Stats -->
<section class="stats">
    <article class="stat-card">
        <div class="stat-card__icon">🧾</div>
        <div class="stat-card__body">
            <div class="stat-card__label">إجمالي الدروس</div>
            <div class="stat-card__value">12</div>
            <div class="stat-card__hint">هذا الأسبوع</div>
        </div>
    </article>

    <article class="stat-card">
        <div class="stat-card__icon">✅</div>
        <div class="stat-card__body">
            <div class="stat-card__label">المهام المنتهية</div>
            <div class="stat-card__value">5</div>
            <div class="stat-card__hint">آخر 7 أيام</div>
        </div>
    </article>

    <article class="stat-card">
        <div class="stat-card__icon">📈</div>
        <div class="stat-card__body">
            <div class="stat-card__label">مستوى التقدم</div>
            <div class="stat-card__value">85%</div>
            <div class="stat-card__hint">متوسط عام</div>
        </div>
    </article>

    <article class="stat-card">
        <div class="stat-card__icon">🔔</div>
        <div class="stat-card__body">
            <div class="stat-card__label">إشعارات جديدة</div>
            <div class="stat-card__value">3</div>
            <div class="stat-card__hint">اليوم</div>
        </div>
    </article>
</section>

<!-- Content Grid -->
<section class="grid">
    <!-- Courses Progress -->
    <div class="panel panel--courses" style="grid-area:courses;">
        <div class="panel__header">
            <h2 class="panel__title">مقرراتي الدراسية</h2>
            <a class="panel__link" href="#">عرض الكل</a>
        </div>
        <div class="courses">
            @if (Model?.Courses != null && Model.Courses.Any())
            {
                var i = 0;

                foreach (var c in Model.Courses)
                {
                    // عنوان الكورس (AR لو موجود)
                    var title = c.CourseTitleAr ?? c.CourseTitleEn ?? "Course";

                    // أيقونة بسيطة حسب الترتيب (مؤقتًا)
                    string icon = (i % 4) switch
                    {
                        0 => "📘",
                        1 => "🌍",
                        2 => "➗",
                        _ => "🧪"
                    };

                    i++;

                    <article class="course-card">
                        <div class="course-card__media">@icon</div>

                        <div class="course-card__body">
                            <div class="course-card__name">@title</div>

                            <!-- مؤقتًا: Progress ثابت لحد ما نربطه بالداتا -->
                            <div class="progress">
                                <div class="progress__bar" style="width:@c.ProgressPercent%;"></div>
                            </div>

                            <div class="course-card__meta">
                                <span>@c.ProgressPercent%</span>
                                <span>@c.AttendedCount / @c.GoalCount حصة</span>
                            </div>

                            <a class="course-card__action"
                               asp-area="StudentArea"
                               asp-controller="Courses"
                               asp-action="Details"
                               asp-route-id="@c.CourseId">
                                عرض المزيد
                            </a>
                        </div>
                    </article>
                }
            }
            else
            {
                <div style="padding:16px; color: var(--muted);">
                    لا يوجد مقررات حالياً.
                </div>
            }
        </div>

    </div>

    <!-- Join Online Lecture -->
    <div class="panel panel--join" style="grid-area:join;">
        <div class="join">
            <h2 class="join__title">الانضمام إلى محاضرة عبر الإنترنت</h2>
            <p class="join__text">اضغط للانضمام بسرعة أو حجز موعد.</p>

            <div class="join__actions">
                <a class="btn btn--primary" href="#">انضم الآن</a>
                <a class="btn btn--outline" href="#">حجز موعد</a>
            </div>
        </div>
    </div>

    <!-- Schedule -->
    <div class="panel panel--schedule" style="grid-area:schedule;">
        <div class="panel__header">
            <h2 class="panel__title">جدولي</h2>
            <a class="panel__link" href="#">عرض</a>
        </div>

        <ul class="schedule">
            <li class="schedule__item">
                <div class="schedule__time">10:00 - 11:30</div>
                <div class="schedule__info">
                    <div class="schedule__title">محاضرة رياضيات</div>
                    <div class="schedule__sub">أ/ محمد</div>
                </div>
                <span class="badge badge--upcoming">قادم</span>
            </li>

            <li class="schedule__item">
                <div class="schedule__time">01:00 - 02:30</div>
                <div class="schedule__info">
                    <div class="schedule__title">محاضرة عربي</div>
                    <div class="schedule__sub">أ/ أحمد</div>
                </div>
                <span class="badge badge--upcoming">قادم</span>
            </li>

            <li class="schedule__item">
                <div class="schedule__time">04:00 - 05:00</div>
                <div class="schedule__info">
                    <div class="schedule__title">محاضرة علوم</div>
                    <div class="schedule__sub">أ/ سارة</div>
                </div>
                <span class="badge badge--done">تم</span>
            </li>
        </ul>
    </div>

    <!-- Current Tasks -->
    <div class="panel panel--tasks" style="grid-area:tasks;">
        <div class="panel__header">
            <h2 class="panel__title">المهام الحالية</h2>
            <a class="panel__link" href="#">عرض الكل</a>
        </div>

        <ul class="tasks">
            <li class="task">
                <span class="task__icon">📝</span>
                <div class="task__body">
                    <div class="task__title">تسليم واجب اللغة العربية 1</div>
                    <div class="task__meta">موعد: 10:00 ص - اليوم</div>
                </div>
                <span class="badge badge--urgent">هام</span>
            </li>

            <li class="task">
                <span class="task__icon">📌</span>
                <div class="task__body">
                    <div class="task__title">مذاكرة درس العلوم</div>
                    <div class="task__meta">موعد: 05:00 م - غدًا</div>
                </div>
            </li>

            <li class="task">
                <span class="task__icon">✅</span>
                <div class="task__body">
                    <div class="task__title">حل اختبار رياضيات قصير</div>
                    <div class="task__meta">موعد: 11:59 م - الجمعة</div>
                </div>
            </li>
        </ul>
    </div>
</section>

<footer class="footer">
    © 2026 EduDash. All rights reserved.
</footer>



@* Chat Widget (Student) *@
<button id="chatFab" class="chat-fab" type="button" aria-label="Open chat">
    <span class="chat-fab-icon" aria-hidden="true">
        <i class="fab fa-whatsapp"></i>
    </span>
    <span id="chatFabBadge" class="chat-fab-badge hidden">0</span>
</button>

<div id="chatWidget" class="chat-widget" aria-hidden="true">
    <div class="chat-header">
        <div class="header-left">
            <button id="chatBackBtn" class="chat-btn-icon hidden" type="button" aria-label="Back">←</button>
            <div class="title" id="chatHeaderTitle">
                <div id="chatHeaderName">Chats</div>
                <div id="chatHeaderStatus" class="chat-status"></div>
            </div>
        </div>
        <div class="actions">
            <button class="chat-btn-icon" id="chatCloseBtn" type="button" aria-label="Close">✕</button>
        </div>
    </div>

    @* Screen 1: List *@
    <div class="chat-screen" id="screenList">
        <div class="chat-search">
            <input id="chatSearch" type="text" placeholder="Search instructors..." autocomplete="off" />
        </div>
        <div class="chat-items" id="chatItems"></div>
    </div>

    @* Screen 2: Thread *@
    <div class="chat-screen hidden" id="screenThread">
        <div class="messages" id="messagesBox"></div>

        <div class="composer">
            <input id="chatInput" type="text" placeholder="Type a message..." autocomplete="off" />
            <button id="sendBtn" type="button" aria-label="Send">➤</button>
        </div>
    </div>
</div>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

    <input type="hidden" id="currentUserId" value="@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value" />

    <script>
        // =========================
        // Config (endpoints)
        // =========================
        const API = {
            conversations: '/StudentArea/Home/GetMyConversations',
            history: '/StudentArea/Home/GetChatHistory',
            save: '/StudentArea/Home/SaveMessage',
            markRead: '/StudentArea/Home/MarkAsRead'
        };

        // =========================
        // Elements
        // =========================
        const chatFab = document.getElementById('chatFab');
        const chatFabBadge = document.getElementById('chatFabBadge');
        const chatWidget = document.getElementById('chatWidget');
        const chatCloseBtn = document.getElementById('chatCloseBtn');
        const chatBackBtn = document.getElementById('chatBackBtn');
        const chatHeaderTitle = document.getElementById('chatHeaderTitle');

        const screenList = document.getElementById('screenList');
        const screenThread = document.getElementById('screenThread');

        const chatSearch = document.getElementById('chatSearch');
        const chatItemsBox = document.getElementById('chatItems');

        const messagesBox = document.getElementById('messagesBox');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        const currentUserId = document.getElementById('currentUserId')?.value;

        // ✅ Header elements (Student)
        const headerNameEl = document.getElementById("chatHeaderName");
        const headerStatusEl = document.getElementById("chatHeaderStatus");

        // =========================
        // State
        // =========================
        const state = {
            isOpen: false,
            currentInstructorId: null,
            currentInstructorName: '',
            conversationId: null,
            conversationsCache: [],

            take: 10,
            hasMore: true,
            oldestId: null,
            isLoadingOlder: false
        };

        // =========================
        // Audio (unused حاليا)
        // =========================
        let audioReady = false;
        let audioCtx = null;

        function initAudio() {
            if (audioReady) return;
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                audioReady = true;
            } catch {
                audioReady = false;
            }
        }

        // =========================
        // FAB Badge + Pulse
        // =========================
        function setFabUnread(count) {
            const n = Math.max(0, parseInt(count || 0));
            if (!chatFabBadge) return;

            if (n === 0) {
                chatFabBadge.classList.add('hidden');
                chatFab.classList.remove('pulse');
                chatFabBadge.textContent = '0';
            } else {
                chatFabBadge.classList.remove('hidden');
                chatFabBadge.textContent = (n > 99) ? '99+' : String(n);
                chatFab.classList.add('pulse');
            }
        }

        function calcTotalUnread() {
            return (state.conversationsCache || []).reduce((sum, c) => sum + (c.unread || 0), 0);
        }

        function syncFabUnreadFromList() {
            setFabUnread(calcTotalUnread());
        }

        // =========================
        // UI Helpers
        // =========================
        function escapeHtml(str) {
            return (str ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", "&#039;");
        }

        function toTime(sentAt) {
            if (!sentAt) return '';
            const d = new Date(sentAt);
            if (Number.isNaN(d.getTime())) return '';
            return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function initials(name) {
            const s = (name ?? '').trim();
            if (!s) return 'IN';
            const parts = s.split(/\s+/).filter(Boolean);
            const first = parts[0]?.[0] ?? 'I';
            const second = (parts.length > 1 ? parts[1]?.[0] : parts[0]?.[1]) ?? 'N';
            return (first + second).toUpperCase();
        }

        // =========================
        // ✅ Presence helpers
        // =========================
        const presenceMap = new Map();

        function setHeaderStatus(isOnline) {
            if (!headerStatusEl) return;

            headerStatusEl.textContent = isOnline ? "● Online" : "● Offline";
            headerStatusEl.classList.toggle("online", !!isOnline);
            headerStatusEl.classList.toggle("offline", !isOnline);
        }

        // =========================
        // Open / Close
        // =========================
        function showWidget() {
            state.isOpen = true;

            chatWidget.classList.add('open');
            chatWidget.setAttribute('aria-hidden', 'false');
            chatFab.style.display = 'none';

            showListScreen();
            loadMyConversations();
        }

        function hideWidget() {
            state.isOpen = false;

            chatWidget.classList.remove('open');
            chatWidget.setAttribute('aria-hidden', 'true');
            chatFab.style.display = 'block';

            state.currentInstructorId = null;
            state.currentInstructorName = '';
            state.conversationId = null;

            state.hasMore = true;
            state.oldestId = null;
            state.isLoadingOlder = false;

            messagesBox.innerHTML = '';
            chatInput.value = '';
            chatSearch.value = '';

            if (headerNameEl) headerNameEl.textContent = "Chats";
            if (headerStatusEl) headerStatusEl.textContent = "";
        }

        function showListScreen() {
            screenThread.classList.add('hidden');
            screenList.classList.remove('hidden');
            chatBackBtn.classList.add('hidden');

            if (headerNameEl) headerNameEl.textContent = "Chats";
            if (headerStatusEl) headerStatusEl.textContent = "";

            state.currentInstructorId = null;
            state.currentInstructorName = '';
            state.conversationId = null;

            state.hasMore = true;
            state.oldestId = null;
            state.isLoadingOlder = false;

            messagesBox.innerHTML = '';
        }

        function showThreadScreen(instructorName) {
            screenList.classList.add('hidden');
            screenThread.classList.remove('hidden');
            chatBackBtn.classList.remove('hidden');

            if (headerNameEl) headerNameEl.textContent = instructorName || "Chat";
        }

        function setActiveItem(instructorId) {
            document.querySelectorAll('.chat-item').forEach(x => {
                x.classList.toggle('active', x.dataset.instructorId === instructorId);
            });
        }

        function findItem(instructorId) {
            return document.querySelector(`.chat-item[data-instructor-id="${CSS.escape(instructorId)}"]`);
        }

        function removeBadge(instructorId) {
            const item = findItem(instructorId);
            if (!item) return;
            const badge = item.querySelector('.badge');
            if (badge) badge.remove();
        }

        function incrementBadge(instructorId) {
            const item = findItem(instructorId);
            if (!item) return;

            let badge = item.querySelector('.badge');
            if (!badge) {
                badge = document.createElement('div');
                badge.className = 'badge';
                badge.textContent = '1';
                item.appendChild(badge);
            } else {
                badge.textContent = (parseInt(badge.textContent || '0') + 1).toString();
            }
        }

        // =========================
        // Conversations
        // =========================
        async function loadMyConversations() {
            try {
                const res = await fetch(API.conversations);
                const data = await res.json();

                state.conversationsCache = Array.isArray(data) ? data : [];
                renderConversations(state.conversationsCache);

                syncFabUnreadFromList();

            } catch (e) {
                console.error(e);
                chatItemsBox.innerHTML = `<div class="empty">Failed to load chats</div>`;
            }
        }

        // ✅✅ FIX HERE: apply presenceMap when rendering list
        function renderConversations(list) {
            chatItemsBox.innerHTML = '';

            if (!list || list.length === 0) {
                chatItemsBox.innerHTML = `<div class="empty">No chats yet</div>`;
                return;
            }

            for (const c of list) {
                const idStr = String(c.instructorId ?? '');
                const name = c.instructorName ?? 'Instructor';
                const preview = c.lastMessage ?? '';
                const unread = c.unread ?? 0;

                const avatarHtml = c.photoUrl
                    ? `<img class="avatar-img" src="${escapeHtml(c.photoUrl)}" alt="${escapeHtml(name)}" />`
                    : `<div class="avatar-text">${escapeHtml(initials(name))}</div>`;

                const unreadHtml = unread > 0 ? `<div class="badge">${unread}</div>` : '';

                // 👇 أهم سطر: خُد الحالة من الكاش بدل default offline
                const isOnline = presenceMap.get(idStr) === true;
                const dotClass = isOnline ? 'online' : 'offline';

                chatItemsBox.insertAdjacentHTML('beforeend', `
                                            <div class="chat-item"
                                                 data-instructor-id="${escapeHtml(idStr)}"
                                                 data-instructor-name="${escapeHtml(name)}">
                                                 <div class="avatar">
                                                    ${avatarHtml}
                                                    <span class="presence-dot ${dotClass}" data-presence-id="${escapeHtml(idStr)}"></span>
                                                </div>
                                                <div class="meta">
                                                    <div class="name">${escapeHtml(name)}</div>
                                                    <div class="preview">${escapeHtml(preview)}</div>
                                                </div>
                                                ${unreadHtml}
                                            </div>
                                        `);
            }

            if (state.currentInstructorId) setActiveItem(state.currentInstructorId);
        }

        chatItemsBox.addEventListener('click', (e) => {
            const item = e.target.closest('.chat-item');
            if (!item) return;

            const instructorId = item.dataset.instructorId;
            const instructorName = item.dataset.instructorName;

            openChat(instructorId, instructorName);
        });

        chatSearch.addEventListener('input', () => {
            const q = (chatSearch.value ?? '').trim().toLowerCase();
            const filtered = !q
                ? state.conversationsCache
                : state.conversationsCache.filter(x => (x.instructorName ?? '').toLowerCase().includes(q));

            renderConversations(filtered);

            // ✅ لو فاتح شات بالفعل خلي الـactive ثابت
            if (state.currentInstructorId) setActiveItem(state.currentInstructorId);
        });

        async function openChat(instructorId, instructorName) {
            state.currentInstructorId = instructorId;
            state.currentInstructorName = instructorName;

            setActiveItem(instructorId);
            showThreadScreen(instructorName);

            await loadChatHistoryFirstPage();

            await markAsRead(instructorId);
            scheduleMarkAsReadHub();

            removeBadge(instructorId);

            await loadMyConversations();

            messagesBox.scrollTop = messagesBox.scrollHeight;

            // ✅ Presence for header
            try {
                if (headerNameEl) headerNameEl.textContent = instructorName || "Chat";

                const cached = presenceMap.get(String(state.currentInstructorId));
                if (cached !== undefined) {
                    setHeaderStatus(cached);
                    return;
                }

                const isOnline = await studentConnection.invoke("IsUserOnline", state.currentInstructorId);
                presenceMap.set(String(state.currentInstructorId), !!isOnline);
                setHeaderStatus(!!isOnline);

            } catch (e) {
                console.error("IsUserOnline invoke error:", e);
            }
        }

        async function markAsRead(instructorId) {
            try {
                await fetch(API.markRead, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
                    body: new URLSearchParams({ instructorId })
                });
            } catch (e) {
                console.error(e);
            }
        }

        // =========================
        // Chat History (Cursor paging)
        // =========================
        async function loadChatHistoryFirstPage() {
            messagesBox.innerHTML = '';

            state.hasMore = true;
            state.oldestId = null;
            state.isLoadingOlder = false;

            await loadOlderMessages();
        }

        async function loadOlderMessages() {
            if (!state.currentInstructorId) return;
            if (!state.hasMore || state.isLoadingOlder) return;

            state.isLoadingOlder = true;

            const prevScrollHeight = messagesBox.scrollHeight;
            const prevScrollTop = messagesBox.scrollTop;

            const url =
                `${API.history}?instructorId=${encodeURIComponent(state.currentInstructorId)}`
                + `&take=${state.take}`
                + (state.oldestId ? `&beforeId=${state.oldestId}` : ``);

            try {
                const res = await fetch(url);
                const data = await res.json();

                const list = data.messages ?? [];
                state.conversationId = data.conversationId ?? null;
                state.hasMore = data.hasMore === true;

                if (list.length === 0) {
                    state.isLoadingOlder = false;
                    return;
                }

                const frag = document.createDocumentFragment();
                for (const m of list) frag.appendChild(messageNode(m));
                messagesBox.prepend(frag);

                state.oldestId = list[0].id;

                const newScrollHeight = messagesBox.scrollHeight;
                messagesBox.scrollTop = (newScrollHeight - prevScrollHeight) + prevScrollTop;

            } catch (e) {
                console.error(e);
            } finally {
                state.isLoadingOlder = false;
            }
        }

        messagesBox.addEventListener('scroll', () => {
            if (messagesBox.scrollTop <= 10) {
                loadOlderMessages();
            }

            if (messagesBox.scrollTop + messagesBox.clientHeight >= messagesBox.scrollHeight - 6) {
                scheduleMarkAsReadHub();
            }
        });

        // =========================
        // ✓✓ Ticks (Student)
        // =========================
        function ticksHtml(isMine, isRead) {
            if (!isMine) return '';
            const cls = isRead ? 'ticks read' : 'ticks';
            return `<span class="${cls}" title="${isRead ? 'Read' : 'Sent'}">✓✓</span>`;
        }

        function messageNode(m) {
            const id = (m.id ?? m.Id ?? '');
            const senderId = (m.senderId ?? m.SenderId ?? '');
            const receiverId = (m.receiverId ?? m.ReceiverId ?? '');
            const content = (m.content ?? m.Content ?? '');
            const sentAt = (m.sentAt ?? m.SentAt);
            const isRead = (m.isRead ?? m.IsRead) === true;

            const isMine = currentUserId && senderId === currentUserId;

            const wrapper = document.createElement('div');
            wrapper.className = `msg-row ${isMine ? 'mine' : ''}`;
            wrapper.dataset.messageId = String(id || '');

            wrapper.innerHTML = `
                                        <div class="bubble">
                                            ${escapeHtml(content)}
                                            <span class="time">
                                                ${escapeHtml(toTime(sentAt))}
                                                ${ticksHtml(isMine, isRead)}
                                            </span>
                                        </div>
                                    `;
            return wrapper;
        }

        function renderMessage(m) {
            const node = messageNode(m);
            messagesBox.appendChild(node);
            return node;
        }

        function markMessagesReadInUI(messageIds) {
            if (!Array.isArray(messageIds) || messageIds.length === 0) return;

            messageIds.forEach(id => {
                const row = messagesBox.querySelector(`.msg-row.mine[data-message-id="${CSS.escape(String(id))}"]`);
                const tick = row?.querySelector('.ticks');
                if (tick) {
                    tick.classList.add('read');
                    tick.title = 'Read';
                }
            });
        }

        // =========================
        // Send Message (Student)
        // =========================
        async function sendMessageFromUI() {
            const text = (chatInput.value || '').trim();
            if (!state.currentInstructorId || !text) return;

            const nowIso = new Date().toISOString();
            const tempId = `tmp-${Date.now()}`;

            const optimisticNode = renderMessage({
                id: tempId,
                senderId: currentUserId,
                receiverId: state.currentInstructorId,
                content: text,
                sentAt: nowIso,
                isRead: false
            });

            messagesBox.scrollTop = messagesBox.scrollHeight;
            chatInput.value = '';

            const item = findItem(state.currentInstructorId);
            if (item) {
                const previewEl = item.querySelector('.preview');
                if (previewEl) previewEl.textContent = text;
            }

            try {
                const res = await fetch(API.save, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
                    body: new URLSearchParams({ receiverId: state.currentInstructorId, content: text })
                });

                const data = await res.json();
                if (!data || data.success !== true) {
                    console.log('SaveMessage failed:', data);
                    return;
                }

                const realId = data.id ?? data.messageId ?? data.savedMessageId ?? data.data?.id;
                if (realId && optimisticNode) {
                    optimisticNode.dataset.messageId = String(realId);
                }

                await sendRealtimeToInstructor(state.currentInstructorId, text);

            } catch (e) {
                console.error(e);
            }
        }

        sendBtn.addEventListener('click', sendMessageFromUI);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessageFromUI();
        });

        // =========================
        // Open/Close/Back
        // =========================
        chatFab.addEventListener('click', () => {
            initAudio();
            showWidget();
        });

        chatCloseBtn.addEventListener('click', hideWidget);
        chatBackBtn.addEventListener('click', showListScreen);

        // =========================
        // SignalR (Student)
        // =========================
        const studentConnection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .withAutomaticReconnect()
            .build();

        // ✅ PresenceChanged
        studentConnection.on("PresenceChanged", function (userId, isOnline) {
            const id = String(userId);
            presenceMap.set(id, !!isOnline);

            // لو الشات مفتوح على نفس المدرس حدّث الهيدر
            if (state.currentInstructorId && String(state.currentInstructorId) === id) {
                setHeaderStatus(!!isOnline);
            }

            // ✅ حدّث الدوت في الليست
            const dot = document.querySelector(
                `.presence-dot[data-presence-id="${CSS.escape(id)}"]`
            );
            if (dot) {
                dot.classList.toggle("online", !!isOnline);
                dot.classList.toggle("offline", !isOnline);
            }
        });

        studentConnection.onreconnected(async () => {
            if (!state.currentInstructorId) return;
            try {
                const isOnline = await studentConnection.invoke("IsUserOnline", state.currentInstructorId);
                presenceMap.set(String(state.currentInstructorId), !!isOnline);
                setHeaderStatus(!!isOnline);
            } catch (e) {
                console.error("Reconnected IsUserOnline error:", e);
            }
        });

        studentConnection.start()
            .then(() => console.log("SignalR Connected (Student)!"))
            .catch(err => console.error(err.toString()));

        let readDebounceTimer = null;
        function scheduleMarkAsReadHub() {
            clearTimeout(readDebounceTimer);
            readDebounceTimer = setTimeout(() => {
                if (!state.isOpen) return;
                if (!state.conversationId) return;
                if (!state.currentInstructorId) return;

                studentConnection.invoke("MarkAsRead", state.conversationId, state.currentInstructorId)
                    .catch(err => console.error("MarkAsRead invoke error:", err));
            }, 200);
        }

        studentConnection.on("ReceiveMessage", async function (senderId, message, timestamp) {
            const sameOpenChat = state.isOpen && state.currentInstructorId && senderId === state.currentInstructorId;

            if (sameOpenChat) {
                renderMessage({
                    senderId: senderId,
                    receiverId: currentUserId,
                    content: message,
                    sentAt: timestamp
                });

                messagesBox.scrollTop = messagesBox.scrollHeight;

                scheduleMarkAsReadHub();

                await markAsRead(senderId);
                removeBadge(senderId);

                await loadMyConversations();
                return;
            }

            const item = findItem(senderId);
            if (item) {
                const previewEl = item.querySelector('.preview');
                if (previewEl) previewEl.textContent = message;

                incrementBadge(senderId);

                syncFabUnreadFromList();
                await loadMyConversations();

            } else {
                await loadMyConversations();
            }
        });

        studentConnection.on("MessagesRead", function (payload) {
            if (!payload) return;
            if (!state.isOpen) return;
            if (!state.conversationId) return;

            if (String(payload.conversationId) !== String(state.conversationId)) return;

            markMessagesReadInUI(payload.messageIds);
        });

        studentConnection.on("UpdateConversationList", function () {
            loadMyConversations();
        });

        async function sendRealtimeToInstructor(instructorId, message) {
            try {
                await studentConnection.invoke("SendMessage", instructorId, message);
            } catch (e) {
                console.error(e.toString());
            }
        }
    </script>
}



@section Styles {
    <link rel="stylesheet" href="~/css/ChatMessage.css" asp-append-version="true" />
}





