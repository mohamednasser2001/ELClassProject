@using Models
@inject Microsoft.AspNetCore.Identity.UserManager<ApplicationUser> _userManager

@model Models.ViewModels.StudentDashboardVM


@{
    Layout = "_StudentLayout";
}

<div class="container-fluid py-4" dir="ltr">
    @* سنثبته LTR حالياً ليطابق الصورة *@
    <div class="row">

        <div class="col-lg-3 order-1">
            <div class="card border-0 shadow-sm mb-3" style="border-radius: 15px; overflow: hidden;">
                <div class="p-3 fw-bold text-white" style="background-color: #d35400;">
                    <i class="fas fa-book-open me-2"></i> My Subjects
                </div>
                <div class="list-group list-group-flush">
                    @if (Model.Courses != null && Model.Courses.Any())
                    {
                        @foreach (var coursesVM in Model.Courses)
                        {
                            @* هنا نجعل العنصر رابطاً يوجه إلى CourseController *@
                            <a asp-area="StudentArea"
                               asp-controller="Course"
                               asp-action="Details"
                               asp-route-id="@coursesVM.CourseId"
                               class="list-group-item list-group-item-action small py-3"
                               style="color: #d35400; cursor: pointer; text-decoration: none;">
                                <i class="fas fa-chevron-right me-2" style="font-size: 0.8em;"></i>
                                @coursesVM.CourseTitleEn @* أو CourseTitleAr حسب رغبتك *@
                            </a>
                        }
                    }
                    else
                    {
                        <div class="list-group-item small py-3 text-muted">
                            No courses assigned yet.
                        </div>
                    }
                </div>
            </div>

            <div class="input-group mb-3 shadow-sm" style="border-radius: 10px; overflow: hidden;">
                <input type="text" class="form-control border-0" placeholder="Search ...">
                <span class="input-group-text bg-white border-0 text-muted"><i class="fas fa-search"></i></span>
            </div>

            <div class="card border-0 shadow-sm mb-3" style="border-radius: 15px; overflow: hidden;">
                <div class="p-3 fw-bold" style="background-color: #d5e5db; color: #5d7c6b;">
                    <i class="fas fa-edit me-2"></i> Latest assignments
                </div>
                <div class="p-3">
                    <div class="mb-3 border-bottom pb-2">
                        <div style="color: #5d7c6b; font-weight: 600; font-size: 14px;">Shadowing + Summarization</div>
                        <small class="text-muted">task level 4 -</small>
                    </div>
                    <div class="mb-3 border-bottom pb-2">
                        <div style="color: #5d7c6b; font-weight: 600; font-size: 14px;">task level 4 -</div>
                        <small class="text-muted">task level 4.</small>
                    </div>
                    <div class="pb-2">
                        <div style="color: #5d7c6b; font-weight: 600; font-size: 14px;">task level 4.</div>
                    </div>
                </div>
            </div>

            <div class="p-2">
                <h6 class="fw-bold small text-muted"><i class="far fa-question-circle"></i> Need help?</h6>
                <p class="text-muted" style="font-size: 11px;">Please review our guides and help manuals</p>
            </div>
        </div>

        <div class="col-lg-9 order-2">
            <div class="row g-3">
                <div class="col-lg-5">
                    <div class="card h-100 border-0 p-4 text-center shadow-sm d-flex flex-column justify-content-center"
                         style="background-color: #a3c1ad; border-radius: 25px;">
                        <div class="mb-3 text-white">
                            <i class="fas fa-video fa-3x" style="opacity: 0.7;"></i>
                        </div>
                        <h4 class="text-white fw-bold mb-3">Join online lecture</h4>
                        <p class="text-white small mb-4 px-2">Click to check if an online lecture is currently running. Keep the page open, and it will do this check automatically.</p>
                        <div class="d-flex justify-content-center gap-2">
                            <button class="btn fw-bold px-4" style="background-color: #d35400; color: white; border-radius: 10px;">
                                <i class="fas fa-sync-alt me-1"></i> Check
                            </button>
                            <button class="btn btn-light fw-bold px-4" style="border-radius: 10px; color: #333;">
                                <i class="fas fa-arrow-right me-1"></i> All lectures
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-lg-7">
                    <div class="card border-0 shadow-sm h-100" style="border-radius: 15px; overflow: hidden;">
                        <div class="p-3 border-bottom bg-white d-flex justify-content-between">
                            <span class="fw-bold small text-muted"><i class="far fa-calendar-alt me-1"></i> Upcoming lectures</span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" style="font-size: 13px;">
                                <thead class="bg-light">
                                    <tr class="text-muted">
                                        <th>TIME</th>
                                        <th>subjects</th>
                                        <th>Instructor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="py-3">
                                            <span style="color: #d35400; font-weight: 700;">07/01, 10:00 PM</span><br>
                                            <small class="text-muted">20 hours 22 minutes from now</small>
                                        </td>
                                        <td class="py-3" style="color: #d35400;">Arabic</td>
                                        <td class="py-3">Ahmed mahmoud</td>
                                    </tr>
                                    <tr>
                                        <td class="py-3">
                                            <span style="color: #d35400; font-weight: 700;">11/01, 11:30 PM</span><br>
                                            <small class="text-muted">5 days from now</small>
                                        </td>
                                        <td class="py-3" style="color: #d35400;">English</td>
                                        <td class="py-3">mohamed nasser</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="p-2 text-end bg-light border-top">
                            <a href="#" class="text-danger small text-decoration-none fw-bold me-2">
                                <i class="far fa-calendar-alt"></i> View lecture schedule
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mt-1">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm p-3" style="border-radius: 15px;">
                        <h6 class="fw-bold small text-muted border-bottom pb-2"><i class="fas fa-check-double me-2"></i> Latest tests</h6>
                        <div class="d-flex align-items-center justify-content-between pt-2">
                            <div class="d-flex align-items-center gap-2">
                                <i class="fas fa-check-square text-success"></i>
                                <a href="#" class="text-danger fw-bold small text-decoration-none">Premium Written Placement Test A</a>
                            </div>
                        </div>
                        <div class="ps-4 mt-1">
                            <small class="text-muted" style="font-size: 11px;">
                                <i class="fas fa-laptop me-1"></i> Written (Online) | <i class="far fa-clock me-1"></i> Start at 20/11, 04:23 PM
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm p-3" style="border-radius: 15px;">
                        <h6 class="fw-bold small text-muted border-bottom pb-2"><i class="fas fa-file-alt me-2"></i> Latest assignments</h6>
                        <div class="d-flex justify-content-between align-items-center pt-2">
                            <div class="d-flex align-items-center gap-2">
                                <i class="fas fa-hourglass-half text-warning"></i>
                                <a href="#" class="text-danger fw-bold small text-decoration-none">Shadowing + Summarization</a>
                            </div>
                            <i class="fas fa-chevron-right text-muted"></i>
                        </div>
                        <div class="ps-4 mt-1 text-muted" style="font-size: 11px;">
                            <i class="far fa-clock me-1"></i> 21/12 10:19 PM
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Chat Widget (Student) *@
<button id="chatFab" class="chat-fab" type="button" aria-label="Open chat">
    <span class="chat-fab-icon" aria-hidden="true">
        <i class="fab fa-whatsapp"></i>
    </span>
    <span id="chatFabBadge" class="chat-fab-badge hidden">0</span>
</button>


<div id="chatWidget" class="chat-widget" aria-hidden="true">
    <div class="chat-header">
        <div class="header-left">
            <button id="chatBackBtn" class="chat-btn-icon hidden" type="button" aria-label="Back">←</button>
            <div class="title" id="chatHeaderTitle">Chats</div>
        </div>
        <div class="actions">
            <button class="chat-btn-icon" id="chatCloseBtn" type="button" aria-label="Close">✕</button>
        </div>
    </div>

    @* Screen 1: List *@
    <div class="chat-screen" id="screenList">
        <div class="chat-search">
            <input id="chatSearch" type="text" placeholder="Search instructors..." autocomplete="off" />
        </div>
        <div class="chat-items" id="chatItems"></div>
    </div>

    @* Screen 2: Thread *@
    <div class="chat-screen hidden" id="screenThread">
        <div class="messages" id="messagesBox"></div>

        <div class="composer">
            <input id="chatInput" type="text" placeholder="Type a message..." autocomplete="off" />
            <button id="sendBtn" type="button" aria-label="Send">➤</button>
        </div>
    </div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

    <input type="hidden" id="currentUserId" value="@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value" />

    <script>
        // =========================
        // Config (endpoints)
        // =========================
        const API = {
            conversations: '/StudentArea/Home/GetMyConversations',
            history: '/StudentArea/Home/GetChatHistory',   // ✅ لازم يدعم beforeId + take
            save: '/StudentArea/Home/SaveMessage',
            markRead: '/StudentArea/Home/MarkAsRead'
        };

        // =========================
        // Elements
        // =========================
        const chatFab = document.getElementById('chatFab');
        const chatFabBadge = document.getElementById('chatFabBadge'); // ✅ NEW
        const chatWidget = document.getElementById('chatWidget');
        const chatCloseBtn = document.getElementById('chatCloseBtn');
        const chatBackBtn = document.getElementById('chatBackBtn');
        const chatHeaderTitle = document.getElementById('chatHeaderTitle');

        const screenList = document.getElementById('screenList');
        const screenThread = document.getElementById('screenThread');

        const chatSearch = document.getElementById('chatSearch');
        const chatItemsBox = document.getElementById('chatItems');

        const messagesBox = document.getElementById('messagesBox');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        const currentUserId = document.getElementById('currentUserId')?.value;

        // =========================
        // State
        // =========================
        const state = {
            isOpen: false,
            currentInstructorId: null,
            currentInstructorName: '',
            conversationId: null,
            conversationsCache: [],

            // ✅ paging state
            take: 10,
            hasMore: true,
            oldestId: null,
            isLoadingOlder: false
        };

        // =========================
        // Audio (NEW) - WebAudio Beep
        // =========================
        let audioReady = false;
        let audioCtx = null;

        function initAudio() {
            if (audioReady) return;
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                audioReady = true;
            } catch {
                audioReady = false;
            }
        }

      

        // =========================
        // FAB Badge + Pulse (NEW)
        // =========================
        function setFabUnread(count) {
            const n = Math.max(0, parseInt(count || 0));
            if (!chatFabBadge) return;

            if (n === 0) {
                chatFabBadge.classList.add('hidden');
                chatFab.classList.remove('pulse');
                chatFabBadge.textContent = '0';
            } else {
                chatFabBadge.classList.remove('hidden');
                chatFabBadge.textContent = (n > 99) ? '99+' : String(n);
                chatFab.classList.add('pulse');
            }
        }

        function calcTotalUnread() {
            return (state.conversationsCache || []).reduce((sum, c) => sum + (c.unread || 0), 0);
        }

        function syncFabUnreadFromList() {
            setFabUnread(calcTotalUnread());
        }

        // =========================
        // UI Helpers
        // =========================
        function escapeHtml(str) {
            return (str ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", "&#039;");
        }

        function toTime(sentAt) {
            if (!sentAt) return '';
            const d = new Date(sentAt);
            if (Number.isNaN(d.getTime())) return '';
            return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function initials(name) {
            const s = (name ?? '').trim();
            if (!s) return 'IN';
            const parts = s.split(/\s+/).filter(Boolean);
            const first = parts[0]?.[0] ?? 'I';
            const second = (parts.length > 1 ? parts[1]?.[0] : parts[0]?.[1]) ?? 'N';
            return (first + second).toUpperCase();
        }

        // =========================
        // Open / Close (UPDATED to use .open)
        // =========================
        function showWidget() {
            state.isOpen = true;

            // ✅ بدل display: flex
            chatWidget.classList.add('open');
            chatWidget.setAttribute('aria-hidden', 'false');
            chatFab.style.display = 'none';

            showListScreen();
            loadMyConversations();
        }

        function hideWidget() {
            state.isOpen = false;

            // ✅ بدل display: none
            chatWidget.classList.remove('open');
            chatWidget.setAttribute('aria-hidden', 'true');
            chatFab.style.display = 'block';

            state.currentInstructorId = null;
            state.currentInstructorName = '';
            state.conversationId = null;

            // reset paging
            state.hasMore = true;
            state.oldestId = null;
            state.isLoadingOlder = false;

            messagesBox.innerHTML = '';
            chatInput.value = '';
            chatSearch.value = '';
        }

        function showListScreen() {
            screenThread.classList.add('hidden');
            screenList.classList.remove('hidden');
            chatBackBtn.classList.add('hidden');
            chatHeaderTitle.textContent = 'Chats';

            state.currentInstructorId = null;
            state.currentInstructorName = '';
            state.conversationId = null;

            // reset thread UI + paging
            state.hasMore = true;
            state.oldestId = null;
            state.isLoadingOlder = false;

            messagesBox.innerHTML = '';
        }

        function showThreadScreen(instructorName) {
            screenList.classList.add('hidden');
            screenThread.classList.remove('hidden');
            chatBackBtn.classList.remove('hidden');
            chatHeaderTitle.textContent = instructorName || 'Chat';
        }

        function setActiveItem(instructorId) {
            document.querySelectorAll('.chat-item').forEach(x => {
                x.classList.toggle('active', x.dataset.instructorId === instructorId);
            });
        }

        function findItem(instructorId) {
            return document.querySelector(`.chat-item[data-instructor-id="${CSS.escape(instructorId)}"]`);
        }

        function removeBadge(instructorId) {
            const item = findItem(instructorId);
            if (!item) return;
            const badge = item.querySelector('.badge');
            if (badge) badge.remove();
        }

        function incrementBadge(instructorId) {
            const item = findItem(instructorId);
            if (!item) return;

            let badge = item.querySelector('.badge');
            if (!badge) {
                badge = document.createElement('div');
                badge.className = 'badge';
                badge.textContent = '1';
                item.appendChild(badge);
            } else {
                badge.textContent = (parseInt(badge.textContent || '0') + 1).toString();
            }
        }

        // =========================
        // Conversations
        // =========================
        async function loadMyConversations() {
            try {
                const res = await fetch(API.conversations);
                const data = await res.json();

                state.conversationsCache = Array.isArray(data) ? data : [];
                renderConversations(state.conversationsCache);

                // ✅ NEW: update FAB unread + pulse
                syncFabUnreadFromList();

            } catch (e) {
                console.error(e);
                chatItemsBox.innerHTML = `<div class="empty">Failed to load chats</div>`;
            }
        }

        function renderConversations(list) {
            chatItemsBox.innerHTML = '';

            if (!list || list.length === 0) {
                chatItemsBox.innerHTML = `<div class="empty">No chats yet</div>`;
                return;
            }

            for (const c of list) {
                const name = c.instructorName ?? 'Instructor';
                const preview = c.lastMessage ?? '';
                const unread = c.unread ?? 0;

                const avatarHtml = c.photoUrl
                    ? `<img class="avatar-img" src="${escapeHtml(c.photoUrl)}" alt="${escapeHtml(name)}" />`
                    : `<div class="avatar-text">${escapeHtml(initials(name))}</div>`;

                const unreadHtml = unread > 0 ? `<div class="badge">${unread}</div>` : '';

                chatItemsBox.insertAdjacentHTML('beforeend', `
                                        <div class="chat-item"
                                             data-instructor-id="${escapeHtml(c.instructorId)}"
                                             data-instructor-name="${escapeHtml(name)}">
                                            <div class="avatar">${avatarHtml}</div>
                                            <div class="meta">
                                                <div class="name">${escapeHtml(name)}</div>
                                                <div class="preview">${escapeHtml(preview)}</div>
                                            </div>
                                            ${unreadHtml}
                                        </div>
                                    `);
            }

            if (state.currentInstructorId) setActiveItem(state.currentInstructorId);
        }

        // Click on conversation (delegation)
        chatItemsBox.addEventListener('click', (e) => {
            const item = e.target.closest('.chat-item');
            if (!item) return;

            const instructorId = item.dataset.instructorId;
            const instructorName = item.dataset.instructorName;

            openChat(instructorId, instructorName);
        });

        // Search filter
        chatSearch.addEventListener('input', () => {
            const q = (chatSearch.value ?? '').trim().toLowerCase();
            const filtered = !q
                ? state.conversationsCache
                : state.conversationsCache.filter(x => (x.instructorName ?? '').toLowerCase().includes(q));
            renderConversations(filtered);
        });

        async function openChat(instructorId, instructorName) {
            state.currentInstructorId = instructorId;
            state.currentInstructorName = instructorName;

            setActiveItem(instructorId);
            showThreadScreen(instructorName);

            await loadChatHistoryFirstPage();

            await markAsRead(instructorId);
            removeBadge(instructorId);

            // ✅ NEW: بعد ما فتح الشات وقرأه، حدّث FAB unread
            await loadMyConversations(); // يضمن الداتا من السيرفر صح
            // أو لو مش عايز reload، ممكن syncFabUnreadFromList()

            // انزل لآخر الشات بعد أول تحميل
            messagesBox.scrollTop = messagesBox.scrollHeight;
        }

        async function markAsRead(instructorId) {
            try {
                await fetch(API.markRead, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
                    body: new URLSearchParams({ instructorId })
                });
            } catch (e) {
                console.error(e);
            }
        }

        // =========================
        // Chat History (Cursor paging)
        // =========================
        async function loadChatHistoryFirstPage() {
            messagesBox.innerHTML = '';

            state.hasMore = true;
            state.oldestId = null;
            state.isLoadingOlder = false;

            await loadOlderMessages(); // يجيب آخر 10
        }

        async function loadOlderMessages() {
            if (!state.currentInstructorId) return;
            if (!state.hasMore || state.isLoadingOlder) return;

            state.isLoadingOlder = true;

            const prevScrollHeight = messagesBox.scrollHeight;
            const prevScrollTop = messagesBox.scrollTop;

            const url =
                `${API.history}?instructorId=${encodeURIComponent(state.currentInstructorId)}`
                + `&take=${state.take}`
                + (state.oldestId ? `&beforeId=${state.oldestId}` : ``);

            try {
                const res = await fetch(url);
                const data = await res.json();

                const list = data.messages ?? [];
                state.conversationId = data.conversationId ?? null;
                state.hasMore = data.hasMore === true;

                if (list.length === 0) {
                    state.isLoadingOlder = false;
                    return;
                }

                const frag = document.createDocumentFragment();
                for (const m of list) frag.appendChild(messageNode(m));
                messagesBox.prepend(frag);

                state.oldestId = list[0].id;

                const newScrollHeight = messagesBox.scrollHeight;
                messagesBox.scrollTop = (newScrollHeight - prevScrollHeight) + prevScrollTop;

            } catch (e) {
                console.error(e);
            } finally {
                state.isLoadingOlder = false;
            }
        }

        messagesBox.addEventListener('scroll', () => {
            if (messagesBox.scrollTop <= 10) {
                loadOlderMessages();
            }
        });

        function messageNode(m) {
            const senderId = (m.senderId ?? m.SenderId ?? '');
            const receiverId = (m.receiverId ?? m.ReceiverId ?? '');
            const content = (m.content ?? m.Content ?? '');
            const sentAt = (m.sentAt ?? m.SentAt);

            const isMine = currentUserId && senderId === currentUserId;

            const wrapper = document.createElement('div');
            wrapper.className = `msg-row ${isMine ? 'mine' : ''}`;
            wrapper.innerHTML = `
                                    <div class="bubble">
                                        ${escapeHtml(content)}
                                        <span class="time">${escapeHtml(toTime(sentAt))}</span>
                                    </div>
                                `;
            return wrapper;
        }

        function renderMessage(m) {
            messagesBox.appendChild(messageNode(m));
        }

        // =========================
        // Send Message
        // =========================
        async function sendMessageFromUI() {
            const text = (chatInput.value || '').trim();
            if (!state.currentInstructorId || !text) return;

            const nowIso = new Date().toISOString();
            renderMessage({
                senderId: currentUserId,
                receiverId: state.currentInstructorId,
                content: text,
                sentAt: nowIso
            });

            messagesBox.scrollTop = messagesBox.scrollHeight;
            chatInput.value = '';

            const item = findItem(state.currentInstructorId);
            if (item) {
                const previewEl = item.querySelector('.preview');
                if (previewEl) previewEl.textContent = text;
            }

            try {
                const res = await fetch(API.save, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
                    body: new URLSearchParams({ receiverId: state.currentInstructorId, content: text })
                });

                const data = await res.json();
                if (!data || data.success !== true) {
                    console.log('SaveMessage failed:', data);
                    return;
                }

                await sendRealtimeToInstructor(state.currentInstructorId, text);

            } catch (e) {
                console.error(e);
            }
        }

        sendBtn.addEventListener('click', sendMessageFromUI);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessageFromUI();
        });

        // =========================
        // Open/Close/Back
        // =========================
        // ✅ NEW: initAudio أول مرة user يعمل click
        chatFab.addEventListener('click', () => {
            initAudio();
            showWidget();
        });

        chatCloseBtn.addEventListener('click', hideWidget);
        chatBackBtn.addEventListener('click', showListScreen);

        // =========================
        // SignalR (Student)
        // =========================
        const studentConnection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .withAutomaticReconnect()
            .build();

        studentConnection.start()
            .then(() => console.log("SignalR Connected (Student)!"))
            .catch(err => console.error(err.toString()));

        studentConnection.on("ReceiveMessage", async function (senderId, message, timestamp) {

            const sameOpenChat = state.isOpen && state.currentInstructorId && senderId === state.currentInstructorId;

            if (sameOpenChat) {
                renderMessage({
                    senderId: senderId,
                    receiverId: currentUserId,
                    content: message,
                    sentAt: timestamp
                });

                messagesBox.scrollTop = messagesBox.scrollHeight;

                await markAsRead(senderId);
                removeBadge(senderId);

                // بعد القراءة حدّث unread
                await loadMyConversations();
                return;
            }

            // ✅ NEW: صوت إشعار لو مش فاتح نفس الشات
          

            const item = findItem(senderId);
            if (item) {
                const previewEl = item.querySelector('.preview');
                if (previewEl) previewEl.textContent = message;

                incrementBadge(senderId);

                // ✅ NEW: update FAB unread (local sync)
                syncFabUnreadFromList();
                // الأفضل: reload من السيرفر لضمان الرقم الحقيقي
                await loadMyConversations();

            } else {
                if (state.isOpen) {
                    await loadMyConversations();
                } else {
                    // حتى لو الودجت مقفول، نحدّث الرقم من السيرفر
                    await loadMyConversations();
                }
            }
        });

        studentConnection.on("UpdateConversationList", function () {
            // reload list (if open) + keep FAB in sync
            if (state.isOpen) loadMyConversations();
            else loadMyConversations();
        });

        async function sendRealtimeToInstructor(instructorId, message) {
            try {
                await studentConnection.invoke("SendMessage", instructorId, message);
            } catch (e) {
                console.error(e.toString());
            }
        }

    </script>
}


<style>
    .chat-widget {
        position: fixed;
        right: 18px;
        bottom: 18px;
        width: 360px;
        max-width: calc(100vw - 36px);
        height: 560px;
        max-height: calc(100vh - 36px);
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 14px 36px rgba(0,0,0,.18);
        overflow: hidden;
        z-index: 9999;
        /* ✅ مهم: لازم يبقى display:flex دايمًا عشان open/close يشتغل */
        display: flex;
        flex-direction: column;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
        /* ✅ Slide/Hide default */
        opacity: 0;
        pointer-events: none;
        transform: translateY(14px) scale(.98);
        transform-origin: bottom right;
        transition: opacity .18s ease, transform .18s ease;
    }

        /* ✅ لما يفتح */
        .chat-widget.open {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0) scale(1);
        }

    .chat-header {
        background: #0ea85f; /* واتساب vibe */
        color: #fff;
        padding: 12px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
    }

    .chat-header .title {
        font-weight: 800;
        font-size: 14px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .chat-btn-icon {
        width: 34px;
        height: 34px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        background: rgba(255,255,255,.18);
        color: #fff;
        font-size: 16px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .chat-screen {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
    }

    .hidden {
        display: none !important;
    }

    .chat-search {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }

        .chat-search input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e7e7e7;
            border-radius: 12px;
            outline: none;
            font-size: 13px;
        }

    .chat-items {
        overflow: auto;
        padding: 8px;
        flex: 1;
    }

    .chat-item {
        padding: 10px;
        border-radius: 14px;
        cursor: pointer;
        display: flex;
        gap: 10px;
        align-items: center;
        position: relative;
    }

        .chat-item:hover {
            background: #f6f7f7;
        }

        .chat-item.active {
            background: #e9fbf2;
        }

    .avatar {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        background: #e7e7e7;
        flex: 0 0 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .avatar-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-text {
        font-weight: 800;
        font-size: 13px;
        color: #2b2b2b;
    }

    .chat-item .meta {
        flex: 1;
        min-width: 0;
    }

    .chat-item .name {
        font-size: 13px;
        font-weight: 800;
        margin-bottom: 2px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .chat-item .preview {
        font-size: 12px;
        color: #6f6f6f;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .badge {
        min-width: 20px;
        height: 20px;
        border-radius: 999px;
        background: #00c853;
        color: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        padding: 0 6px;
        font-weight: 800;
    }

    /* Thread */
    .messages {
        flex: 1;
        min-height: 0;
        overflow: auto;
        padding: 12px;
        background: #f3f5f4;
    }

    .msg-row {
        display: flex;
        margin-bottom: 10px;
    }

        .msg-row.mine {
            justify-content: flex-end;
        }

    .bubble {
        max-width: 85%;
        padding: 10px 12px;
        border-radius: 14px;
        background: #ffffff;
        color: #000;
        font-size: 13px;
        line-height: 1.35;
        box-shadow: 0 6px 14px rgba(0,0,0,.06);
    }

    .mine .bubble {
        background: #0ea85f;
        color: #fff;
    }

    .bubble .time {
        display: block;
        font-size: 10px;
        opacity: .85;
        margin-top: 4px;
        text-align: right;
    }

    .composer {
        border-top: 1px solid #eee;
        padding: 10px;
        display: flex;
        gap: 8px;
        background: #fff;
    }

        .composer input {
            flex: 1;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid #e7e7e7;
            outline: none;
            font-size: 13px;
        }

        .composer button {
            width: 44px;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            background: #0ea85f;
            color: #fff;
            font-size: 16px;
        }

    /* ===== WhatsApp FAB ===== */
    .chat-fab {
        position: fixed;
        right: 18px;
        bottom: 18px;
        width: 58px;
        height: 58px;
        border-radius: 50%;
        background: #25D366;
        color: #fff;
        border: none;
        cursor: pointer;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 26px rgba(0,0,0,.22);
        transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
    }
    .chat-fab-icon{
    width: 46px;
    height: 46px;
    border-radius: 50%;
    display:flex;
    align-items:center;
    justify-content:center;

    /* لمسة جمال */
    background: rgba(255,255,255,.14);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
}

.chat-fab-icon i{
    font-size: 28px;
    transform: translateY(1px);
}

        .chat-fab i {
            font-size: 28px;
        }

        .chat-fab:hover {
            transform: translateY(-2px) scale(1.04);
            box-shadow: 0 14px 34px rgba(0,0,0,.28);
            filter: brightness(1.03);
        }

    /* ===== Pulse Animation ===== */
    @@keyframes chatPulse {
        0% {
            box-shadow: 0 0 0 0 rgba(37,211,102,.45), 0 10px 26px rgba(0,0,0,.22);
        }

        70% {
            box-shadow: 0 0 0 14px rgba(37,211,102,0), 0 10px 26px rgba(0,0,0,.22);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(37,211,102,0), 0 10px 26px rgba(0,0,0,.22);
        }
    }

    .chat-fab.pulse {
        animation: chatPulse 1.4s ease-out infinite;
    }

    /* ===== FAB Badge ===== */
    .chat-fab-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        min-width: 22px;
        height: 22px;
        padding: 0 6px;
        border-radius: 999px;
        background: #ff3b30;
        color: #fff;
        font-size: 12px;
        font-weight: 800;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #fff;
    }

    .empty {
        padding: 14px;
        color: #777;
        font-size: 13px;
        text-align: center;
    }

    @@media (max-width: 520px) {
        .chat-widget {
            width: 100%;
            height: 100%;
            right: 0;
            bottom: 0;
            border-radius: 0;
            transform-origin: bottom right;
        }

        .chat-fab {
            right: 14px;
            bottom: 14px;
        }
    }
</style>







