@using Models
@model Models.ViewModels.StudentDashboardVM

@{
    Layout = "_StudentLayout";
    ViewData["Title"] = "Dashboard";

    // =========================
    // Language (Session-based)
    // =========================
    var currentLang = Context.Session.GetString("Language") ?? "en";
    var isArabic = currentLang == "ar";
    var direction = isArabic ? "rtl" : "ltr";
}

<div class="sd-wrap">

    <div class="sd-grid">

        <aside class="sd-left">

            <div class="sd-card sd-upcoming">
                <div class="sd-card-head">
                    <div class="sd-head-title">
                        <i class="fa-solid fa-calendar-days sd-ic-fa"></i>
                        <span>@(isArabic ? "المحاضرات القادمة" : "Upcoming lectures")</span>
                    </div>
                </div>

                <div class="sd-card-body">

                    @if (Model.UpcomingLectures != null && Model.UpcomingLectures.Any())
                    {
                        <div class="sd-up-table">

                            <div class="sd-up-row sd-up-head">
                                <div>@(isArabic ? "الوقت" : "TIME")</div>
                                <div>@(isArabic ? "الكورس" : "COURSE")</div>
                                <div>@(isArabic ? "المُدرس" : "INSTRUCTOR")</div>
                                <div>@(isArabic ? "لينك المحاضرة " : "ZOOM")</div>
                            </div>

                            @foreach (var lec in Model.UpcomingLectures.Take(5))
                            {
                                var canJoinThis = DateTime.Now >= lec.Date;

                                <div class="sd-up-row">
                                    <div class="sd-up-time">
                                        <div class="sd-up-time-main">@lec.Date.ToString("ddd, dd MMM")</div>
                                        <div class="sd-up-time-sub">@lec.Date.ToString(isArabic ? "HH:mm" : "hh:mm tt")</div>
                                    </div>

                                    <div class="sd-up-course">
                                        <div class="sd-up-course-main" title="@lec.SubjectName">@lec.SubjectName</div>
                                    </div>

                                    <div class="sd-up-inst">
                                        <div class="sd-up-inst-main" title="@lec.InstructorName">@lec.InstructorName</div>
                                    </div>

                                    <div class="sd-up-zoom">
                                        @if (canJoinThis && !string.IsNullOrWhiteSpace(lec.ZoomLink))
                                        {
                                            <a class="sd-up-zoom-btn" href="@lec.ZoomLink" target="_blank" rel="noopener">
                                                <i class="fa-solid fa-video"></i> @(isArabic ? "انضم" : "Join")
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="sd-up-zoom-muted">
                                                <i class="fa-regular fa-clock"></i> @(isArabic ? "لم تبدأ بعد" : "Not started")
                                            </span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="sd-empty">@(isArabic ? "لا توجد محاضرات قادمة بعد." : "No upcoming lectures yet.")</div>
                    }

                    <div class="sd-upcoming-footer">
                        <a class="sd-link sd-link-danger"
                           asp-area="StudentArea"
                           asp-controller="Lectures"
                           asp-action="Schedule">
                            <i class="fa-solid fa-calendar-check"></i> @(isArabic ? "عرض جدول المحاضرات" : "View lecture schedule")
                        </a>
                    </div>
                </div>
            </div>

            <div class="sd-card sd-tips">
                <div class="sd-card-head">
                    <div class="sd-head-title">
                        <i class="fa-solid fa-lightbulb sd-ic-fa"></i>
                        <span>@(isArabic ? "نصائح" : "Tips")</span>
                    </div>
                </div>

                <div class="sd-card-body">
                    <div class="sd-tips-item">
                        <i class="fa-solid fa-circle-check"></i>
                        <span>@(isArabic ? "حدد وقتًا ثابتًا للمذاكرة لتبقى مركزًا ومنتظمًا." : "Set a regular study time to stay focused and consistent.")</span>
                    </div>

                    <div class="sd-tips-item">
                        <i class="fa-solid fa-circle-check"></i>
                        <span>@(isArabic ? "راجع مواد الدرس والموارد بعد كل جلسة." : "Review lesson materials and resources after each session.")</span>
                    </div>

                    <div class="sd-tips-item">
                        <i class="fa-solid fa-circle-check"></i>
                        <span>@(isArabic ? "تابع تقدمك وارجع للمواضيع التي تجدها صعبة." : "Track your progress and revisit topics you find challenging.")</span>
                    </div>

                    <div class="sd-tips-item">
                        <i class="fa-solid fa-circle-check"></i>
                        <span>@(isArabic ? "لا تتردد في السؤال أو مراجعة تفاصيل الكورس عند الحاجة." : "Don’t hesitate to ask questions or check course details when needed.")</span>
                    </div>
                    <div class="sd-tips-item">
                        <i class="fa-solid fa-circle-check"></i>
                        <span>@(isArabic ? "قسّم وقتك بين الدراسة والراحة لتجنب الإرهاق وزيادة الإنتاجية." : "Balance study time with breaks to avoid burnout and boost productivity.")</span>
                    </div>


                </div>
            </div>

        </aside>

        <main class="sd-center">

            <div class="sd-join">
                <div class="sd-join-icon">
                    <i class="fa-solid fa-video sd-join-ic"></i>
                </div>

                <h2 class="sd-join-title">@(isArabic ? "انضم لمحاضرة أونلاين" : "Join online lecture")</h2>

                @{
                    var nextLecture = Model.UpcomingLectures?
                        .OrderBy(x => x.Date)
                        .FirstOrDefault();
                    var hasUpcoming = nextLecture != null;
                }

                @if (Model.CanJoinNow && Model.NextStudentAppointmentId != null)
                {
                    <p class="sd-join-desc">
                        @(isArabic ? "هناك محاضرة مباشرة الآن. يمكنك الانضمام فورًا." : "A lecture is live right now. You can join immediately.")
                    </p>

                    <div class="sd-join-actions" id="joinActions">
                        <a class="sd-btn sd-btn-primary"
                           id="joinNowBtn"
                           asp-area="StudentArea"
                           asp-controller="Lectures"
                           asp-action="Join"
                           asp-route-studentAppointmentId="@Model.NextStudentAppointmentId">
                            <i class="fa-solid fa-play"></i> @(isArabic ? "انضم الآن" : "Join now")
                        </a>

                        <a class="sd-btn sd-btn-ghost"
                           asp-area="StudentArea"
                           asp-controller="Lectures"
                           asp-action="Schedule">
                            @(isArabic ? "كل المحاضرات" : "All lectures") <i class="fa-solid fa-arrow-right"></i>
                        </a>
                    </div>

                    <div class="sd-status">
                        <span class="sd-dot"></span>
                        <span class="sd-status-text">@(isArabic ? "جلسة مباشرة متاحة" : "Live session available")</span>
                    </div>
                }
                else
                {
                    <p class="sd-join-desc">
                        @if (hasUpcoming)
                        {
                            <text>
                                @(isArabic ? "لا توجد محاضرة مباشرة الآن. المحاضرة القادمة:" : "No live lecture at the moment. Next lecture:")
                                <b>@nextLecture!.Date.ToString(isArabic ? "ddd, dd MMM • HH:mm" : "ddd, dd MMM • hh:mm tt")</b>
                            </text>
                        }
                        else
                        {
                            <text>@(isArabic ? "لا توجد محاضرة مباشرة الآن. لا توجد محاضرات قادمة بعد." : "No live lecture at the moment. There are no upcoming lectures yet.")</text>
                        }
                    </p>

                    <div class="sd-join-actions" id="joinActions">
                        <button class="sd-btn sd-btn-primary"
                                type="button"
                                onclick="location.reload();">
                            <i class="fa-solid fa-rotate-right"></i> @(isArabic ? "تحقق" : "Check")
                        </button>

                        <a class="sd-btn sd-btn-ghost"
                           asp-area="StudentArea"
                           asp-controller="Lectures"
                           asp-action="Schedule">
                            @(isArabic ? "كل المحاضرات" : "All lectures") <i class="fa-solid fa-arrow-right"></i>
                        </a>
                    </div>

                    <div class="sd-status">
                        <span class="sd-dot"></span>
                        <span class="sd-status-text">@(isArabic ? "التحقق التلقائي جاهز" : "Auto-check is ready")</span>
                    </div>
                }
            </div>

            <div class="sd-card sd-last">
                <div class="sd-card-head">
                    <div class="sd-head-title">
                        <i class="fa-solid fa-clock-rotate-left sd-ic-fa"></i>
                        <span>@(isArabic ? "آخر الدروس" : "Last lessons")</span>
                    </div>
                </div>

                <div class="sd-card-body">
                    <div class="sd-last-list">
                        @if (Model.LastLessons != null && Model.LastLessons.Any())
                        {
                            foreach (var l in Model.LastLessons.Take(5))
                            {
                                <div class="sd-last-row">
                                    <div class="sd-last-main">
                                        <div class="sd-last-title">@l.LessonTitle</div>
                                        <div class="sd-last-sub">@(isArabic ? "الكورس:" : "Course:") @l.CourseTitle</div>
                                    </div>

                                    <button type="button" class="sd-last-toggle" onclick="toggleLastLesson(this)">
                                        <i class="fa-solid fa-chevron-down"></i>
                                    </button>

                                    <div class="sd-last-details">
                                        <div class="content-links">
                                            @if (!string.IsNullOrEmpty(l.DriveLink))
                                            {
                                                <a href="@l.DriveLink" target="_blank" rel="noopener" class="content-link video">
                                                    <i class="fas fa-video"></i> @(isArabic ? "مشاهدة المحاضرة" : "Watch lecture")
                                                </a>
                                            }
                                            @if (!string.IsNullOrEmpty(l.LecturePdfUrl))
                                            {
                                                <a href="@l.LecturePdfUrl" target="_blank" rel="noopener" class="content-link pdf">
                                                    <i class="fas fa-file-pdf"></i> @(isArabic ? "ملف المحاضرة PDF" : "Lecture PDF")
                                                </a>
                                            }
                                            @if (!string.IsNullOrEmpty(l.AssignmentPdfUrl))
                                            {
                                                <a href="@l.AssignmentPdfUrl" target="_blank" rel="noopener" class="content-link assignment">
                                                    <i class="fas fa-tasks"></i> @(isArabic ? "الواجب" : "Assignment")
                                                </a>
                                            }
                                            @if (string.IsNullOrEmpty(l.DriveLink) && string.IsNullOrEmpty(l.LecturePdfUrl) && string.IsNullOrEmpty(l.AssignmentPdfUrl))
                                            {
                                                <div class="sd-empty">@(isArabic ? "لا توجد ملفات/روابط مضافة بعد." : "No resources added yet.")</div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="sd-empty">@(isArabic ? "لا توجد دروس حديثة بعد." : "No recent lessons yet.")</div>
                        }
                    </div>

                    <div class="sd-last-footer">
                        <a class="sd-link" asp-area="StudentArea" asp-controller="Course" asp-action="Index">
                            @(isArabic ? "عرض كل الدروس" : "View all lessons") <i class="fa-solid fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
            </div>

        </main>

        <aside class="sd-right">

            <div class="sd-card sd-courses">
                <div class="sd-card-head sd-head-blue">
                    <div class="sd-head-title">
                        <i class="fa-solid fa-book-open sd-ic-fa"></i>
                        <span>@(isArabic ? "كورساتي" : "My courses")</span>
                    </div>
                </div>

                <div class="sd-card-body">
                    <div class="sd-course-list sd-course-list-simple">
                        @if (Model.Courses != null && Model.Courses.Any())
                        {
                            foreach (var c in Model.Courses.Take(3))
                            {
                                var title = !string.IsNullOrWhiteSpace(c.CourseTitleEn) ? c.CourseTitleEn : c.CourseTitleAr;

                                <div class="sd-course-card">
                                    <div class="sd-course-row">
                                        <div class="sd-course-left">
                                            <div class="sd-course-name">@title</div>
                                            <div class="sd-course-hint">@(isArabic ? "افتح محتوى الكورس والأقسام" : "Open course content & sections")</div>
                                        </div>

                                        <a class="sd-course-action"
                                           asp-area="StudentArea"
                                           asp-controller="Course"
                                           asp-action="Details"
                                           asp-route-id="@c.CourseId">
                                            @(isArabic ? "عرض التفاصيل" : "View details") <i class="fa-solid fa-arrow-right"></i>
                                        </a>
                                    </div>
                                </div>
                            }

                            <div class="sd-courses-footer">
                                <a class="sd-link" asp-area="StudentArea" asp-controller="Course" asp-action="Index">
                                    @(isArabic ? "كل الكورسات" : "All courses") <i class="fa-solid fa-arrow-right"></i>
                                </a>
                            </div>
                        }
                        else
                        {
                            <div class="sd-empty">@(isArabic ? "لا توجد كورسات بعد." : "No courses yet.")</div>
                        }
                    </div>
                </div>
            </div>

            <div class="sd-card sd-quick">
                <div class="sd-card-head">
                    <div class="sd-head-title">
                        <i class="fa-solid fa-bolt sd-ic-fa"></i>
                        <span>@(isArabic ? "إجراءات سريعة" : "Quick actions")</span>
                    </div>
                </div>

                <div class="sd-card-body">
                    <div class="sd-quick-grid">
                        <a class="sd-quick-item" asp-area="StudentArea" asp-controller="Course" asp-action="Index">
                            <i class="fa-solid fa-layer-group"></i>
                            <span>@(isArabic ? "كل الكورسات" : "All courses")</span>
                        </a>

                        <a class="sd-quick-item" asp-area="StudentArea" asp-controller="Lectures" asp-action="Schedule">
                            <i class="fa-solid fa-video"></i>
                            <span>@(isArabic ? "المحاضرات" : "Lectures")</span>
                        </a>

                        <!-- ✅ تعديل الزر الأخير ليكون تواصل معنا -->
                        <a class="sd-quick-item" target="_blank"
                           href="https://mail.google.com/mail/?view=cm&fs=1&to=elclassplatform@gmail.com">
                            <i class="fa-solid fa-envelope"></i>
                            <span>@(isArabic ? "تواصل معنا" : "Contact Us")</span>
                        </a>


                        <a class="sd-quick-item" asp-area="Identity" asp-controller="MyProfile" asp-action="MyProfile">
                            <i class="fa-solid fa-user-gear"></i>
                            <span>@(isArabic ? "حسابي" : "My profile")</span>
                        </a>
                    </div>
                </div>
            </div>


            <div class="sd-help">
                <div class="sd-help-title">@(isArabic ? "تحتاج مساعدة؟" : "Need help?")</div>
                <div class="sd-help-sub">@(isArabic ? "راجع الأدلة وكتيبات المساعدة الخاصة بنا" : "Please review our guides and help manuals")</div>
            </div>

        </aside>

    </div>
</div>

@* Chat Widget (Student) *@
<button id="chatFab" class="chat-fab" type="button" aria-label="Open chat"> 
    <span class="chat-fab-icon" aria-hidden="true">
        <i class="fa-regular fa-comment-dots"></i>
    </span> 
    <span id="chatFabBadge" class="chat-fab-badge hidden">0</span> </button>

<div id="chatWidget" class="chat-widget" aria-hidden="true">
    @Html.AntiForgeryToken()
    <div class="chat-header">
        <div class="header-left">
            <button id="chatBackBtn" class="chat-btn-icon hidden" type="button" aria-label="Back">←</button>
            <div class="title" id="chatHeaderTitle">
                <div id="chatHeaderName">@(isArabic ? "المحادثات" : "Chats")</div>
                <div id="chatHeaderStatus" class="chat-status"></div>
            </div>
        </div>
        <div class="actions">
            <button class="chat-btn-icon" id="chatCloseBtn" type="button" aria-label="Close">✕</button>
        </div>
    </div>

    @* Screen 1: List *@
    <div class="chat-screen" id="screenList">
        <div class="chat-search">
            <input id="chatSearch" type="text" placeholder="@(isArabic ? "ابحث عن المُدرسين..." : "Search instructors...")" autocomplete="off" />
        </div>
        <div class="chat-items" id="chatItems"></div>
    </div>

    @* Screen 2: Thread *@
    <div class="chat-screen hidden" id="screenThread">
        <div class="messages" id="messagesBox"></div>
        <div class="composer">
            <div id="attachChip" class="attach-chip hidden">
                <span id="attachName"></span>
                <button type="button" id="attachClearBtn" class="attach-clear" aria-label="Remove file">×</button>
            </div>

            <input id="chatInput" type="text" placeholder="@(isArabic ? "اكتب رسالة..." : "Type a message...")" autocomplete="off" />
            <input type="file" id="chatFile" hidden />

            <button type="button" id="attachBtn" class="chat-attach-btn" title="Attach file">
                <i class="fa-solid fa-paperclip"></i>
            </button>

            <button id="sendBtn" type="button" aria-label="Send">➤</button>
        </div>
    </div>
</div>



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

    <input type="hidden" id="currentUserId" value="@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value" />

    <script>
        // =========================
        // Config (endpoints)
        // =========================
        const API = {
            conversations: '/StudentArea/Home/GetMyConversations',
            history: '/StudentArea/Home/GetChatHistory',
            save: '/StudentArea/Home/SaveMessage',
            saveWithFile: '/StudentArea/Home/SendMessageWithFile',
            markRead: '/StudentArea/Home/MarkAsRead',
            download: '/StudentArea/Home/DownloadAttachment'
        };

        // =========================
        // Elements
        // =========================
        const chatFab = document.getElementById('chatFab');
        const chatFabBadge = document.getElementById('chatFabBadge');
        const chatWidget = document.getElementById('chatWidget');
        const chatCloseBtn = document.getElementById('chatCloseBtn');
        const chatBackBtn = document.getElementById('chatBackBtn');
        const chatHeaderTitle = document.getElementById('chatHeaderTitle');

        const screenList = document.getElementById('screenList');
        const screenThread = document.getElementById('screenThread');

        const chatSearch = document.getElementById('chatSearch');
        const chatItemsBox = document.getElementById('chatItems');

        const messagesBox = document.getElementById('messagesBox');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        // ✅ Attachment elements
        const attachBtn = document.getElementById("attachBtn");
        const chatFile = document.getElementById("chatFile");

        // ✅ old span (fallback)
        const attachName = document.getElementById("attachName");

        // ✅ new chip (if you added it in HTML)
        const attachChip = document.getElementById("attachChip");
        const attachClearBtn = document.getElementById("attachClearBtn");

        const currentUserId = document.getElementById('currentUserId')?.value;

        // ✅ Header elements (Student)
        const headerNameEl = document.getElementById("chatHeaderName");
        const headerStatusEl = document.getElementById("chatHeaderStatus");

        // =========================
        // ✅ Anti-forgery token helper
        // =========================
        function getAntiForgeryToken() {
            // token موجود داخل chatWidget (لأنك حطيت @Html.AntiForgeryToken())
            const el = chatWidget?.querySelector('input[name="__RequestVerificationToken"]')
                || document.querySelector('input[name="__RequestVerificationToken"]');
            return el?.value || '';
        }

        function addCsrfHeader(headersObj) {
            const token = getAntiForgeryToken();
            if (token) headersObj['RequestVerificationToken'] = token; // ASP.NET Core default header
            return headersObj;
        }

        // =========================
        // State
        // =========================
        const readCache = new Set();
        const state = {
            isOpen: false,
            currentInstructorId: null,
            currentInstructorName: '',
            conversationId: null,
            conversationsCache: [],

            take: 10,
            hasMore: true,
            oldestId: null,
            isLoadingOlder: false
        };

        // =========================
        // Audio (unused حاليا)
        // =========================
        let audioReady = false;
        let audioCtx = null;

        function initAudio() {
            if (audioReady) return;
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                audioReady = true;
            } catch {
                audioReady = false;
            }
        }

        // =========================
        // FAB Badge + Pulse
        // =========================
        function setFabUnread(count) {
            const n = Math.max(0, parseInt(count || 0));
            if (!chatFabBadge) return;

            if (n === 0) {
                chatFabBadge.classList.add('hidden');
                chatFab.classList.remove('pulse');
                chatFabBadge.textContent = '0';
            } else {
                chatFabBadge.classList.remove('hidden');
                chatFabBadge.textContent = (n > 99) ? '99+' : String(n);
                chatFab.classList.add('pulse');
            }
        }

        function calcTotalUnread() {
            return (state.conversationsCache || []).reduce((sum, c) => sum + (c.unread || 0), 0);
        }

        function syncFabUnreadFromList() {
            setFabUnread(calcTotalUnread());
        }

        // =========================
        // UI Helpers
        // =========================
        function escapeHtml(str) {
            return (str ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", "&#039;");
        }

        function toTime(sentAt) {
            if (!sentAt) return '';
            const d = new Date(sentAt);
            if (Number.isNaN(d.getTime())) return '';
            return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function initials(name) {
            const s = (name ?? '').trim();
            if (!s) return 'IN';
            const parts = s.split(/\s+/).filter(Boolean);
            const first = parts[0]?.[0] ?? 'I';
            const second = (parts.length > 1 ? parts[1]?.[0] : parts[0]?.[1]) ?? 'N';
            return (first + second).toUpperCase();
        }

        function isImageContentType(ct) {
            return typeof ct === 'string' && ct.toLowerCase().startsWith('image/');
        }

        function buildDownloadUrl(messageId) {
            return `${API.download}?messageId=${encodeURIComponent(messageId)}`;
        }

        // =========================
        // ✅ Image Preview Modal (click to open)
        // =========================
        function ensureImageModal() {
            if (document.getElementById('imgPreviewModal')) return;

            const modal = document.createElement('div');
            modal.id = 'imgPreviewModal';
            modal.className = 'img-preview-modal hidden';
            modal.innerHTML = `
                <div class="img-preview-backdrop"></div>
                <div class="img-preview-content" role="dialog" aria-modal="true">
                    <button type="button" class="img-preview-close" aria-label="Close">✕</button>
                    <img class="img-preview-img" alt="Preview" />
                </div>
            `;
            document.body.appendChild(modal);

            const close = () => modal.classList.add('hidden');

            modal.querySelector('.img-preview-backdrop')?.addEventListener('click', close);
            modal.querySelector('.img-preview-close')?.addEventListener('click', close);
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) close();
            });
        }

        function openImagePreview(src) {
            if (!src) return;
            ensureImageModal();
            const modal = document.getElementById('imgPreviewModal');
            const img = modal.querySelector('.img-preview-img');
            img.src = src;
            modal.classList.remove('hidden');
        }

        // =========================
        // ✅ Presence helpers
        // =========================
        const presenceMap = new Map();

        function setHeaderStatus(isOnline) {
            if (!headerStatusEl) return;

            headerStatusEl.textContent = isOnline ? "● Online" : "● Offline";
            headerStatusEl.classList.toggle("online", !!isOnline);
            headerStatusEl.classList.toggle("offline", !isOnline);
        }

        // =========================
        // ✅ Attachment helpers
        // =========================
        function getSelectedFile() {
            return (chatFile && chatFile.files && chatFile.files.length > 0) ? chatFile.files[0] : null;
        }

        function showAttachmentName(name) {
            if (attachChip) {
                attachChip.classList.remove("hidden");
                const nameEl = attachChip.querySelector("#attachName");
                if (nameEl) nameEl.textContent = name;
                return;
            }

            if (attachName) {
                attachName.style.display = "inline-block";
                attachName.textContent = name;
            }
        }

        function hideAttachmentName() {
            if (attachChip) {
                attachChip.classList.add("hidden");
                const nameEl = attachChip.querySelector("#attachName");
                if (nameEl) nameEl.textContent = "";
            }
            if (attachName) {
                attachName.style.display = "none";
                attachName.textContent = "";
            }
        }

        function clearAttachmentUI() {
            if (chatFile) chatFile.value = "";
            hideAttachmentName();
        }

        if (attachBtn && chatFile) {
            attachBtn.addEventListener("click", () => chatFile.click());

            chatFile.addEventListener("change", () => {
                const f = getSelectedFile();
                if (f) showAttachmentName(f.name);
                else clearAttachmentUI();
            });
        }

        attachClearBtn?.addEventListener("click", () => clearAttachmentUI());

        // =========================
        // Open / Close
        // =========================
        function showWidget() {
            state.isOpen = true;

            chatWidget.classList.add('open');
            chatWidget.setAttribute('aria-hidden', 'false');
            chatFab.style.display = 'none';

            showListScreen();
            loadMyConversations();
        }

        function hideWidget() {
            state.isOpen = false;

            chatWidget.classList.remove('open');
            chatWidget.setAttribute('aria-hidden', 'true');
            chatFab.style.display = 'block';

            state.currentInstructorId = null;
            state.currentInstructorName = '';
            state.conversationId = null;

            state.hasMore = true;
            state.oldestId = null;
            state.isLoadingOlder = false;

            messagesBox.innerHTML = '';
            chatInput.value = '';
            chatSearch.value = '';
            clearAttachmentUI();

            if (headerNameEl) headerNameEl.textContent = "Chats";
            if (headerStatusEl) headerStatusEl.textContent = "";
        }

        function showListScreen() {
            screenThread.classList.add('hidden');
            screenList.classList.remove('hidden');
            chatBackBtn.classList.add('hidden');

            if (headerNameEl) headerNameEl.textContent = "Chats";
            if (headerStatusEl) headerStatusEl.textContent = "";

            state.currentInstructorId = null;
            state.currentInstructorName = '';
            state.conversationId = null;

            state.hasMore = true;
            state.oldestId = null;
            state.isLoadingOlder = false;

            messagesBox.innerHTML = '';
            clearAttachmentUI();
        }

        function showThreadScreen(instructorName) {
            screenList.classList.add('hidden');
            screenThread.classList.remove('hidden');
            chatBackBtn.classList.remove('hidden');

            if (headerNameEl) headerNameEl.textContent = instructorName || "Chat";
        }

        function setActiveItem(instructorId) {
            document.querySelectorAll('.chat-item').forEach(x => {
                x.classList.toggle('active', x.dataset.instructorId === instructorId);
            });
        }

        function findItem(instructorId) {
            return document.querySelector(`.chat-item[data-instructor-id="${CSS.escape(instructorId)}"]`);
        }

        function removeBadge(instructorId) {
            const item = findItem(instructorId);
            if (!item) return;
            const badge = item.querySelector('.badge');
            if (badge) badge.remove();
        }

        function incrementBadge(instructorId) {
            const item = findItem(instructorId);
            if (!item) return;

            let badge = item.querySelector('.badge');
            if (!badge) {
                badge = document.createElement('div');
                badge.className = 'badge';
                badge.textContent = '1';
                item.appendChild(badge);
            } else {
                badge.textContent = (parseInt(badge.textContent || '0') + 1).toString();
            }
        }

        // =========================
        // Conversations
        // =========================
        async function loadMyConversations() {
            try {
                const res = await fetch(API.conversations);
                const data = await res.json();

                state.conversationsCache = Array.isArray(data) ? data : [];
                renderConversations(state.conversationsCache);

                syncFabUnreadFromList();

            } catch (e) {
                console.error(e);
                chatItemsBox.innerHTML = `<div class="empty">Failed to load chats</div>`;
            }
        }

        function renderConversations(list) {
            chatItemsBox.innerHTML = '';

            if (!list || list.length === 0) {
                chatItemsBox.innerHTML = `<div class="empty">No chats yet</div>`;
                return;
            }

            for (const c of list) {
                const idStr = String(c.instructorId ?? '');
                const name = c.instructorName ?? 'Instructor';
                const preview = c.lastMessage ?? '';
                const unread = c.unread ?? 0;

                const avatarHtml = c.photoUrl
                    ? `<img class="avatar-img" src="${escapeHtml(c.photoUrl)}" alt="${escapeHtml(name)}" />`
                    : `<div class="avatar-text">${escapeHtml(initials(name))}</div>`;

                const unreadHtml = unread > 0 ? `<div class="badge">${unread}</div>` : '';

                const isOnline = presenceMap.get(idStr) === true;
                const dotClass = isOnline ? 'online' : 'offline';

                chatItemsBox.insertAdjacentHTML('beforeend', `
                    <div class="chat-item"
                         data-instructor-id="${escapeHtml(idStr)}"
                         data-instructor-name="${escapeHtml(name)}">
                         <div class="avatar">
                            ${avatarHtml}
                            <span class="presence-dot ${dotClass}" data-presence-id="${escapeHtml(idStr)}"></span>
                        </div>
                        <div class="meta">
                            <div class="name">${escapeHtml(name)}</div>
                            <div class="preview">${escapeHtml(preview)}</div>
                        </div>
                        ${unreadHtml}
                    </div>
                `);
            }

            if (state.currentInstructorId) setActiveItem(state.currentInstructorId);
        }

        chatItemsBox.addEventListener('click', (e) => {
            const item = e.target.closest('.chat-item');
            if (!item) return;

            const instructorId = item.dataset.instructorId;
            const instructorName = item.dataset.instructorName;

            openChat(instructorId, instructorName);
        });

        chatSearch.addEventListener('input', () => {
            const q = (chatSearch.value ?? '').trim().toLowerCase();
            const filtered = !q
                ? state.conversationsCache
                : state.conversationsCache.filter(x => (x.instructorName ?? '').toLowerCase().includes(q));

            renderConversations(filtered);

            if (state.currentInstructorId) setActiveItem(state.currentInstructorId);
        });

        async function openChat(instructorId, instructorName) {
            state.currentInstructorId = instructorId;
            state.currentInstructorName = instructorName;

            setActiveItem(instructorId);
            showThreadScreen(instructorName);

            clearAttachmentUI();

            await loadChatHistoryFirstPage();

            await markAsRead(instructorId);
            scheduleMarkAsReadHub();

            removeBadge(instructorId);

            await loadMyConversations();

            messagesBox.scrollTop = messagesBox.scrollHeight;

            // ✅ Presence for header
            try {
                if (headerNameEl) headerNameEl.textContent = instructorName || "Chat";

                const cached = presenceMap.get(String(state.currentInstructorId));
                if (cached !== undefined) {
                    setHeaderStatus(cached);
                    return;
                }

                const isOnline = await studentConnection.invoke("IsUserOnline", state.currentInstructorId);
                presenceMap.set(String(state.currentInstructorId), !!isOnline);
                setHeaderStatus(!!isOnline);

            } catch (e) {
                console.error("IsUserOnline invoke error:", e);
            }
        }

        async function markAsRead(instructorId) {
            try {
                await fetch(API.markRead, {
                    method: 'POST',
                    headers: addCsrfHeader({ 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' }),
                    body: new URLSearchParams({ instructorId })
                });
            } catch (e) {
                console.error(e);
            }
        }

        // =========================
        // Chat History (Cursor paging)
        // =========================
        async function loadChatHistoryFirstPage() {
            messagesBox.innerHTML = '';

            state.hasMore = true;
            state.oldestId = null;
            state.isLoadingOlder = false;

            await loadOlderMessages();
        }

        async function loadOlderMessages() {
            if (!state.currentInstructorId) return;
            if (!state.hasMore || state.isLoadingOlder) return;

            state.isLoadingOlder = true;

            const prevScrollHeight = messagesBox.scrollHeight;
            const prevScrollTop = messagesBox.scrollTop;

            const url =
                `${API.history}?instructorId=${encodeURIComponent(state.currentInstructorId)}`
                + `&take=${state.take}`
                + (state.oldestId ? `&beforeId=${state.oldestId}` : ``);

            try {
                const res = await fetch(url);
                const data = await res.json();

                const list = data.messages ?? [];
                state.conversationId = data.conversationId ?? null;
                state.hasMore = data.hasMore === true;

                if (list.length === 0) {
                    state.isLoadingOlder = false;
                    return;
                }

                const frag = document.createDocumentFragment();
                for (const m of list) frag.appendChild(messageNode(m));
                messagesBox.prepend(frag);

                state.oldestId = list[0].id ?? list[0].Id;

                const newScrollHeight = messagesBox.scrollHeight;
                messagesBox.scrollTop = (newScrollHeight - prevScrollHeight) + prevScrollTop;

            } catch (e) {
                console.error(e);
            } finally {
                state.isLoadingOlder = false;
            }
        }

        messagesBox.addEventListener('scroll', () => {
            if (messagesBox.scrollTop <= 10) {
                loadOlderMessages();
            }

            if (messagesBox.scrollTop + messagesBox.clientHeight >= messagesBox.scrollHeight - 6) {
                scheduleMarkAsReadHub();
            }
        });

        // =========================
        // ✓✓ Ticks (Student)
        // =========================
        function ticksHtml(isMine, isRead) {
            if (!isMine) return '';
            const cls = isRead ? 'ticks read' : 'ticks';
            return `<span class="${cls}" title="${isRead ? 'Read' : 'Sent'}">✓✓</span>`;
        }

        // =========================
        // ✅ Attachment parsing (supports your old + new payload)
        // =========================
        function readAttachmentFromMessage(m) {
            const a = m.attachment ?? m.Attachment ?? null;

            const storedName = m.attachmentStoredName ?? m.AttachmentStoredName ?? a?.storedName ?? a?.StoredName ?? null;
            const originalName = m.attachmentOriginalName ?? m.AttachmentOriginalName ?? a?.name ?? a?.Name ?? null;
            const contentType = m.attachmentContentType ?? m.AttachmentContentType ?? a?.type ?? a?.Type ?? null;
            const size = m.attachmentSize ?? m.AttachmentSize ?? a?.size ?? a?.Size ?? null;

            // ✅ الجديد عندنا: AttachmentUrl يرجع جاهز
            const attachmentUrl = m.attachmentUrl ?? m.AttachmentUrl ?? null;

            // ✅ القديم: previewUrl (optimistic local only)
            const previewUrl = m.previewUrl ?? null;

            return { storedName, originalName, contentType, size, attachmentUrl, previewUrl };
        }

        // =========================
        // Render Message Node (Unified)
        // =========================
        function messageNode(m) {
            const id = (m.id ?? m.Id ?? '');
            const senderId = (m.senderId ?? m.SenderId ?? '');
            const receiverId = (m.receiverId ?? m.ReceiverId ?? '');
            const content = (m.content ?? m.Content ?? '');
            const sentAt = (m.sentAt ?? m.SentAt);
            const isRead = (m.isRead ?? m.IsRead) === true;
            const idStr = String(id || '');
            const alreadyRead = isRead || readCache.has(idStr);

            const isMine = currentUserId && senderId === currentUserId;

            const att = readAttachmentFromMessage(m);

            let attachmentHtml = '';
            // ✅ لو فيه AttachmentUrl من السيرفر (الأفضل)
            if (att.attachmentUrl) {
                if (isImageContentType(att.contentType)) {
                    attachmentHtml = `
                        <div class="att">
                            <img class="att-img js-preview-img"
                                 src="${escapeHtml(att.attachmentUrl)}"
                                 data-full-src="${escapeHtml(att.attachmentUrl)}"
                                 alt="${escapeHtml(att.originalName || 'image')}" />
                        </div>
                    `;
                } else {
                    attachmentHtml = `
                        <div class="att">
                            <a class="att-file" href="${escapeHtml(att.attachmentUrl)}" target="_blank" rel="noopener">
                                📎 ${escapeHtml(att.originalName || 'file')}
                            </a>
                        </div>
                    `;
                }
            }
            // ✅ fallback للـ optimistic previewUrl (local)
            else if (att.previewUrl && isImageContentType(att.contentType)) {
                attachmentHtml = `
                    <div class="att">
                        <img class="att-img js-preview-img"
                             src="${escapeHtml(att.previewUrl)}"
                             data-full-src="${escapeHtml(att.previewUrl)}"
                             alt="${escapeHtml(att.originalName || 'image')}" />
                    </div>
                `;
            }
            // ✅ fallback للـ download endpoint القديم (لو عندك history بيرجع storedName فقط)
            else if (id && (att.storedName || att.originalName)) {
                const downloadHref = buildDownloadUrl(id);
                if (isImageContentType(att.contentType)) {
                    attachmentHtml = `
                        <div class="att">
                            <img class="att-img js-preview-img"
                                 src="${escapeHtml(downloadHref)}"
                                 data-full-src="${escapeHtml(downloadHref)}"
                                 alt="${escapeHtml(att.originalName || 'image')}" />
                        </div>
                    `;
                } else {
                    attachmentHtml = `
                        <div class="att">
                            <a class="att-file" href="${escapeHtml(downloadHref)}" target="_blank" rel="noopener">
                                📎 ${escapeHtml(att.originalName || 'file')}
                            </a>
                        </div>
                    `;
                }
            }

            const wrapper = document.createElement('div');
            wrapper.className = `msg-row ${isMine ? 'mine' : ''}`;
            wrapper.dataset.messageId = String(id || '');

            const textHtml = content ? `<div class="att-text">${escapeHtml(content)}</div>` : '';

            wrapper.innerHTML = `
                <div class="bubble">
                    ${textHtml}
                    ${attachmentHtml}
                    <span class="time">
                        ${escapeHtml(toTime(sentAt))}
                       ${ticksHtml(isMine, alreadyRead)}

                    </span>
                </div>
            `;

            return wrapper;
        }

        function renderMessage(m) {
            const id = (m.id ?? m.Id ?? null);
            if (id) {
                // ✅ منع التكرار: لو الرسالة موجودة بالفعل (مثلاً optimistic اتحول ل real)
                const existing = messagesBox.querySelector(`.msg-row[data-message-id="${CSS.escape(String(id))}"]`);
                if (existing) return existing;
            }

            const node = messageNode(m);
            messagesBox.appendChild(node);
            return node;
        }


        function markMessagesReadInUI(messageIds) {
            if (!Array.isArray(messageIds) || messageIds.length === 0) return;

            messageIds.forEach(id => {
                readCache.add(String(id)); // 👈 خزنها

                const row = messagesBox.querySelector(
                    `.msg-row[data-message-id="${CSS.escape(String(id))}"]`
                );
                const tick = row?.querySelector('.ticks');
                if (tick) {
                    tick.classList.add("read");
                    tick.title = "Read";
                }
            });
        }

        // =========================
        // ✅ click on image to preview
        // =========================
        messagesBox.addEventListener('click', (e) => {
            const img = e.target.closest('img.js-preview-img');
            if (!img) return;
            const src = img.getAttribute('data-full-src') || img.src;
            openImagePreview(src);
        });

        // =========================
        // ✅ Optimistic patch helper (keep your old one but improved)
        // =========================
        function patchOptimisticToReal(optimisticRowEl, payload) {
            if (!optimisticRowEl || !payload) return;

            const realId = payload.id ?? payload.Id;
            if (!realId) return;

            // update id
            optimisticRowEl.dataset.messageId = String(realId);

            // replace attachment from previewUrl to attachmentUrl if exists
            const attUrl = payload.attachmentUrl ?? payload.AttachmentUrl ?? null;
            const ct = payload.attachmentContentType ?? payload.AttachmentContentType ?? '';

            if (!attUrl) return;

            const img = optimisticRowEl.querySelector('img.att-img');
            const a = optimisticRowEl.querySelector('a.att-file');

            if (isImageContentType(ct)) {
                if (img) {
                    img.src = attUrl;
                    img.setAttribute('data-full-src', attUrl);
                }
            } else {
                if (a) a.href = attUrl;
            }
        }

        // =========================
        // Send Message (Student) ✅ (Text OR File)
        // =========================
        async function sendMessageFromUI() {
            const text = (chatInput.value || '').trim();
            const file = getSelectedFile();

            if (!state.currentInstructorId) return;
            if (!text && !file) return;

            const nowIso = new Date().toISOString();
            const tempId = `tmp-${Date.now()}`;

            let previewUrl = null;
            let fileType = null;
            let fileName = null;

            if (file) {
                fileType = file.type || '';
                fileName = file.name || 'file';
                if (isImageContentType(fileType)) {
                    previewUrl = URL.createObjectURL(file);
                }
            }

            // ✅ optimistic render
            const optimisticNode = renderMessage({
                id: tempId,
                senderId: currentUserId,
                receiverId: state.currentInstructorId,
                content: text,
                sentAt: nowIso,
                isRead: false,
                attachment: file ? { name: fileName, type: fileType, size: file.size } : null,
                previewUrl: previewUrl
            });

            messagesBox.scrollTop = messagesBox.scrollHeight;
            chatInput.value = '';
            clearAttachmentUI();

            // preview in list
            const item = findItem(state.currentInstructorId);
            if (item) {
                const previewEl = item.querySelector('.preview');
                if (previewEl) previewEl.textContent = text || (file ? `📎 ${fileName}` : '');
            }

            try {
                // ✅ File (with/without text)
                if (file) {
                    const fd = new FormData();
                    fd.append("ReceiverId", state.currentInstructorId);
                    fd.append("Content", text);
                    fd.append("File", file);

                    const res = await fetch(API.saveWithFile, {
                        method: 'POST',
                        headers: addCsrfHeader({}), // token
                        body: fd
                    });

                    if (!res.ok) {
                        const errText = await res.text();
                        console.error("SendMessageWithFile failed:", errText);
                        return;
                    }

                    const payload = await res.json();

                    // ✅ patch optimistic to real (id + attachmentUrl)
                    patchOptimisticToReal(optimisticNode, payload);

                    // ✅ free local preview url
                    if (previewUrl) URL.revokeObjectURL(previewUrl);

                    // IMPORTANT:
                    // - لا تبعت SendMessage hub هنا
                    // - السيرفر بالفعل بيعمل SignalR broadcast (للـ receiver + للـ sender)
                    // - وإحنا بنمنع التكرار بالـ messageId

                    return;
                }

             
                const res = await fetch(API.save, {
                    method: 'POST',
                    headers: addCsrfHeader({ 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' }),
                    body: new URLSearchParams({ receiverId: state.currentInstructorId, content: text })
                });

                const data = await res.json();
                if (!data || data.success !== true) {
                    console.log('SaveMessage failed:', data);
                    return;
                }

                console.log("[SaveMessage response]", data);

                const realId =
                    data.id ??
                    data.Id ??
                    data.messageId ??
                    data.savedMessageId ??
                    data.data?.id ??
                    data.data?.Id ??
                    data.message?.id ??     
                    data.message?.Id;       

                if (realId && optimisticNode) {
                    optimisticNode.dataset.messageId = String(realId);
                }

                // القديم: لسه بتبعت realtime نص فقط
                await sendRealtimeToInstructor(state.currentInstructorId, text);

            } catch (e) {
                console.error(e);
            }
        }

        sendBtn.addEventListener('click', sendMessageFromUI);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessageFromUI();
        });

        // =========================
        // Open/Close/Back
        // =========================
        chatFab.addEventListener('click', () => { initAudio(); showWidget(); });
        chatCloseBtn.addEventListener('click', hideWidget);
        chatBackBtn.addEventListener('click', showListScreen);

        // =========================
        // SignalR (Student)
        // =========================
        const studentConnection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub", {
                transport: signalR.HttpTransportType.LongPolling,
                skipNegotiation: false
            })
            .withAutomaticReconnect()
            .build();

        studentConnection.on("PresenceChanged", function (userId, isOnline) {
            const id = String(userId);
            presenceMap.set(id, !!isOnline);

            if (state.currentInstructorId && String(state.currentInstructorId) === id) {
                setHeaderStatus(!!isOnline);
            }

            const dot = document.querySelector(`.presence-dot[data-presence-id="${CSS.escape(id)}"]`);
            if (dot) {
                dot.classList.toggle("online", !!isOnline);
                dot.classList.toggle("offline", !isOnline);
            }
        });

        studentConnection.onreconnected(async () => {
            if (!state.currentInstructorId) return;
            try {
                const isOnline = await studentConnection.invoke("IsUserOnline", state.currentInstructorId);
                presenceMap.set(String(state.currentInstructorId), !!isOnline);
                setHeaderStatus(!!isOnline);
            } catch (e) {
                console.error("Reconnected IsUserOnline error:", e);
            }
        });

        studentConnection.start()
            .then(() => console.log("SignalR Connected (Student)!"))
            .catch(err => console.error(err.toString()));

        let readDebounceTimer = null;
        function scheduleMarkAsReadHub() {
            clearTimeout(readDebounceTimer);
            readDebounceTimer = setTimeout(() => {
                if (!state.isOpen) return;
                if (!state.conversationId) return;
                if (!state.currentInstructorId) return;

                studentConnection.invoke("MarkAsRead", state.conversationId, state.currentInstructorId)
                    .catch(err => console.error("MarkAsRead invoke error:", err));
            }, 200);
        }

        // ✅ ReceiveMessage: supports BOTH
        // 1) new payload object (server sends payload)
        // 2) old signature (senderId, message, timestamp)
        studentConnection.on("ReceiveMessage", async function (arg1, arg2, arg3) {

            // NEW payload object
            if (arg1 && typeof arg1 === 'object') {
                const p = arg1;

                const senderId = String(p.senderId ?? p.SenderId ?? '');
                const receiverId = String(p.receiverId ?? p.ReceiverId ?? '');
                const messageId = (p.id ?? p.Id ?? null);

                const sameOpenChat =
                    state.isOpen
                    && state.currentInstructorId
                    && (
                        // الرسالة جاية من المدرس للطالب
                        senderId === String(state.currentInstructorId)
                        // أو echo للطالب نفسه
                        || senderId === String(currentUserId)
                    );

                if (sameOpenChat) {
                    // منع التكرار لو موجودة
                    if (messageId) {
                        const exists = messagesBox.querySelector(`.msg-row[data-message-id="${CSS.escape(String(messageId))}"]`);
                        if (exists) return;
                    }

                    renderMessage(p);
                    messagesBox.scrollTop = messagesBox.scrollHeight;

                    scheduleMarkAsReadHub();

                    // لو جاية من المدرس (مش echo من الطالب)
                    if (senderId === String(state.currentInstructorId)) {
                        await markAsRead(senderId);
                        removeBadge(senderId);
                    }

                    await loadMyConversations();
                    return;
                }

                // لو مش فاتح نفس الشات: update preview + badge
                const otherId = senderId === String(currentUserId) ? receiverId : senderId;

                const item = findItem(otherId);
                if (item) {
                    const previewEl = item.querySelector('.preview');
                    const previewText = (p.content ?? p.Content ?? '').trim()
                        || (p.attachmentOriginalName ?? p.AttachmentOriginalName ? `📎 ${(p.attachmentOriginalName ?? p.AttachmentOriginalName)}` : '');

                    if (previewEl) previewEl.textContent = previewText;

                    // لو الرسالة جاية لينا من الطرف التاني زوّد badge
                    if (senderId !== String(currentUserId)) {
                        incrementBadge(otherId);
                        syncFabUnreadFromList();
                    }

                    await loadMyConversations();
                } else {
                    await loadMyConversations();
                }

                return;
            }

            // OLD signature
            const senderId = arg1;
            const message = arg2;
            const timestamp = arg3;

            const sameOpenChat = state.isOpen && state.currentInstructorId && senderId === state.currentInstructorId;

            if (sameOpenChat) {
                renderMessage({ senderId, receiverId: currentUserId, content: message, sentAt: timestamp });
                messagesBox.scrollTop = messagesBox.scrollHeight;
                scheduleMarkAsReadHub();

                await markAsRead(senderId);
                removeBadge(senderId);

                await loadMyConversations();
                return;
            }

            const item = findItem(senderId);
            if (item) {
                const previewEl = item.querySelector('.preview');
                if (previewEl) previewEl.textContent = message;

                incrementBadge(senderId);

                syncFabUnreadFromList();
                await loadMyConversations();

            } else {
                await loadMyConversations();
            }
        });

        studentConnection.on("MessagesRead", function (payload) {
            console.log("[MessagesRead] payload:", payload, {
                isOpen: state.isOpen,
                conversationId: state.conversationId,
                currentInstructorId: state.currentInstructorId
            });

            if (!payload) return;
            if (!state.isOpen) return;
            if (!state.conversationId) return;
            if (String(payload.conversationId) !== String(state.conversationId)) return;

            markMessagesReadInUI(payload.messageIds);
        });

        studentConnection.on("UpdateConversationList", function () {
            loadMyConversations();
        });

        async function sendRealtimeToInstructor(instructorId, message) {
            try {
                await studentConnection.invoke("SendMessage", instructorId, message);
            } catch (e) {
                console.error(e.toString());
            }
        }
    </script>

    <script>
            (function () {
                // NextJoinAt from server (ISO string) - may be null
                const nextJoinAtStr = '@(Model.NextJoinAt.HasValue ? Model.NextJoinAt.Value.ToString("O") : "")';
                const nextId = '@(Model.NextStudentAppointmentId?.ToString() ?? "")';

                if (!nextJoinAtStr || !nextId) return; // مفيش ميعاد جاي معروف

                const nextJoinAt = new Date(nextJoinAtStr).getTime();
                const container = document.getElementById("joinActions");

                if (!container) return;

                function switchToJoinNow() {
                    // لو اتبدّل قبل كده، متعملش حاجة
                    if (document.getElementById("joinNowBtn")) return;

                    container.insertAdjacentHTML("afterbegin", `
                        <a class="sd-btn sd-btn-primary" id="joinNowBtn"
                           href="/Student/Lectures/Join?studentAppointmentId=${nextId}">
                           <i class="fa-solid fa-play"></i> Join now
                        </a>
                    `);

                    const notBtn = document.getElementById("notAvailableBtn");
                    if (notBtn) notBtn.remove();
                }

                function tick() {
                    const now = Date.now();
                    if (now >= nextJoinAt) {
                        switchToJoinNow();
                        clearInterval(timer);
                    }
                }

                // check immediately + every 10 seconds
                tick();
                const timer = setInterval(tick, 10000);
            })();
    </script>
    <script>
        function toggleLastLesson(btn) {
            const row = btn.closest('.sd-last-row');
            const details = row.querySelector('.sd-last-details');

            // اقفل أي واحد مفتوح
            document.querySelectorAll('.sd-last-row').forEach(r => {
                if (r !== row) {
                    r.classList.remove('active');
                    const d = r.querySelector('.sd-last-details');
                    if (d) d.style.maxHeight = null;
                }
            });

            // افتح/اقفل الحالي
            row.classList.toggle('active');

            if (row.classList.contains('active')) {
                details.style.maxHeight = details.scrollHeight + "px";
            } else {
                details.style.maxHeight = null;
            }
        }

    </script>


}





@section Styles {
    <link rel="stylesheet" href="~/css/ChatMessage.css" asp-append-version="true" />

}


