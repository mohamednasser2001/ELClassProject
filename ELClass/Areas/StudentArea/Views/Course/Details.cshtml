@model Models.Course
@{
    Layout = "_StudentLayout";
    int? openLessonId = ViewBag.OpenLessonId as int?;

    // =========================
    // Language (Session-based)
    // =========================
    var currentLang = Context.Session.GetString("Language") ?? "en";
    var isArabic = currentLang == "ar";
}

<div class="content-wrapper course-details-page">
    <div class="header-section">
        <h2 class="course-title">@(!string.IsNullOrWhiteSpace(Model.TitleEn) ? Model.TitleEn : Model.TitleAr)</h2>
        <p class="course-subtitle">@(isArabic ? "محاضرات ومواد تعلم الكورس" : "Lectures and course learning materials")</p>
    </div>

    <div class="lectures-container">
        @if (Model.Lessons != null && Model.Lessons.Any())
        {
            int count = 1;
            foreach (var lesson in Model.Lessons)
            {
                <div class="lecture-item" data-lesson-id="@lesson.Id">
                    <div class="lecture-header" onclick="toggleLecture(this)">
                        <div class="lecture-title">
                            <span class="lecture-number">@count</span>
                            <h3 class="lecture-name">
                                @(isArabic ? "محاضرة" : "Lecture") @count: @lesson.Title
                            </h3>
                        </div>

                        <!-- ✅ Arrow فقط Toggle (مش لينك) -->
                        <i class="fas fa-chevron-down arrow-icon" title="@(isArabic ? "توسيع" : "Expand")"></i>
                    </div>

                    <div class="lecture-content">
                        <div class="content-links">
                            @if (!string.IsNullOrEmpty(lesson.DriveLink))
                            {
                                <a href="@lesson.DriveLink"
                                   target="_blank"
                                   rel="noopener"
                                   class="content-link video">
                                    <i class="fas fa-video"></i>
                                    @(isArabic ? "مشاهدة المحاضرة" : "Watch lecture")
                                </a>
                            }

                            @if (!string.IsNullOrEmpty(lesson.LecturePdfUrl))
                            {
                                <a href="@lesson.LecturePdfUrl"
                                   target="_blank"
                                   rel="noopener"
                                   class="content-link pdf">
                                    <i class="fas fa-file-pdf"></i>
                                    @(isArabic ? "ملف المحاضرة PDF" : "Lecture PDF")
                                </a>
                            }

                            @if (!string.IsNullOrEmpty(lesson.AssignmentPdfUrl))
                            {
                                <a href="@lesson.AssignmentPdfUrl"
                                   target="_blank"
                                   rel="noopener"
                                   class="content-link assignment">
                                    <i class="fas fa-tasks"></i>
                                    @(isArabic ? "الواجب" : "Assignment")
                                </a>
                            }
                        </div>
                    </div>
                </div>
                count++;
            }
        }
        else
        {
            <p class="text-muted">
                @(isArabic ? "لم يتم إضافة أي محاضرات لهذا الكورس بعد." : "No lectures have been added to this course yet.")
            </p>
        }
    </div>
</div>

<script>
    function closeLecture(item) {
        item.classList.remove('active');
        const content = item.querySelector('.lecture-content');
        if (content) content.style.maxHeight = null;
    }

    function openLecture(item) {
        item.classList.add('active');
        const content = item.querySelector('.lecture-content');
        if (content) content.style.maxHeight = content.scrollHeight + "px";
    }

    function toggleLecture(header) {
        const item = header.closest('.lecture-item');

        // اقفل أي محاضرة تانية (اختياري)
        document.querySelectorAll('.lecture-item').forEach(el => {
            if (el !== item) closeLecture(el);
        });

        // Toggle الحالية
        if (item.classList.contains('active')) {
            closeLecture(item);
        } else {
            openLecture(item);
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        // ابدأ كله مقفول
        document.querySelectorAll('.lecture-item').forEach(el => closeLecture(el));

        // ✅ افتح lecture معينة لو جاية من dashboard عبر openLessonId
        const openId = @((openLessonId.HasValue) ? openLessonId.Value.ToString() : "null");
        if (openId !== null) {
            const target = document.querySelector(`.lecture-item[data-lesson-id="${openId}"]`);
            if (target) {
                // افتحها
                openLecture(target);

                // scroll لطيف عليها
                setTimeout(() => {
                    target.scrollIntoView({ behavior: "smooth", block: "center" });
                }, 50);
            }
        }
    });
</script>
